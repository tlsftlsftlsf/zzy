# 积分系统云服务器同步功能使用指南

## 🎉 功能概述

您的积分系统现已添加完整的云服务器同步功能，支持多设备数据同步、自动备份和历史版本恢复！

### ✨ 主要特性

- **☁️ 云端同步**: 数据上传到您的云服务器，完全自主控制
- **📱 多设备同步**: 任何设备都能访问相同数据
- **💾 自动备份**: 每次上传自动创建历史备份
- **🔄 版本恢复**: 可恢复任意历史版本
- **⚙️ 灵活配置**: 支持API密钥和自动同步设置
- **🔒 安全可靠**: 数据存储在您的服务器上

## 🚀 快速部署指南（20分钟完成）

### 步骤1: 部署云服务器（10分钟）

#### 方式一: 使用自动部署脚本（推荐）

```bash
# 1. 上传部署文件到您的云服务器
scp cloud_server.py deploy_cloud_server.sh user@your-server.com:/tmp/

# 2. 登录服务器并执行部署
ssh user@your-server.com
cd /tmp
chmod +x deploy_cloud_server.sh
sudo ./deploy_cloud_server.sh

# 3. 启动服务
points-sync start
```

#### 方式二: 手动部署

```bash
# 1. 安装依赖
pip install flask flask-cors

# 2. 运行服务器
python cloud_server.py
```

### 步骤2: 配置前端（5分钟）

1. 打开 `index.html` 文件
2. 在设置面板中点击"☁️ 云端同步"按钮
3. 配置服务器地址：`http://your-server-domain.com:5000`
4. 设置API密钥（可选，默认密钥：`your-secret-api-key-here`）
5. 点击"💾 保存设置"

### 步骤3: 测试功能（5分钟）

1. **上传测试**: 点击"⬆️ 上传到云端"
2. **下载测试**: 在另一台设备上点击"⬇️ 从云端下载"
3. **备份测试**: 点击"📋 备份历史"查看历史版本

## 📖 详细功能说明

### 🔧 云同步面板

#### 连接配置
- **服务器地址**: 您的云服务器URL（如：`https://your-domain.com:5000`）
- **API密钥**: 可选的验证密钥，提高安全性
- **连接状态**: 实时显示服务器连接状态

#### 数据同步功能
- **⬆️ 上传到云端**: 将当前本地数据上传到云服务器
- **⬇️ 从云端下载**: 下载云端最新数据到本地（会覆盖当前数据）
- **📋 备份历史**: 查看和管理历史备份版本
- **💾 保存设置**: 保存当前配置到本地存储

#### 自动同步设置
- **启用自动同步**: 开启后系统将定期自动上传数据
- **同步频率**: 可选择5分钟、15分钟、30分钟或1小时

### 🔄 数据同步流程

#### 上传流程
1. 用户点击"上传到云端"
2. 系统将当前 `pointsData` 对象发送到云服务器
3. 云服务器自动备份当前数据（带时间戳）
4. 保存新的数据到主文件
5. 返回成功确认

#### 下载流程
1. 用户点击"从云端下载"
2. 系统从云服务器获取最新数据
3. 验证数据格式完整性
4. 备份当前本地数据
5. 更新本地数据并刷新界面

#### 备份恢复流程
1. 用户查看备份历史列表
2. 选择要恢复的备份版本
3. 确认恢复操作
4. 下载选中的备份数据
5. 更新本地数据（与下载流程相同）

### 🎛️ 管理员快捷功能

在家长控制面板中新增了云同步快捷按钮：

- **⬆️ 快速上传云端**: 直接上传当前数据
- **⬇️ 快速下载**: 直接下载云端数据
- **☁️ 云端同步面板**: 打开完整的云同步设置面板

### 🛡️ 安全特性

#### API密钥验证（可选）
- 服务器端支持API密钥验证
- 前端通过 `Authorization: Bearer <key>` 头传递
- 可在 `cloud_server.py` 中配置多个密钥

#### 数据备份机制
- 每次上传前自动创建时间戳备份
- 备份文件名格式：`points-data_YYYYMMDD_HHMMSS_随机8位.json`
- 支持查看和恢复任意历史备份

## 🔧 服务器配置详解

### 环境变量配置

在 `cloud_server.py` 中可以配置：

```python
# API密钥配置
API_KEYS = {
    'default': 'your-secret-api-key-here',  # 默认密钥
    'user1': 'key-for-user1',               # 用户专用密钥
    # 添加更多密钥...
}

# 文件路径配置
DATA_FILE = '/var/www/points-data.json'      # 主数据文件
BACKUP_DIR = '/var/www/backups/'             # 备份目录
```

### 生产环境建议

1. **修改默认API密钥**
   ```python
   API_KEYS = {
       'production': 'your-very-secure-key-12345'
   }
   ```

2. **使用HTTPS**
   - 配置SSL证书
   - 将服务器地址改为 `https://your-domain.com`

3. **配置防火墙**
   ```bash
   # Ubuntu/Debian
   sudo ufw allow 5000
   
   # CentOS/RHEL
   sudo firewall-cmd --add-port=5000/tcp --permanent
   sudo firewall-cmd --reload
   ```

4. **设置定期清理备份**
   ```bash
   # 每天删除30天前的备份
   0 2 * * * find /var/www/backups/ -name "*.json" -mtime +30 -delete
   ```

## 🐛 常见问题解决

### 连接问题

**问题**: 显示"连接失败"
**解决**: 
1. 检查服务器是否运行：`points-sync status`
2. 确认服务器地址和端口正确
3. 检查防火墙设置
4. 验证API密钥（如果设置了）

### 数据同步问题

**问题**: 上传/下载失败
**解决**:
1. 检查网络连接
2. 确认数据格式正确
3. 查看服务器日志：`points-sync logs`
4. 验证磁盘空间是否充足

### 权限问题

**问题**: 备份文件无法创建
**解决**:
```bash
# 设置正确的文件权限
sudo chown -R www-data:www-data /var/www/points-sync
sudo chmod -R 755 /var/www/points-sync
```

## 📱 多设备使用示例

### 设备A（手机）- 日常使用
1. 配置云同步地址
2. 每天使用积分系统获得/消费积分
3. 系统自动同步或手动点击"上传到云端"

### 设备B（平板）- 查看统计
1. 配置相同的云同步地址
2. 点击"从云端下载"获取最新数据
3. 查看历史记录、成就系统等

### 设备C（电脑）- 家长管理
1. 配置云同步地址
2. 通过管理员面板快速同步
3. 查看备份历史，恢复到任意历史版本

## 🎯 最佳实践建议

1. **定期备份**: 即使有云同步，也建议定期导出本地备份
2. **网络检查**: 在重要操作前先检查云端连接状态
3. **版本管理**: 重要变更前先查看备份历史
4. **密钥安全**: 生产环境务必修改默认API密钥
5. **监控日志**: 定期查看服务器日志了解运行状态

## 📞 技术支持

如遇到问题，可以：

1. 查看服务器日志：`points-sync logs`
2. 检查浏览器控制台错误信息
3. 验证网络连接和防火墙设置
4. 确认服务器资源（CPU、内存、磁盘）充足

---

## 🎊 恭喜！

您的积分系统现已具备完整的云服务器同步功能！

- ✅ **多设备同步**: 任何设备都能访问相同数据
- ✅ **自动备份**: 每次操作都有历史记录
- ✅ **安全可靠**: 数据完全存储在您的服务器
- ✅ **简单部署**: 20分钟即可完成所有配置

享受您的多设备积分管理系统吧！🌟