<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>积分系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* 默认主题变量 - 优雅紫罗兰渐变 */
            --primary-gradient: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 50%, #06b6d4 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --info-gradient: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            --theme-accent: #8b5cf6;
            --theme-text: #1f2937;
            --theme-bg: rgba(255, 255, 255, 0.96);
            --card-shadow: 0 8px 25px rgba(139, 92, 246, 0.15);
            --card-shadow-hover: 0 15px 35px rgba(139, 92, 246, 0.25);
            --border-radius: 18px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 彩虹主题 - 梦幻彩虹渐变 */
        [data-theme="rainbow"] {
            --primary-gradient: linear-gradient(135deg, #ff006e 0%, #ffbe0b 25%, #8338ec 50%, #3a86ff 75%, #06ffa5 100%);
            --success-gradient: linear-gradient(135deg, #06ffa5 0%, #00d4aa 100%);
            --danger-gradient: linear-gradient(135deg, #ff006e 0%, #ff595e 100%);
            --warning-gradient: linear-gradient(135deg, #ffbe0b 0%, #ffca3a 100%);
            --info-gradient: linear-gradient(135deg, #8338ec 0%, #a855f7 100%);
            --theme-accent: #ff006e;
            --theme-text: #374151;
            --theme-bg: rgba(255, 255, 255, 0.97);
            --card-shadow: 0 8px 25px rgba(255, 0, 110, 0.15);
            --card-shadow-hover: 0 15px 35px rgba(255, 0, 110, 0.25);
        }

        /* 森林主题 - 深度森林绿 */
        [data-theme="forest"] {
            --primary-gradient: linear-gradient(135deg, #0d5016 0%, #22c55e 50%, #84cc16 100%);
            --success-gradient: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            --danger-gradient: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            --warning-gradient: linear-gradient(135deg, #ca8a04 0%, #eab308 100%);
            --info-gradient: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
            --theme-accent: #22c55e;
            --theme-text: #1a2e1a;
            --theme-bg: rgba(255, 255, 255, 0.98);
            --card-shadow: 0 8px 25px rgba(34, 197, 94, 0.15);
            --card-shadow-hover: 0 15px 35px rgba(34, 197, 94, 0.25);
        }

        /* 日落主题 - 温暖夕阳渐变 */
        [data-theme="sunset"] {
            --primary-gradient: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #ffcd3c 100%);
            --success-gradient: linear-gradient(135deg, #22c55e 0%, #4ade80 100%);
            --danger-gradient: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --info-gradient: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
            --theme-accent: #ff6b35;
            --theme-text: #451a03;
            --theme-bg: rgba(255, 251, 235, 0.96);
            --card-shadow: 0 8px 25px rgba(255, 107, 53, 0.15);
            --card-shadow-hover: 0 15px 35px rgba(255, 107, 53, 0.25);
        }

        /* 海洋主题 - 深蓝海洋渐变 */
        [data-theme="ocean"] {
            --primary-gradient: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --info-gradient: linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%);
            --theme-accent: #0ea5e9;
            --theme-text: #0c4a6e;
            --theme-bg: rgba(240, 249, 255, 0.97);
            --card-shadow: 0 8px 25px rgba(14, 165, 233, 0.15);
            --card-shadow-hover: 0 15px 35px rgba(14, 165, 233, 0.25);
        }

        /* 圣诞主题 - 经典圣诞红绿 */
        [data-theme="christmas"] {
            --primary-gradient: linear-gradient(135deg, #dc2626 0%, #16a34a 50%, #dc2626 100%);
            --success-gradient: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            --danger-gradient: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            --warning-gradient: linear-gradient(135deg, #ca8a04 0%, #eab308 100%);
            --info-gradient: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            --theme-accent: #dc2626;
            --theme-text: #1f2937;
            --theme-bg: rgba(255, 251, 251, 0.98);
            --card-shadow: 0 8px 25px rgba(220, 38, 38, 0.15);
            --card-shadow-hover: 0 15px 35px rgba(220, 38, 38, 0.25);
        }

        /* 新年主题 - 喜庆金色庆祝 */
        [data-theme="newyear"] {
            --primary-gradient: linear-gradient(135deg, #ca8a04 0%, #fbbf24 25%, #f59e0b 50%, #ef4444 75%, #dc2626 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --danger-gradient: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            --warning-gradient: linear-gradient(135deg, #ca8a04 0%, #eab308 100%);
            --info-gradient: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            --theme-accent: #ca8a04;
            --theme-text: #451a03;
            --theme-bg: rgba(255, 251, 235, 0.96);
            --card-shadow: 0 8px 25px rgba(202, 138, 4, 0.15);
            --card-shadow-hover: 0 15px 35px rgba(202, 138, 4, 0.25);
        }

        body {
            font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            padding: 20px;
            color: var(--theme-text);
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--theme-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px);
            overflow: hidden;
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 头部和积分显示区域容器 */
        .header-dashboard-container {
            display: flex;
            gap: 20px; /* 增加间距 */
            background: var(--primary-gradient);
            position: relative;
            overflow: hidden;
            align-items: stretch; /* 拉伸项目以填充容器 */
            padding: 10px; /* 增加内边距 */
        }

        /* 左侧积分显示模块 */
        .left-points-section {
            flex: 1; /* 改为flex: 1，使其更具弹性 */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px 20px;
            position: relative;
        }

        /* 右侧头部区域模块 */
        .right-header-section {
            flex: 1.5; /* 调整比例，让右侧更宽 */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            position: relative;
        }

        /* 统一的头部样式 */
        .header {
            color: white;
            text-align: center;
            position: relative;
            z-index: 1;
            max-width: 100%;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
            z-index: 0;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 12px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
            animation: glow 2s ease-in-out infinite alternate;
        }

        .child-name {
            font-size: 1em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            margin-bottom: 15px;
        }

        /* 每日一言样式 */
        .daily-quote {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
            transition: var(--transition);
            max-width: 500px;
            margin: 0 auto;
        }

        .daily-quote:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        .quote-loading {
            color: rgba(255, 255, 255, 0.9);
            font-style: italic;
            text-align: center;
            font-size: 1em;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .quote-content {
            text-align: center;
            animation: fadeInUp 0.8s ease-out;
        }

        .quote-error {
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            font-style: italic;
            font-size: 0.95em;
        }

        .quote-text {
            font-size: 1em;
            font-style: italic;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 8px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        .quote-text::before {
            content: '"';
            font-size: 2em;
            position: absolute;
            left: -15px;
            top: -5px;
            color: rgba(255, 255, 255, 0.6);
        }

        .quote-text::after {
            content: '"';
            font-size: 2em;
            position: absolute;
            right: -15px;
            bottom: -15px;
            color: rgba(255, 255, 255, 0.6);
        }

        .quote-author {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .quote-author::before {
            content: '— ';
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.7;
            }
            50% {
                opacity: 1;
            }
        }

        /* 积分显示区域优化 */
        .points-display {
            text-align: center;
            padding: 25px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: var(--border-radius);
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: var(--transition);
            width: 100%;
            max-width: 300px;
        }

        .points-display:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .points-display::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
            z-index: 0;
        }

        .points-label {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .current-points {
            font-size: 2.8em;
            font-weight: 900;
            margin: 10px 0;
            text-shadow: 3px 3px 10px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
            animation: pulse-scale 2s ease-in-out infinite;
            transition: color 0.3s ease;
        }

        .points-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            position: relative;
            z-index: 1;
        }

        .stat-item {
            text-align: center;
            padding: 6px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            backdrop-filter: blur(5px);
            flex: 1;
            margin: 0 2px;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
            margin-bottom: 3px;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.75em;
        }

        /* 可滚动内容区域 */
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .main-content {
            padding: 40px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .control-group {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            transition: var(--transition);
        }

        .control-group::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--primary-gradient);
            border-radius: var(--border-radius);
            z-index: -1;
            opacity: 0;
            transition: var(--transition);
        }

        .control-group:hover::before {
            opacity: 1;
        }

        .control-group:hover {
            transform: translateY(-3px);
        }

        .control-group h3 {
            margin-bottom: 25px;
            color: var(--theme-text);
            text-align: center;
            font-size: 1.4em;
            position: relative;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #6c757d;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            font-size: 16px;
            transition: var(--transition);
            background: rgba(255,255,255,0.9);
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--theme-accent);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* 积分建议提示样式 */
        .input-group {
            position: relative;
        }
        
        .points-suggestion-tip {
            position: absolute;
            top: -30px;
            right: 0;
            background: var(--info-gradient);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            white-space: nowrap;
            pointer-events: none;
        }
        
        .points-suggestion-tip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 10px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid var(--info-gradient);
        }

        /* 积分单位预览样式 */
        #currencyPreview {
            transition: var(--transition);
            border: 2px solid transparent;
        }

        #currencyPreview:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        #previewIcon {
            transition: var(--transition);
            display: inline-block;
            animation: bounce-in 0.6s ease-out;
        }

        @keyframes currency-glow {
            0% { text-shadow: 0 0 5px var(--theme-accent); }
            50% { text-shadow: 0 0 20px var(--theme-accent), 0 0 30px var(--theme-accent); }
            100% { text-shadow: 0 0 5px var(--theme-accent); }
        }

        .currency-selected {
            animation: currency-glow 1s ease-in-out;
        }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-3px);
        }

        .btn-add {
            background: var(--success-gradient);
            color: white;
        }

        .btn-add:hover {
            box-shadow: 0 10px 25px rgba(17, 153, 142, 0.4);
        }

        .btn-subtract {
            background: var(--danger-gradient);
            color: white;
        }

        .btn-subtract:hover {
            box-shadow: 0 10px 25px rgba(252, 70, 107, 0.4);
        }

        /* 用户选择器优化 */
        .user-selector {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .user-btn {
            background: var(--theme-bg);
            color: var(--theme-text);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            backdrop-filter: blur(10px);
            font-size: 14px;
        }

        .user-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--card-shadow-hover);
            border-color: var(--theme-accent);
        }

        .user-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .user-dropdown {
            position: fixed;
            top: 70px;
            left: 20px;
            background: var(--theme-bg);
            border-radius: 16px;
            box-shadow: var(--card-shadow-hover);
            padding: 20px;
            min-width: 250px;
            max-width: 90vw;
            display: none;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-dropdown.show {
            display: block;
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 8px;
        }

        .user-option:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .user-option.active {
            background: var(--success-gradient);
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: var(--primary-gradient);
            color: white;
            font-weight: bold;
        }

        .user-name {
            font-weight: 600;
            color: var(--theme-text);
        }

        .user-option.active .user-name {
            color: white;
        }

        .user-points {
            font-size: 0.85em;
            opacity: 0.8;
            font-weight: 500;
        }

        .user-actions {
            display: flex;
            gap: 5px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-action-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-add-user {
            background: var(--success-gradient);
            color: white;
        }

        .btn-manage-users {
            background: var(--info-gradient);
            color: white;
        }

        .user-action-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        /* 主题选择器优化 */
        .theme-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .theme-btn {
            background: var(--theme-bg);
            color: var(--theme-text);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            backdrop-filter: blur(10px);
            font-size: 14px;
        }

        .theme-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--card-shadow-hover);
            border-color: var(--theme-accent);
        }

        .theme-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .theme-dropdown {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--theme-bg);
            border-radius: 16px;
            box-shadow: var(--card-shadow-hover);
            padding: 20px;
            min-width: 280px;
            max-width: 90vw;
            display: none;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .theme-dropdown.show {
            display: block;
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* This rule is redundant and can be removed */

        .theme-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 8px;
        }

        .theme-option:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .theme-option.active {
            background: var(--success-gradient);
            color: white;
        }

        .theme-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 12px;
            border: 2px solid #dee2e6;
        }

        /* 成就系统 */
        .achievements-section {
            margin-bottom: 40px;
        }

        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .achievements-header h3 {
            color: var(--theme-text);
            font-size: 1.5em;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .achievement-card {
            background: linear-gradient(145deg, #fff, #f0f0f0);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .achievement-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .achievement-card:hover::before {
            left: 100%;
        }

        .achievement-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--card-shadow-hover);
            border: 2px solid var(--theme-accent);
        }

        .achievement-card.earned {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            border: 2px solid rgba(16, 185, 129, 0.6);
            animation: achievement-glow 2s ease-in-out infinite alternate;
        }

        @keyframes achievement-glow {
            0% {
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            }
            100% {
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.6), 0 0 40px rgba(16, 185, 129, 0.3);
            }
        }

        .achievement-card.earned:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.5);
        }

        .achievement-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            transition: all 0.3s ease;
        }

        .achievement-card.earned .achievement-icon {
            filter: drop-shadow(0 4px 8px rgba(16, 185, 129, 0.3));
            animation: icon-bounce 0.6s ease;
        }

        @keyframes icon-bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .achievement-card:hover .achievement-icon {
            transform: scale(1.1);
        }

        .achievement-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .achievement-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .achievement-category {
            font-size: 0.8em;
            background: rgba(102, 126, 234, 0.1);
            color: var(--theme-accent);
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .achievement-difficulty {
            font-size: 0.8em;
            font-weight: 600;
        }

        .achievement-earned {
            margin-top: 8px;
            font-size: 0.8em;
            opacity: 0.9;
            font-weight: 600;
        }



        /* 标签页系统 */
        .tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 30px;
        }

        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #6c757d;
            transition: var(--transition);
            position: relative;
        }

        .tab.active {
            color: var(--theme-accent);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-gradient);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* 历史记录 */
        .history-section {
            margin-bottom: 40px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-header h3 {
            color: var(--theme-text);
            font-size: 1.4em;
        }

        .btn-clear, .btn-export, .btn-admin {
            background: var(--warning-gradient);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: var(--transition);
            box-shadow: var(--card-shadow);
        }

        .btn-clear:hover, .btn-export:hover, .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-admin {
            background: var(--primary-gradient);
        }

        .btn-reset-filters {
            background: var(--info-gradient);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--card-shadow);
        }

        .btn-reset-filters:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* 历史记录筛选器样式 */
        .history-filters {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .filter-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
            vertical-align: top;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--theme-text);
            font-size: 14px;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: var(--theme-text);
            transition: var(--transition);
            min-width: 120px;
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--theme-accent);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-status {
            margin-top: 10px;
            padding: 8px 12px;
            background: var(--info-gradient);
            color: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
        }

        /* 历史记录统计概览样式 */
        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stats-card {
            background: linear-gradient(145deg, #fff, #f8f9fa);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .stats-card:hover {
            transform: translateY(-3px);
            border-color: var(--theme-accent);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }

        .stats-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--theme-accent);
            margin-bottom: 5px;
        }

        .stats-label {
            font-size: 0.9em;
            color: #6c757d;
            font-weight: 600;
        }

        /* 历史数据分析区域样式 */
        .history-analysis {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .history-analysis h3 {
            margin-bottom: 20px;
            color: var(--theme-text);
            font-size: 1.3em;
            text-align: center;
        }

        .analysis-tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 20px;
            gap: 2px;
        }

        .analysis-tab {
            padding: 12px 20px;
            background: rgba(248, 249, 250, 0.8);
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
            transition: var(--transition);
            border-radius: 8px 8px 0 0;
            position: relative;
        }

        .analysis-tab.active {
            background: var(--theme-accent);
            color: white;
            font-weight: 600;
        }

        .analysis-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: var(--theme-accent);
        }

        .analysis-content {
            display: none;
        }

        .analysis-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .chart-container h4 {
            margin-bottom: 15px;
            color: var(--theme-text);
            font-size: 1.1em;
            text-align: center;
        }

        .mini-chart {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-style: italic;
        }

        /* 图表样式 */
        .chart-empty {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }

        /* 饼图样式 */
        .pie-chart {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: flex-start;
        }

        .pie-item {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: var(--transition);
        }

        .pie-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .pie-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .pie-info {
            flex: 1;
        }

        .pie-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--theme-text);
            margin-bottom: 2px;
        }

        .pie-value {
            font-size: 12px;
            color: #6c757d;
        }

        /* 折线图样式 */
        .line-chart {
            display: flex;
            justify-content: space-between;
            align-items: end;
            height: 180px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
        }

        .line-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 40px;
            flex-shrink: 0;
        }

        .line-bar {
            width: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            transition: var(--transition);
            position: relative;
        }

        .line-bar:hover {
            transform: scale(1.1);
        }

        .line-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .line-value {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }

        /* 柱状图样式 */
        .bar-chart {
            display: flex;
            justify-content: space-between;
            align-items: end;
            height: 180px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
        }

        .bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
            flex-shrink: 0;
        }

        .bar-group {
            display: flex;
            gap: 3px;
            align-items: end;
            height: 120px;
            margin-bottom: 8px;
        }

        .bar {
            width: 12px;
            border-radius: 2px 2px 0 0;
            transition: var(--transition);
            position: relative;
        }

        .bar:hover {
            transform: scale(1.1);
        }

        .bar-earned {
            background: var(--success-gradient);
        }

        .bar-spent {
            background: var(--danger-gradient);
        }

        .bar-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .bar-value {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            background: rgba(255,255,255,0.9);
        }

        .history-item {
            padding: 18px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .history-item:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-info {
            flex: 1;
        }

        .history-amount {
            font-weight: bold;
            font-size: 1.2em;
            min-width: 100px;
            text-align: right;
        }

        .amount-positive {
            color: #28a745;
        }

        .amount-negative {
            color: #dc3545;
        }

        .history-details {
            font-size: 1em;
            color: var(--theme-text);
            margin-bottom: 5px;
        }

        .history-time {
            font-size: 0.85em;
            color: #6c757d;
        }

        /* 设置区域 */
        .settings-section {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }

        .settings-section h3 {
            margin-bottom: 25px;
            color: var(--theme-text);
            text-align: center;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .btn-save-settings {
            background: var(--primary-gradient);
            color: white;
            width: 100%;
            padding: 18px;
            border-radius: 12px;
            font-weight: 700;
        }

        .btn-save-settings:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        /* 家长控制面板 */
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .admin-panel.show {
            display: flex;
        }

        .admin-content {
            background: var(--theme-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 85%;
            max-height: 70vh;
            overflow-y: auto;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--card-shadow);
        }

        .admin-stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--theme-accent);
        }

        .admin-stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        /* 动画定义 */
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes glow {
            0% { text-shadow: 2px 2px 8px rgba(0,0,0,0.3); }
            100% { text-shadow: 2px 2px 20px rgba(255,255,255,0.8); }
        }

        @keyframes pulse-scale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(10px, -10px) rotate(180deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes bounce-in {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        .achievement-popup {
            position: fixed !important;
            top: 80px !important;
            left: 50% !important;
            transform: translate(-50%, 0) !important;
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 99999 !important;
            animation: achievement-popup 0.8s ease-out;
            border: 3px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
            min-width: 280px;
            max-width: 90vw;
        }

        .achievement-popup::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: popup-rotate 3s linear infinite;
        }

        @keyframes popup-rotate {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes achievement-popup {
            0% {
                transform: translate(-50%, 0) scale(0.3) rotate(-10deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, 0) scale(1.1) rotate(5deg);
            }
            100% {
                transform: translate(-50%, 0) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* 积分变化动画 */
        @keyframes points-gain {
            0% {
                transform: scale(1);
                color: inherit;
            }
            25% {
                transform: scale(1.3);
                color: #10b981;
                text-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
            }
            50% {
                transform: scale(1.2);
                color: #34d399;
                text-shadow: 0 0 30px rgba(52, 211, 153, 0.8);
            }
            75% {
                transform: scale(1.1);
                color: #10b981;
                text-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
            }
            100% {
                transform: scale(1);
                color: inherit;
                text-shadow: 3px 3px 10px rgba(0,0,0,0.3);
            }
        }

        @keyframes points-loss {
            0% {
                transform: scale(1);
                color: inherit;
            }
            25% {
                transform: scale(0.7);
                color: #ef4444;
                text-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            }
            50% {
                transform: scale(0.8);
                color: #f87171;
                text-shadow: 0 0 30px rgba(248, 113, 113, 0.8);
            }
            75% {
                transform: scale(0.9);
                color: #ef4444;
                text-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            }
            100% {
                transform: scale(1);
                color: inherit;
                text-shadow: 3px 3px 10px rgba(0,0,0,0.3);
            }
        }

        /* 积分变化提示动画 */
        @keyframes change-indicator {
            0% {
                transform: translateY(20px) scale(0.5);
                opacity: 0;
            }
            20% {
                transform: translateY(0) scale(1.2);
                opacity: 1;
            }
            80% {
                transform: translateY(-10px) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-30px) scale(0.8);
                opacity: 0;
            }
        }

        /* 积分显示区域动画 */
        @keyframes points-area-glow {
            0% {
                box-shadow: var(--card-shadow);
            }
            50% {
                box-shadow: 0 0 40px rgba(16, 185, 129, 0.4), var(--card-shadow);
            }
            100% {
                box-shadow: var(--card-shadow);
            }
        }

        @keyframes points-area-shake {
            0%, 100% {
                transform: translateX(0);
            }
            10%, 30%, 50%, 70%, 90% {
                transform: translateX(-3px);
            }
            20%, 40%, 60%, 80% {
                transform: translateX(3px);
            }
        }

        .achievement-popup h4 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-gradient);
            color: white;
            padding: 20px 25px;
            border-radius: 12px;
            transform: translateX(100%);
            transition: var(--transition);
            z-index: 1000;
            box-shadow: var(--card-shadow);
            font-weight: 600;
        }

        .toast.show {
            transform: translateX(0);
            animation: slideInRight 0.3s ease-out;
        }

        .toast.error {
            background: var(--danger-gradient);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* 积分变化提示样式 */
        .points-change-indicator {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: bold;
            z-index: 10;
            pointer-events: none;
            animation: change-indicator 2s ease-out forwards;
        }

        .points-change-indicator.gain {
            color: #10b981;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        /* 移动端界面布局优化 */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            /* 移动端头部和积分显示区域布局优化 - 改为垂直堆叠 */
            .header-dashboard-container {
                flex-direction: column;
                gap: 6px;
                padding: 8px;
            }

            .left-points-section {
                flex: none;
                width: 100%;
                order: 1;
                padding: 8px 6px;
            }

            .right-header-section {
                flex: none;
                width: 100%;
                order: 2;
                padding: 6px;
            }

            /* 移动端积分显示区域优化 */
            .points-display {
                max-width: none;
                width: 100%;
                padding: 15px 12px;
                margin: 0;
            }

            .current-points {
                font-size: 2.5em;
                margin: 6px 0;
            }

            .points-stats {
                margin-top: 8px;
                gap: 6px;
            }

            .stat-item {
                padding: 8px 6px;
                margin: 0;
                flex: 1;
            }

            .stat-value {
                font-size: 1.2em;
            }

            .stat-label {
                font-size: 0.75em;
            }

            .container {
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }

            .fixed-header {
                border-bottom: 1px solid #e9ecef;
            }

            .header {
                padding: 15px 20px;
            }

            .header h1 {
                font-size: 1.6em;
                margin-bottom: 8px;
            }

            .child-name {
                font-size: 1em;
                margin-bottom: 10px;
            }

            .fixed-dashboard {
                padding: 15px 20px;
            }

            .points-display {
                padding: 15px 12px;
            }

            .current-points {
                font-size: 2.5em;
                margin: 8px 0;
            }

            .points-label {
                font-size: 1.1em;
                margin-bottom: 6px;
            }

            .stat-value {
                font-size: 1.2em;
            }

            .stat-item {
                padding: 8px 6px;
            }

            .points-stats {
                margin-top: 10px;
            }

            /* 每日一言移动端优化 */
            .daily-quote {
                margin-top: 6px;
                padding: 12px 15px;
                max-width: 100%;
                border-radius: 12px;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            .quote-text {
                font-size: 0.95em;
                line-height: 1.5;
                margin-bottom: 6px;
                white-space: normal;
                word-wrap: break-word;
                overflow-wrap: break-word;
                min-width: 0;
                text-align: left;
            }

            .quote-text::before,
            .quote-text::after {
                font-size: 1.2em;
            }

            .quote-text::before {
                left: -8px;
                top: -2px;
            }

            .quote-text::after {
                right: -8px;
                bottom: -8px;
            }

            .quote-author {
                font-size: 0.8em;
                margin-top: 4px;
            }

            .main-content {
                padding: 15px;
            }

            /* 按钮尺寸优化 - 移动端按钮缩小尺寸 */
            .btn {
                padding: 12px 10px;
                font-size: 14px;
                font-weight: 600;
                border-radius: 10px;
                min-height: 40px;
                margin-top: 8px;
                position: relative;
                touch-action: manipulation;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            }

            .btn-add, .btn-subtract {
                font-size: 14px;
                padding: 14px 10px;
            }

            /* 控制面板优化 - 移动端保持两列布局，缩小尺寸 */
            .controls {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 15px;
            }

            .control-group {
                padding: 12px;
                border-radius: 10px;
            }

            .control-group h3 {
                font-size: 1.1em;
                margin-bottom: 12px;
                padding-bottom: 8px;
            }

            /* 输入框优化 - 优化移动端数字输入体验，缩小尺寸 */
            .input-group {
                margin-bottom: 10px;
            }

            .input-group input, .input-group select {
                padding: 12px 10px;
                font-size: 16px;
                border-radius: 10px;
                min-height: 40px;
                border-width: 2px;
                background: rgba(255,255,255,0.95);
            }

            .input-group input:focus, .input-group select:focus {
                border-color: var(--theme-accent);
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
                transform: scale(1.01);
                transition: all 0.2s ease;
            }

            .input-group label {
                font-size: 14px;
                margin-bottom: 6px;
                font-weight: 600;
            }

            /* 成就和奖励卡片布局优化 */
            .achievements-grid, .rewards-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }

            .achievement-card, .reward-card {
                padding: 15px 12px;
                border-radius: 12px;
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }

            .achievement-card:active, .reward-card:active {
                transform: scale(0.98);
            }

            .achievement-icon {
                font-size: 2.2em;
                margin-bottom: 8px;
            }

            .reward-icon {
                font-size: 2.5em;
                margin-bottom: 12px;
            }

            .reward-title {
                font-size: 1.1em;
                margin-bottom: 6px;
            }

            .reward-cost {
                font-size: 1.1em;
                margin-bottom: 12px;
            }

            /* 标签页优化 */
            .tabs {
                margin-bottom: 15px;
                gap: 2px;
            }

            .tab {
                padding: 14px 10px;
                font-size: 14px;
                flex: 1;
                min-width: 100px;
                border-radius: 10px 10px 0 0;
                background: rgba(248, 249, 250, 0.8);
                margin-right: 1px;
                transition: all 0.2s ease;
            }

            .tab:active {
                transform: scale(0.98);
                background: rgba(102, 126, 234, 0.1);
            }

            .tab.active {
                background: var(--theme-accent);
                color: white;
                transform: none;
            }

            /* 设置网格优化 */
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 18px;
            }

            .settings-section {
                padding: 18px;
                border-radius: 14px;
            }

            /* 用户选择器优化 */
            .user-selector {
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 1000;
            }

            .user-btn {
                padding: 14px 18px;
                font-size: 14px;
                border-radius: 20px;
                min-height: 44px;
                position: relative;
                overflow: hidden;
                transition: box-shadow 0.2s ease, background 0.2s ease;
            }

            .user-btn:hover {
                transform: none;
            }

            .user-btn:active {
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: box-shadow 0.1s ease;
            }

            .user-dropdown {
                position: fixed;
                top: 65px;
                left: 15px;
                width: 280px;
                max-width: calc(100vw - 30px);
                padding: 15px;
            }

            .user-actions {
                flex-direction: column;
                gap: 8px;
            }

            .user-action-btn {
                padding: 10px 12px;
                font-size: 13px;
            }

            /* 主题选择器优化 */
            .theme-selector {
                position: fixed;
                top: 15px;
                right: 15px;
                z-index: 1000;
            }

            .theme-btn {
                padding: 14px 18px;
                font-size: 14px;
                border-radius: 20px;
                min-height: 44px;
                position: relative;
                overflow: hidden;
                transition: box-shadow 0.2s ease, background 0.2s ease;
            }

            .theme-btn:hover {
                transform: none;
            }

            .theme-btn:active {
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: box-shadow 0.1s ease;
            }

            .theme-dropdown {
                position: fixed;
                top: 65px;
                right: 15px;
                width: 280px;
                max-width: calc(100vw - 30px);
                padding: 15px;
            }

            /* 历史记录优化 */
            .history-list {
                max-height: 280px;
                border-radius: 10px;
            }

            .history-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
                border-bottom: 1px solid #e9ecef;
            }

            .history-item:active {
                background: rgba(102, 126, 234, 0.05);
                transform: scale(0.99);
            }

            .history-amount {
                text-align: left;
                font-size: 1.1em;
                align-self: flex-end;
            }

            .history-details {
                font-size: 1em;
                margin-bottom: 3px;
            }

            .history-time {
                font-size: 0.8em;
            }

            /* 历史记录筛选器移动端优化 */
            .history-filters {
                padding: 15px;
                margin-bottom: 15px;
            }

            .filter-group {
                display: block;
                margin-right: 0;
                margin-bottom: 15px;
                width: 100%;
            }

            .filter-group select {
                width: 100%;
                min-width: auto;
                padding: 12px;
                font-size: 16px;
            }

            .filter-status {
                display: block;
                text-align: center;
                margin-top: 10px;
            }

            /* 历史统计概览移动端优化 */
            .history-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 15px;
            }

            .stats-card {
                padding: 12px;
            }

            .stats-value {
                font-size: 1.5em;
            }

            .stats-label {
                font-size: 0.8em;
            }

            /* 历史数据分析移动端优化 */
            .history-analysis {
                padding: 15px;
                margin-top: 15px;
            }

            .analysis-tabs {
                flex-wrap: wrap;
                gap: 1px;
            }

            .analysis-tab {
                flex: 1;
                min-width: 100px;
                padding: 10px 15px;
                font-size: 13px;
            }

            .chart-container {
                padding: 15px;
                margin-bottom: 10px;
            }

            .chart-container h4 {
                font-size: 1em;
                margin-bottom: 10px;
            }

            .mini-chart {
                min-height: 150px;
                font-size: 14px;
            }

            /* 家长控制面板优化 */
            .admin-content {
                padding: 25px 20px;
                border-radius: 16px;
                width: 95%;
                max-height: 85vh;
            }

            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }

            .admin-stat-card {
                padding: 15px 12px;
            }

            .admin-stat-value {
                font-size: 1.6em;
            }

            .admin-stat-label {
                font-size: 0.9em;
            }

            /* Toast消息优化 - 移动端友好 */
            .toast {
                top: 15px;
                right: 15px;
                left: 15px;
                transform: translateY(-100%);
                padding: 16px 20px;
                font-size: 16px;
                border-radius: 12px;
                max-width: none;
                text-align: center;
            }

            .toast.show {
                transform: translateY(0);
            }

            /* 成就弹窗优化 - 移动端适配 */
            .achievement-popup {
                top: 20% !important;
                left: 50% !important;
                transform: translate(-50%, 0) !important;
                width: 85%;
                max-width: 300px;
                padding: 25px 20px;
                border-radius: 16px;
                z-index: 99999 !important;
            }

            .achievement-popup h4 {
                font-size: 1.3em;
                margin-bottom: 8px;
            }

            /* 目标进度优化 */
            .goal-progress {
                height: 10px;
                margin-top: 6px;
            }

            .goal-progress-bar {
                border-radius: 6px;
            }

            /* 额外触摸优化 */
            .control-group, .achievement-card, .reward-card, .stat-item {
                cursor: pointer;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            .control-group:active {
                transform: scale(0.98);
            }

            /* 滚动优化 */
            .history-list, .admin-content {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }

            /* 防止文本选择 */
            .btn, .theme-btn, .tab, .control-group {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        }

        /* 超小屏幕优化 (480px以下) */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .header {
                padding: 15px 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .child-name {
                font-size: 1.1em;
            }

            .fixed-dashboard {
                padding: 12px 15px;
            }

            .current-points {
                font-size: 2.3em;
                margin: 10px 0;
            }

            .points-display {
                padding: 15px 12px;
            }

            .points-stats {
                margin-top: 10px;
            }

            .main-content {
                padding: 15px;
            }

            .control-group {
                padding: 15px;
            }

            .achievements-grid, .rewards-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }

            .btn {
                padding: 18px 14px;
                font-size: 15px;
            }

            .input-group input, .input-group select {
                padding: 16px 14px;
                font-size: 16px;
                min-height: 44px;
            }

            .theme-dropdown {
                width: 95%;
                max-width: 280px;
            }

            .admin-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 用户选择器 -->
    <div class="user-selector">
        <button class="user-btn" onclick="toggleUserDropdown()">👥 <span id="currentUserName">小朋友</span></button>
        <div class="user-dropdown" id="userDropdown">
            <!-- 用户列表将通过JavaScript动态生成 -->
        </div>
    </div>

    <!-- 主题选择器 -->
    <div class="theme-selector">
        <button class="theme-btn" onclick="toggleThemeDropdown()">🎨 主题</button>
        <div class="theme-dropdown" id="themeDropdown">
            <div class="theme-option active" onclick="changeTheme('default')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                <span>默认主题</span>
            </div>
            <div class="theme-option" onclick="changeTheme('rainbow')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #ff6b6b, #feca57, #48cae4, #f72585, #7209b7);"></div>
                <span>彩虹主题</span>
            </div>
            <div class="theme-option" onclick="changeTheme('forest')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #134e5e 0%, #71b280 100%);"></div>
                <span>森林主题</span>
            </div>
            <div class="theme-option" onclick="changeTheme('sunset')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);"></div>
                <span>日落主题</span>
            </div>
            <div class="theme-option" onclick="changeTheme('ocean')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);"></div>
                <span>海洋主题</span>
            </div>
            <div class="theme-option" onclick="changeTheme('christmas')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #c53030 0%, #38a169 100%);"></div>
                <span>🎄 圣诞主题</span>
            </div>
            <div class="theme-option" onclick="changeTheme('newyear')">
                <div class="theme-preview" style="background: linear-gradient(135deg, #ffd700 0%, #ff6b6b 50%, #4ecdc4 100%);"></div>
                <span>🎆 新年主题</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 头部和积分显示区域 -->
        <div class="header-dashboard-container">
            <!-- 左侧积分显示模块 -->
            <div class="left-points-section">
                <div class="points-display">
                    <div class="points-label" id="pointsLabel">当前积分</div>
                    <div class="current-points" id="currentPoints">0</div>
                    <!-- 积分变化提示 -->
                    <div class="points-change-indicator" id="pointsChangeIndicator" style="display: none;"></div>
                    <div class="points-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalEarned">0</div>
                            <div class="stat-label">总获得</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalSpent">0</div>
                            <div class="stat-label">总消费</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧头部区域模块 -->
            <div class="right-header-section">
                <div class="header">

                    <div class="child-name">欢迎回来，<span id="displayChildName">小朋友</span>！</div>
                    <!-- 每日一言区域 -->
                    <div class="daily-quote" id="dailyQuote">
                        <div class="quote-loading" id="quoteLoading">正在获取每日一言...</div>
                        <div class="quote-content" id="quoteContent" style="display: none;">
                            <div class="quote-text" id="quoteText"></div>
                            <div class="quote-author" id="quoteAuthor"></div>
                        </div>
                        <div class="quote-error" id="quoteError" style="display: none;">
                            每日一言暂时无法获取
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 可滚动内容区域 -->
        <div class="scrollable-content">
            <div class="main-content">

            <!-- 控制面板 -->
            <div class="controls">
                <!-- 增加积分 -->
                <div class="control-group">
                    <h3>🎉 获得积分</h3>
                    <div class="input-group">
                        <label for="addAmount">积分数量</label>
                        <input type="number" id="addAmount" min="1" value="10">
                    </div>
                    <div class="input-group">
                        <label for="addReason">获得原因</label>
                        <select id="addReason">
                            <!-- 学习类 -->
                            <optgroup label="📚 学习成长">
                                <option value="完成作业">完成作业</option>
                                <option value="__CUSTOM_INPUT__">📝 自定义输入...</option>
                                <option value="按时完成作业">按时完成作业</option>
                                <option value="主动学习">主动学习</option>
                                <option value="考试优秀">考试优秀</option>
                                <option value="主动阅读">主动阅读</option>
                                <option value="课堂表现好">课堂表现好</option>
                                <option value="完成额外练习">完成额外练习</option>
                                <option value="预习新课">预习新课</option>
                                <option value="复习巩固">复习巩固</option>
                                <option value="背诵课文">背诵课文</option>
                                <option value="默写单词">默写单词</option>
                                <option value="完成手工作业">完成手工作业</option>
                                <option value="科学实验">科学实验</option>
                                <option value="练字">练字</option>
                            </optgroup>
                            
                            <!-- 家务类 -->
                            <optgroup label="🏠 家务劳动">
                                <option value="帮助家务">帮助家务</option>
                                <option value="洗碗">洗碗</option>
                                <option value="扫地">扫地</option>
                                <option value="拖地">拖地</option>
                                <option value="整理房间">整理房间</option>
                                <option value="收拾玩具">收拾玩具</option>
                                <option value="晾衣服">晾衣服</option>
                                <option value="叠衣服">叠衣服</option>
                                <option value="倒垃圾">倒垃圾</option>
                                <option value="擦桌子">擦桌子</option>
                                <option value="准备餐具">准备餐具</option>
                                <option value="照顾植物">照顾植物</option>
                            </optgroup>
                            
                            <!-- 行为表现类 -->
                            <optgroup label="⭐ 行为表现">
                                <option value="表现优秀">表现优秀</option>
                                <option value="早起">早起</option>
                                <option value="按时睡觉">按时睡觉</option>
                                <option value="遵守规则">遵守规则</option>
                                <option value="主动道歉">主动道歉</option>
                                <option value="诚实守信">诚实守信</option>
                                <option value="不挑食">不挑食</option>
                                <option value="主动承认错误">主动承认错误</option>
                                <option value="不撒谎">不撒谎</option>
                                <option value="按时起床">按时起床</option>
                                <option value="自己穿衣服">自己穿衣服</option>
                                <option value="自己洗漱">自己洗漱</option>
                                <option value="不乱发脾气">不乱发脾气</option>
                            </optgroup>
                            
                            <!-- 健康运动类 -->
                            <optgroup label="🏃 健康运动">
                                <option value="锻炼身体">锻炼身体</option>
                                <option value="健康饮食">健康饮食</option>
                                <option value="体育锻炼">体育锻炼</option>
                                <option value="户外运动">户外运动</option>
                                <option value="游泳">游泳</option>
                                <option value="骑自行车">骑自行车</option>
                                <option value="跑步">跑步</option>
                                <option value="跳绳">跳绳</option>
                                <option value="打篮球">打篮球</option>
                                <option value="踢足球">踢足球</option>
                                <option value="练舞蹈">练舞蹈</option>
                                <option value="练乐器">练乐器</option>
                            </optgroup>
                            
                            <!-- 社交品德类 -->
                            <optgroup label="🤝 社交品德">
                                <option value="分享玩具">分享玩具</option>
                                <option value="帮助他人">帮助他人</option>
                                <option value="帮助同学">帮助同学</option>
                                <option value="做志愿服务">做志愿服务</option>
                                <option value="孝顺父母">孝顺父母</option>
                                <option value="照顾弟弟妹妹">照顾弟弟妹妹</option>
                                <option value="照顾宠物">照顾宠物</option>
                                <option value="尊老爱幼">尊老爱幼</option>
                                <option value="关心他人">关心他人</option>
                                <option value="主动打招呼">主动打招呼</option>
                                <option value="有礼貌">有礼貌</option>
                                <option value="不说脏话">不说脏话</option>
                                <option value="不欺负弱小">不欺负弱小</option>
                                <option value="安慰他人">安慰他人</option>
                                <option value="分享零食">分享零食</option>
                            </optgroup>
                            
                            <!-- 创造艺术类 -->
                            <optgroup label="🎨 创造艺术">
                                <option value="创作作品">创作作品</option>
                                <option value="画画">画画</option>
                                <option value="手工制作">手工制作</option>
                                <option value="写作">写作</option>
                                <option value="唱歌">唱歌</option>
                                <option value="跳舞">跳舞</option>
                                <option value="弹琴">弹琴</option>
                                <option value="做手工">做手工</option>
                                <option value="摄影">摄影</option>
                                <option value="做模型">做模型</option>
                                <option value="制作贺卡">制作贺卡</option>
                                <option value="参加表演">参加表演</option>
                            </optgroup>
                            
                            <!-- 兴趣爱好类 -->
                            <optgroup label="🎯 兴趣爱好">
                                <option value="参加比赛">参加比赛</option>
                                <option value="学习新技能">学习新技能</option>
                                <option value="练习才艺">练习才艺</option>
                                <option value="参加活动">参加活动</option>
                                <option value="拓展知识">拓展知识</option>
                                <option value="探索新事物">探索新事物</option>
                                <option value="学做菜">学做菜</option>
                                <option value="学骑车">学骑车</option>
                                <option value="学游泳">学游泳</option>
                                <option value="学外语">学外语</option>
                            </optgroup>
                            
                            <!-- 特殊奖励类 -->
                            <optgroup label="🏆 特殊成就">
                                <option value="连续获得积分">连续获得积分</option>
                                <option value="完成目标">完成目标</option>
                                <option value="帮助家庭">帮助家庭</option>
                                <option value="关心环境">关心环境</option>
                                <option value="节约用水">节约用水</option>
                                <option value="节约用电">节约用电</option>
                                <option value="垃圾分类">垃圾分类</option>
                                <option value="保护动物">保护动物</option>
                                <option value="关爱他人">关爱他人</option>
                                <option value="参与公益">参与公益</option>
                            </optgroup>
                            
                            <option value="其他">其他</option>
                            <option value="__CUSTOM_INPUT__">📝 自定义输入...</option>
                        </select>
                    </div>
                    <!-- 自定义获得原因输入框 -->
                    <div class="input-group" id="customAddReasonGroup" style="display: none;">
                        <label for="customAddReason">请输入自定义获得原因</label>
                        <input type="text" id="customAddReason" placeholder="例如：帮妈妈做了一件特别的事" maxlength="50">
                        <div style="font-size: 0.85em; color: #6c757d; margin-top: 5px;">字数限制：50字以内</div>
                    </div>
                    <button class="btn btn-add" onclick="addPoints()">🚀 获得积分</button>
                </div>

                <!-- 消费/惩罚积分 -->
                <div class="control-group">
                    <h3>💰 消费/惩罚积分</h3>
                    <div class="input-group">
                        <label for="subtractAmount">积分数量</label>
                        <input type="number" id="subtractAmount" min="1" value="5">
                    </div>
                    <div class="input-group">
                        <label for="subtractReason">消费/惩罚原因</label>
                        <select id="subtractReason">
                            <!-- 奖励兑换类 -->
                            <optgroup label="🎁 奖励兑换">
                                <option value="买玩具">买玩具</option>
                                <option value="__CUSTOM_INPUT__">📝 自定义输入...</option>
                                <option value="买零食">买零食</option>
                                <option value="买文具">买文具</option>
                                <option value="买书本">买书本</option>
                                <option value="买衣服">买衣服</option>
                                <option value="买电子产品">买电子产品</option>
                                <option value="买游戏">买游戏</option>
                                <option value="特殊奖励">特殊奖励</option>
                                <option value="去游乐园">去游乐园</option>
                                <option value="看动画片">看动画片</option>
                                <option value="玩游戏时间">玩游戏时间</option>
                                <option value="额外零花钱">额外零花钱</option>
                                <option value="小礼品">小礼品</option>
                            </optgroup>
                            
                            <!-- 学习类 -->
                            <optgroup label="📚 学习消费">
                                <option value="电子书">电子书</option>
                                <option value="学习用品">学习用品</option>
                                <option value="买课程">买课程</option>
                                <option value="买软件">买软件</option>
                                <option value="买资料">买资料</option>
                                <option value="培训费">培训费</option>
                                <option value="书籍费用">书籍费用</option>
                                <option value="打印资料">打印资料</option>
                            </optgroup>
                            
                            <!-- 娱乐活动类 -->
                            <optgroup label="🎉 娱乐活动">
                                <option value="娱乐活动">娱乐活动</option>
                                <option value="户外活动">户外活动</option>
                                <option value="看电影">看电影</option>
                                <option value="聚餐">聚餐</option>
                                <option value="买票">买票</option>
                                <option value="参加活动">参加活动</option>
                                <option value="购买会员">购买会员</option>
                                <option value="订阅服务">订阅服务</option>
                                <option value="充值">充值</option>
                            </optgroup>
                            
                            <!-- 爱心捐赠类 -->
                            <optgroup label="❤️ 爱心捐赠">
                                <option value="捐款">捐款</option>
                                <option value="捐玩具">捐玩具</option>
                                <option value="捐书">捐书</option>
                                <option value="爱心活动">爱心活动</option>
                                <option value="帮助他人">帮助他人</option>
                                <option value="慈善捐赠">慈善捐赠</option>
                                <option value="公益活动">公益活动</option>
                            </optgroup>
                            
                            <!-- 惩罚类 -->
                            <optgroup label="⚠️ 惩罚扣除">
                                <option value="未完成作业">未完成作业</option>
                                <option value="不听话">不听话</option>
                                <option value="乱发脾气">乱发脾气</option>
                                <option value="撒谎">撒谎</option>
                                <option value="不诚实">不诚实</option>
                                <option value="欺负他人">欺负他人</option>
                                <option value="损坏物品">损坏物品</option>
                                <option value="不遵守规则">不遵守规则</option>
                                <option value="不按时睡觉">不按时睡觉</option>
                                <option value="挑食">挑食</option>
                                <option value="不整理房间">不整理房间</option>
                                <option value="乱扔东西">乱扔东西</option>
                                <option value="不礼貌">不礼貌</option>
                                <option value="说脏话">说脏话</option>
                                <option value="不尊重他人">不尊重他人</option>
                                <option value="浪费食物">浪费食物</option>
                                <option value="不珍惜物品">不珍惜物品</option>
                                <option value="迟到">迟到</option>
                                <option value="早退">早退</option>
                                <option value="不专心">不专心</option>
                                <option value="作弊">作弊</option>
                            </optgroup>
                            
                            <!-- 生活消费类 -->
                            <optgroup label="🏠 生活消费">
                                <option value="交通费">交通费</option>
                                <option value="餐费">餐费</option>
                                <option value="日用品">日用品</option>
                                <option value="维修费">维修费</option>
                                <option value="医疗费">医疗费</option>
                                <option value="理发">理发</option>
                                <option value="洗澡用品">洗澡用品</option>
                            </optgroup>
                            
                            <option value="其他">其他</option>
                            <option value="__CUSTOM_INPUT__">📝 自定义输入...</option>
                        </select>
                    </div>
                    <!-- 自定义消费原因输入框 -->
                    <div class="input-group" id="customSubtractReasonGroup" style="display: none;">
                        <label for="customSubtractReason">请输入自定义消费/惩罚原因</label>
                        <input type="text" id="customSubtractReason" placeholder="例如：买了一个心仪的玩具" maxlength="50">
                        <div style="font-size: 0.85em; color: #6c757d; margin-top: 5px;">字数限制：50字以内</div>
                    </div>
                    <button class="btn btn-subtract" onclick="subtractPoints()">💸 消费积分</button>
                </div>
            </div>

            <!-- 成就系统 -->
            <div class="achievements-section">
                <div class="achievements-header">
                    <h3>🏆 成就系统</h3>
                    <div style="color: #6c757d; font-size: 0.9em;" id="achievementCount">0/0 已解锁</div>
                </div>
                <div class="achievements-grid" id="achievementsGrid">
                    <!-- 成就将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 标签页 -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('history')">📋 历史记录</button>
                <button class="tab" onclick="switchTab('stats')">📊 统计分析</button>
                <button class="tab" onclick="switchTab('settings')">⚙️ 系统设置</button>
            </div>

            <!-- 历史记录标签页 -->
            <div id="history" class="tab-content active">
                <div class="history-section">
                    <div class="history-header">
                        <h3>📋 积分历史</h3>
                        <button class="btn-reset-filters" onclick="resetFilters()">🔄 重置筛选</button>
                    </div>
                    
                    <!-- 筛选器区域 -->
                    <div class="history-filters">
                        <div class="filter-group">
                            <label for="dateFilter">时间范围：</label>
                            <select id="dateFilter" onchange="applyFilters()">
                                <option value="all">全部时间</option>
                                <option value="today">今天</option>
                                <option value="week">本周</option>
                                <option value="month">本月</option>
                                <option value="3months">近3个月</option>
                                <option value="6months">近6个月</option>
                                <option value="year">今年</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="typeFilter">积分类型：</label>
                            <select id="typeFilter" onchange="applyFilters()">
                                <option value="all">全部类型</option>
                                <option value="earned">获得积分</option>
                                <option value="spent">消费积分</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="reasonFilter">原因类别：</label>
                            <select id="reasonFilter" onchange="applyFilters()">
                                <option value="all">全部原因</option>
                                <!-- 获得原因选项将通过JavaScript动态生成 -->
                            </select>
                        </div>
                        
                        <div class="filter-status" id="filterStatus">
                            显示全部记录
                        </div>
                    </div>
                    
                    <!-- 统计概览区域 -->
                    <div class="history-stats">
                        <div class="stats-card">
                            <div class="stats-value" id="filteredTotalCount">0</div>
                            <div class="stats-label">筛选记录数</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-value" id="filteredEarnedTotal">0</div>
                            <div class="stats-label">获得总数</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-value" id="filteredSpentTotal">0</div>
                            <div class="stats-label">消费总数</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-value" id="filteredNetGain">0</div>
                            <div class="stats-label">净增长</div>
                        </div>
                    </div>
                    
                    <div class="history-list" id="historyList">
                        <div class="empty-history">
                            还没有积分记录，快来获得你的第一个积分吧！
                        </div>
                    </div>
                </div>
                
                <!-- 历史数据分析区域 -->
                <div class="history-analysis">
                    <h3>📊 数据分析</h3>
                    <div class="analysis-tabs">
                        <button class="analysis-tab active" onclick="showAnalysisTab('category')">类别分析</button>
                        <button class="analysis-tab" onclick="showAnalysisTab('trend')">趋势分析</button>
                        <button class="analysis-tab" onclick="showAnalysisTab('monthly')">月度统计</button>
                    </div>
                    
                    <div id="categoryAnalysis" class="analysis-content active">
                        <div class="chart-container">
                            <h4>🎯 获得原因分布</h4>
                            <div id="earnedCategoryChart" class="mini-chart"></div>
                        </div>
                        <div class="chart-container">
                            <h4>💰 消费原因分布</h4>
                            <div id="spentCategoryChart" class="mini-chart"></div>
                        </div>
                    </div>
                    
                    <div id="trendAnalysis" class="analysis-content">
                        <div class="chart-container">
                            <h4>📈 积分增长趋势</h4>
                            <div id="trendChart" class="mini-chart"></div>
                        </div>
                    </div>
                    
                    <div id="monthlyAnalysis" class="analysis-content">
                        <div class="chart-container">
                            <h4>📅 月度统计对比</h4>
                            <div id="monthlyChart" class="mini-chart"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 统计分析标签页 -->
            <div id="stats" class="tab-content">
                <div class="chart-section">
                    <h3 style="text-align: center; margin-bottom: 20px; color: var(--theme-text);">📈 最近7天积分趋势</h3>
                    <div class="chart-container" id="chartContainer">
                        <!-- 图表将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 设置标签页 -->
            <div id="settings" class="tab-content">
                <div class="settings-section">
                    <h3>⚙️ 系统设置</h3>
                    <div class="settings-grid">
                        <div class="input-group">
                            <label for="childNameInput">姓名</label>
                            <input type="text" id="childNameInput" placeholder="请输入你的名字">
                        </div>
                        <div class="input-group">
                            <label for="currencyInput">积分单位</label>
                            <select id="currencyInput" onchange="updateCurrencyPreview()">
                                <!-- 积分单位选项将由JavaScript动态生成 -->
                            </select>
                            <div id="currencyPreview" style="margin-top: 10px; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; text-align: center;">
                                <span id="previewIcon" style="font-size: 1.5em;">⭐</span>
                                <span id="previewName" style="margin-left: 8px; font-weight: bold;">星星</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="passwordInput">消费密码</label>
                            <input type="password" id="passwordInput" placeholder="请设置消费验证密码" maxlength="8">
                            <div style="font-size: 0.85em; color: #6c757d; margin-top: 5px;">用于验证积分消费，4-8位数字或字母</div>
                        </div>

                    </div>
                    <button class="btn btn-save-settings" onclick="saveSettings()">💾 保存设置</button>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                        <div class="input-group">
                            <label>管理员功能</label>
                            <button class="btn btn-admin" onclick="openAdminPanel()" style="width: 100%; background: var(--primary-gradient);">🔐 管理员面板</button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                        <div class="input-group">
                            <label>云服务器同步</label>
                            <button class="btn btn-save-settings" onclick="openCloudSyncPanel()" style="width: 100%; background: var(--info-gradient);">☁️ 云端同步</button>
                        </div>
                    </div>
                    

                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- 家长控制面板 -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-content">
            <div class="admin-header">
                <h2>🔐 家长控制面板</h2>
                <button class="btn-clear" onclick="closeAdminPanel()">✕ 关闭</button>
            </div>
            
            <div class="admin-stats">
                <div class="admin-stat-card">
                    <div class="admin-stat-value" id="adminTotalPoints">0</div>
                    <div class="admin-stat-label">当前总积分</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value" id="adminTotalEarned">0</div>
                    <div class="admin-stat-label">累计获得</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value" id="adminTotalSpent">0</div>
                    <div class="admin-stat-label">累计消费</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value" id="adminActivityDays">0</div>
                    <div class="admin-stat-label">活跃天数</div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 20px; color: var(--theme-text);">📥 数据管理</h3>
                <div class="settings-grid">
                    <div class="input-group">
                        <label>导出数据</label>
                        <button class="btn btn-export" onclick="exportData()" style="width: 100%; background: var(--primary-gradient);">📥 导出所有数据</button>
                    </div>
                    <div class="input-group">
                        <label>文件导入</label>
                        <input type="file" id="importFileInput" accept=".json,.txt" style="display: none;" onchange="importData()">
                        <button class="btn btn-save-settings" onclick="document.getElementById('importFileInput').click()" style="width: 100%; background: var(--primary-gradient);">📤 文件导入</button>
                    </div>
                    <div class="input-group">
                        <label>文本导入</label>
                        <button class="btn btn-admin" onclick="showTextImportDialog()" style="width: 100%; background: var(--warning-gradient);">📋 文本导入</button>
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 20px; color: var(--theme-text);">☁️ 云同步操作</h3>
                <div class="settings-grid">
                    <div class="input-group">
                        <label>快速上传</label>
                        <button class="btn btn-add" onclick="quickUploadToCloud()" style="width: 100%; background: var(--success-gradient);">⬆️ 快速上传云端</button>
                    </div>
                    <div class="input-group">
                        <label>快速下载</label>
                        <button class="btn btn-subtract" onclick="quickDownloadFromCloud()" style="width: 100%; background: var(--danger-gradient);">⬇️ 快速下载</button>
                    </div>
                    <div class="input-group">
                        <label>打开云同步面板</label>
                        <button class="btn btn-save-settings" onclick="openCloudSyncPanel(); closeAdminPanel();" style="width: 100%; background: var(--info-gradient);">☁️ 云端同步面板</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 20px; color: var(--theme-text);">⚠️ 管理操作</h3>
                <div class="settings-grid">
                    <div class="input-group">
                        <label>重置所有数据</label>
                        <button class="btn btn-subtract" onclick="resetAllData()" style="width: 100%; background: var(--danger-gradient);">🗑️ 重置积分系统</button>
                    </div>
                    <div class="input-group">
                        <label>生成详细报告</label>
                        <button class="btn btn-export" onclick="generateReport()" style="width: 100%; background: var(--primary-gradient);">📊 生成报告</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 云同步面板 -->
    <div class="admin-panel" id="cloudSyncPanel">
        <div class="admin-content">
            <div class="admin-header">
                <h2>☁️ 云服务器同步</h2>
                <button class="btn-clear" onclick="closeCloudSyncPanel()">✕ 关闭</button>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px; color: var(--theme-text);">🔧 连接配置</h3>
                <div class="settings-grid">
                    <div class="input-group">
                        <label for="serverUrlInput">服务器地址</label>
                        <input type="url" id="serverUrlInput" placeholder="https://your-server-domain.com" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px;">
                        <div style="font-size: 0.85em; color: #6c757d; margin-top: 5px;">请输入您的云服务器API地址</div>
                    </div>
                    <div class="input-group">
                        <label for="apiKeyInput">API密钥（可选）</label>
                        <input type="password" id="apiKeyInput" placeholder="请输入API密钥" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px;">
                        <div style="font-size: 0.85em; color: #6c757d; margin-top: 5px;">如未设置API密钥可留空</div>
                    </div>
                    <div class="input-group">
                        <label>连接状态</label>
                        <div id="cloudConnectionStatus" style="padding: 12px; border-radius: 8px; text-align: center; font-weight: 600;">未连接</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px; color: var(--theme-text);">📊 数据同步</h3>
                <div class="settings-grid">
                    <div class="input-group">
                        <label>上传本地数据</label>
                        <button class="btn btn-add" onclick="uploadToCloud()" style="width: 100%; background: var(--success-gradient);">⬆️ 上传到云端</button>
                    </div>
                    <div class="input-group">
                        <label>下载云端数据</label>
                        <button class="btn btn-subtract" onclick="downloadFromCloud()" style="width: 100%; background: var(--danger-gradient);">⬇️ 从云端下载</button>
                    </div>
                    <div class="input-group">
                        <label>查看备份历史</label>
                        <button class="btn btn-save-settings" onclick="viewCloudBackups()" style="width: 100%; background: var(--warning-gradient);">📋 备份历史</button>
                    </div>
                    <div class="input-group">
                        <label>同步设置</label>
                        <button class="btn btn-admin" onclick="saveCloudSettings()" style="width: 100%; background: var(--primary-gradient);">💾 保存设置</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px; color: var(--theme-text);">⚙️ 自动同步</h3>
                <div class="settings-grid">
                    <div class="input-group">
                        <label>启用自动同步</label>
                        <button id="autoSyncToggle" class="btn btn-save-settings" onclick="toggleAutoSync()" style="width: 100%; background: var(--info-gradient);">🚫 关闭</button>
                    </div>
                    <div class="input-group">
                        <label>同步频率</label>
                        <select id="syncFrequency" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px;">
                            <option value="manual">手动同步</option>
                            <option value="5min">每5分钟</option>
                            <option value="15min">每15分钟</option>
                            <option value="30min">每30分钟</option>
                            <option value="1hour">每1小时</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px; color: var(--theme-text);">📊 云同步日志</h3>
                <div style="background: #f8f9fa; border-radius: 12px; padding: 15px; max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6;">
                    <div id="cloudSyncLogs" style="font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;">
                        <div style="color: #6c757d; text-align: center; padding: 20px;">暂无云同步日志</div>
                    </div>
                </div>
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button onclick="refreshCloudLogs()" style="flex: 1; padding: 8px; background: var(--info-gradient); color: white; border: none; border-radius: 6px; font-size: 12px;">🔄 刷新日志</button>
                    <button onclick="clearCloudLogs()" style="flex: 1; padding: 8px; background: var(--danger-gradient); color: white; border: none; border-radius: 6px; font-size: 12px;">🗑️ 清空日志</button>
                </div>
            </div>
            
            <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.2);">
                <h4 style="margin-bottom: 10px; color: var(--theme-text);">💡 使用说明</h4>
                <ul style="margin: 0; padding-left: 20px; color: #6c757d; font-size: 0.9em; line-height: 1.6;">
                    <li>首先配置您的云服务器地址和API密钥</li>
                    <li>点击"上传到云端"保存当前数据到云服务器</li>
                    <li>在其他设备上点击"从云端下载"获取最新数据</li>
                    <li>可以查看和恢复历史备份版本</li>
                    <li>启用自动同步后系统将定期备份数据</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 用户管理面板 -->
    <div class="admin-panel" id="userManagementPanel">
        <div class="admin-content">
            <div class="admin-header">
                <h2>👥 用户管理</h2>
                <button class="btn-clear" onclick="closeUserManagementPanel()">✕ 关闭</button>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px; color: var(--theme-text);">➕ 添加新用户</h3>
                <div class="input-group">
                    <label for="newUserNameInput">小朋友姓名</label>
                    <input type="text" id="newUserNameInput" placeholder="请输入小朋友的姓名" maxlength="20" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px;">
                </div>
                <div class="input-group">
                    <label for="newUserCurrencyInput">积分单位</label>
                    <select id="newUserCurrencyInput" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px;">
                        <option value="⭐ 星星">⭐ 星星</option>
                        <option value="😊 笑脸">😊 笑脸</option>
                        <option value="❤️ 爱心">❤️ 爱心</option>
                        <option value="🌸 花朵">🌸 花朵</option>
                        <option value="🍬 糖果">🍬 糖果</option>
                        <option value="🎈 气球">🎈 气球</option>
                        <option value="🧸 小熊">🧸 小熊</option>
                        <option value="🌈 彩虹">🌈 彩虹</option>
                        <option value="✨ 魔法">✨ 魔法</option>
                    </select>
                </div>
                <button class="btn btn-add" onclick="addNewUser()" style="width: 100%; margin-top: 15px; background: var(--success-gradient);">➕ 添加用户</button>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px; color: var(--theme-text);">📋 用户列表</h3>
                <div id="userList" style="max-height: 300px; overflow-y: auto;">
                    <!-- 用户列表将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.2);">
                <h4 style="margin-bottom: 10px; color: var(--theme-text);">💡 使用说明</h4>
                <ul style="margin: 0; padding-left: 20px; color: #6c757d; font-size: 0.9em; line-height: 1.6;">
                    <li>点击左上角的用户按钮可以快速切换用户</li>
                    <li>每个用户拥有独立的积分、历史记录和成就</li>
                    <li>删除用户将永久删除该用户的所有数据</li>
                    <li>系统会自动保存所有用户的数据</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        console.log('终极积分系统脚本开始加载...');
        
        // 云服务器配置
        let cloudConfig = {
            serverUrl: localStorage.getItem('cloudServerUrl') || 'http://47.122.118.180:5000/',
            apiKey: localStorage.getItem('cloudApiKey') || 'your-secret-api-key-here',
            autoSync: localStorage.getItem('cloudAutoSync') === 'true',
            syncFrequency: localStorage.getItem('cloudSyncFrequency') || 'manual'
        };
        
        let autoSyncTimer = null;
        
        // 多用户数据结构
        let multiUserData = {
            users: {},
            currentUserId: null,
            userCount: 0
        };
        
        // 当前用户数据（单用户数据结构保持兼容）
        let pointsData = {
            currentPoints: 0,
            totalEarned: 0,
            totalSpent: 0,
            lastUpdated: null,
            history: [],
            settings: {
                childName: '小朋友',
                currency: '积分',
                notifications: true,
                theme: 'default',
                password: '',
                passwordEnabled: false
            },
            achievements: {
                firstEarn: false,
                points50: false,
                points100: false,
                points500: false,
                firstSpend: false,
                dailyActive: false,
                consistency3: false
            }
        };
        
        // 积分配置对象 - 根据原因自动设置积分数量
        const pointsConfig = {
            // 学习成长类 (5-100分)
            earn: {
                '完成作业': 10,
                '按时完成作业': 15,
                '主动学习': 20,
                '考试优秀': 100,
                '主动阅读': 5,
                '课堂表现好': 15,
                '完成额外练习': 25,
                '预习新课': 12,
                '复习巩固': 8,
                '背诵课文': 10,
                '默写单词': 8,
                '完成手工作业': 15,
                '科学实验': 30,
                '练字': 5,
                
                // 家务劳动类 (3-15分)
                '帮助家务': 5,
                '洗碗': 3,
                '扫地': 3,
                '拖地': 4,
                '整理房间': 6,
                '收拾玩具': 5,
                '晾衣服': 4,
                '叠衣服': 3,
                '倒垃圾': 2,
                '擦桌子': 3,
                '准备餐具': 2,
                '照顾植物': 8,
                
                // 行为表现类 (2-20分)
                '表现优秀': 15,
                '早起': 10,
                '按时睡觉': 8,
                '遵守规则': 12,
                '主动道歉': 10,
                '诚实守信': 20,
                '不挑食': 5,
                '主动承认错误': 15,
                '不撒谎': 12,
                '按时起床': 8,
                '自己穿衣服': 5,
                '自己洗漱': 5,
                '不乱发脾气': 10,
                
                // 健康运动类 (3-25分)
                '锻炼身体': 10,
                '健康饮食': 8,
                '体育锻炼': 15,
                '户外运动': 12,
                '游泳': 20,
                '骑自行车': 15,
                '跑步': 8,
                '跳绳': 10,
                '打篮球': 18,
                '踢足球': 18,
                '练舞蹈': 15,
                '练乐器': 25,
                
                // 社交品德类 (5-30分)
                '分享玩具': 8,
                '帮助他人': 15,
                '帮助同学': 10,
                '做志愿服务': 25,
                '孝顺父母': 30,
                '照顾弟弟妹妹': 20,
                '照顾宠物': 12,
                '尊老爱幼': 15,
                '关心他人': 10,
                '主动打招呼': 5,
                '有礼貌': 8,
                '不说脏话': 10,
                '不欺负弱小': 15,
                '安慰他人': 12,
                '分享零食': 6,
                
                // 创造艺术类 (5-50分)
                '创作作品': 20,
                '画画': 15,
                '手工制作': 18,
                '写作': 25,
                '唱歌': 12,
                '跳舞': 15,
                '弹琴': 20,
                '做手工': 12,
                '摄影': 30,
                '做模型': 25,
                '制作贺卡': 15,
                '参加表演': 35,
                
                // 兴趣爱好类 (5-40分)
                '参加比赛': 30,
                '学习新技能': 25,
                '练习才艺': 20,
                '参加活动': 15,
                '拓展知识': 20,
                '探索新事物': 18,
                '学做菜': 15,
                '学骑车': 10,
                '学游泳': 12,
                '学外语': 25,
                
                // 特殊成就类 (10-50分)
                '连续获得积分': 30,
                '完成目标': 25,
                '帮助家庭': 20,
                '关心环境': 15,
                '节约用水': 10,
                '节约用电': 10,
                '垃圾分类': 12,
                '保护动物': 15,
                '关爱他人': 18,
                '参与公益': 25
            },
            
            // 消费/惩罚类 (2-50分)
            spend: {
                // 奖励兑换类 (5-30分)
                '买玩具': 20,
                '买零食': 10,
                '买文具': 8,
                '买书本': 15,
                '买衣服': 25,
                '买电子产品': 50,
                '买游戏': 30,
                '特殊奖励': 25,
                '去游乐园': 40,
                '看动画片': 5,
                '玩游戏时间': 8,
                '额外零花钱': 15,
                '小礼品': 12,
                
                // 学习消费类 (3-25分)
                '电子书': 8,
                '学习用品': 10,
                '买课程': 35,
                '买软件': 20,
                '买资料': 12,
                '培训费': 50,
                '书籍费用': 15,
                '打印资料': 3,
                
                // 娱乐活动类 (5-40分)
                '娱乐活动': 15,
                '户外活动': 20,
                '看电影': 25,
                '聚餐': 30,
                '买票': 18,
                '参加活动': 22,
                '购买会员': 15,
                '订阅服务': 12,
                '充值': 10,
                
                // 爱心捐赠类 (5-30分)
                '捐款': 20,
                '捐玩具': 15,
                '捐书': 10,
                '爱心活动': 18,
                '帮助他人': 12,
                '慈善捐赠': 25,
                '公益活动': 15,
                
                // 惩罚扣除类 (5-50分)
                '未完成作业': 15,
                '不听话': 10,
                '乱发脾气': 20,
                '撒谎': 25,
                '不诚实': 30,
                '欺负他人': 40,
                '损坏物品': 35,
                '不遵守规则': 15,
                '不按时睡觉': 12,
                '挑食': 8,
                '不整理房间': 10,
                '乱扔东西': 12,
                '不礼貌': 15,
                '说脏话': 18,
                '不尊重他人': 25,
                '浪费食物': 15,
                '不珍惜物品': 20,
                '迟到': 10,
                '早退': 15,
                '不专心': 12,
                '作弊': 50,
                
                // 生活消费类 (3-20分)
                '交通费': 5,
                '餐费': 10,
                '日用品': 8,
                '维修费': 15,
                '医疗费': 20,
                '理发': 6,
                '洗澡用品': 4
            }
        };



        // 预设积分单位库
        const currencyUnits = {
            // 默认主题
            default: [
                { name: '星星', icon: '⭐', color: '#FFD700' },
                { name: '笑脸', icon: '😊', color: '#FF6B6B' },
                { name: '爱心', icon: '❤️', color: '#FF69B4' },
                { name: '花朵', icon: '🌸', color: '#FFB6C1' },
                { name: '糖果', icon: '🍬', color: '#FF1493' },
                { name: '气球', icon: '🎈', color: '#FF6347' },
                { name: '蝴蝶', icon: '🦋', color: '#DA70D6' },
                { name: '小熊', icon: '🧸', color: '#8B4513' },
                { name: '彩虹', icon: '🌈', color: '#FF69B4' },
                { name: '魔法', icon: '✨', color: '#FFD700' }
            ],
            // 彩虹主题
            rainbow: [
                { name: '彩虹碎片', icon: '🌈', color: '#FF69B4' },
                { name: '彩虹糖', icon: '🍭', color: '#FF69B4' },
                { name: '彩色星星', icon: '⭐', color: '#FFD700' },
                { name: '彩色泡泡', icon: '🫧', color: '#87CEEB' },
                { name: '彩色心形', icon: '💖', color: '#FF69B4' },
                { name: '彩虹独角兽', icon: '🦄', color: '#DA70D6' },
                { name: '彩色花朵', icon: '🌺', color: '#FF6347' },
                { name: '彩虹音符', icon: '🎵', color: '#FF69B4' },
                { name: '彩色气球', icon: '🎈', color: '#FFD700' },
                { name: '彩虹蝴蝶', icon: '🦋', color: '#DA70D6' }
            ],
            // 森林主题
            forest: [
                { name: '绿叶', icon: '🍃', color: '#32CD32' },
                { name: '松果', icon: '🌰', color: '#8B4513' },
                { name: '蘑菇', icon: '🍄', color: '#FF6347' },
                { name: '花朵', icon: '🌼', color: '#FFD700' },
                { name: '小草', icon: '🌱', color: '#32CD32' },
                { name: '橡果', icon: '🌰', color: '#8B4513' },
                { name: '蜂巢', icon: '🍯', color: '#FFD700' },
                { name: '蝴蝶', icon: '🦋', color: '#DA70D6' },
                { name: '瓢虫', icon: '🐞', color: '#FF69B4' },
                { name: '蜻蜓', icon: '🦋', color: '#87CEEB' }
            ],
            // 日落主题
            sunset: [
                { name: '太阳', icon: '☀️', color: '#FFD700' },
                { name: '月亮', icon: '🌙', color: '#F0F8FF' },
                { name: '晚霞', icon: '🌅', color: '#FF6347' },
                { name: '星星', icon: '⭐', color: '#FFD700' },
                { name: '云朵', icon: '☁️', color: '#F5F5F5' },
                { name: '小鸟', icon: '🐦', color: '#4682B4' },
                { name: '海浪', icon: '🌊', color: '#4682B4' },
                { name: '沙滩', icon: '🏖️', color: '#F4A460' },
                { name: '椰子', icon: '🥥', color: '#8B4513' },
                { name: '热带鱼', icon: '🐠', color: '#FF6347' }
            ],
            // 海洋主题
            ocean: [
                { name: '海星', icon: '⭐', color: '#FFD700' },
                { name: '贝壳', icon: '🐚', color: '#F5DEB3' },
                { name: '海豚', icon: '🐬', color: '#4682B4' },
                { name: '海马', icon: '🦄', color: '#FF69B4' },
                { name: '珊瑚', icon: '🪸', color: '#FF6347' },
                { name: '珍珠', icon: '💎', color: '#F0F8FF' },
                { name: '小鱼', icon: '🐟', color: '#4682B4' },
                { name: '海龟', icon: '🐢', color: '#32CD32' },
                { name: '章鱼', icon: '🐙', color: '#FF69B4' },
                { name: '珊瑚礁', icon: '🪸', color: '#FF6347' }
            ],
            // 圣诞主题
            christmas: [
                { name: '圣诞树', icon: '🎄', color: '#32CD32' },
                { name: '圣诞老人', icon: '🎅', color: '#FF6B6B' },
                { name: '雪人', icon: '☃️', color: '#FFFFFF' },
                { name: '礼物', icon: '🎁', color: '#FFD700' },
                { name: '铃铛', icon: '🔔', color: '#FFD700' },
                { name: '星星', icon: '⭐', color: '#FFD700' },
                { name: '雪花', icon: '❄️', color: '#87CEEB' },
                { name: '拐棍糖', icon: '🍬', color: '#FF1493' },
                { name: '圣诞袜', icon: '🧦', color: '#FF6B6B' },
                { name: '驯鹿', icon: '🦌', color: '#8B4513' }
            ],
            // 新年主题
            newyear: [
                { name: '烟花', icon: '🎆', color: '#FFD700' },
                { name: '气球', icon: '🎈', color: '#FF69B4' },
                { name: '蛋糕', icon: '🎂', color: '#FFB6C1' },
                { name: '蜡烛', icon: '🕯️', color: '#FFD700' },
                { name: '彩带', icon: '🎗️', color: '#FF69B4' },
                { name: '奖杯', icon: '🏆', color: '#FFD700' },
                { name: '星星', icon: '⭐', color: '#FFD700' },
                { name: '礼品', icon: '🎁', color: '#FF6B6B' },
                { name: '音符', icon: '🎵', color: '#4ECDC4' },
                { name: '彩虹', icon: '🌈', color: '#FF69B4' }
            ]
        };

        // 获取主题对应的积分单位
        function getThemeCurrencies(theme = 'default') {
            return currencyUnits[theme] || currencyUnits.default;
        }



        // 成就定义 - 全面优化
        const achievements = [
            // 入门成就
            { id: 'firstEarn', title: '初次获得', desc: '获得第一个积分', icon: '🎉', category: '入门', difficulty: 'easy' },
            { id: 'firstSpend', title: '首次消费', desc: '第一次使用积分', icon: '💰', category: '入门', difficulty: 'easy' },
            
            // 积分类成就
            { id: 'points25', title: '初出茅庐', desc: '累计获得25积分', icon: '🌱', category: '积分', difficulty: 'easy' },
            { id: 'points50', title: '小有成就', desc: '累计获得50积分', icon: '⭐', category: '积分', difficulty: 'easy' },
            { id: 'points100', title: '百积分达成', desc: '累计获得100积分', icon: '💯', category: '积分', difficulty: 'medium' },
            { id: 'points250', title: '积分达人', desc: '累计获得250积分', icon: '🏅', category: '积分', difficulty: 'medium' },
            { id: 'points500', title: '积分大户', desc: '累计获得500积分', icon: '🏆', category: '积分', difficulty: 'hard' },
            { id: 'points1000', title: '积分王者', desc: '累计获得1000积分', icon: '👑', category: '积分', difficulty: 'expert' },
            
            // 坚持类成就
            { id: 'consistency3', title: '坚持不懈', desc: '连续3天获得积分', icon: '💪', category: '坚持', difficulty: 'easy' },
            { id: 'consistency7', title: '一周坚持', desc: '连续7天获得积分', icon: '📅', category: '坚持', difficulty: 'medium' },
            { id: 'consistency14', title: '两周坚持', desc: '连续14天获得积分', icon: '📆', category: '坚持', difficulty: 'hard' },
            { id: 'consistency30', title: '月度坚持王', desc: '连续30天获得积分', icon: '🏃', category: '坚持', difficulty: 'expert' },
            

            
            // 学习类成就
            { id: 'studyStreak', title: '学习之星', desc: '连续7天因学习获得积分', icon: '📚', category: '学习', difficulty: 'medium' },
            { id: 'homeworkHero', title: '作业英雄', desc: '连续10次因作业获得积分', icon: '✏️', category: '学习', difficulty: 'hard' },
            { id: 'readingChamp', title: '阅读冠军', desc: '连续15天因阅读获得积分', icon: '📖', category: '学习', difficulty: 'hard' },
            
            // 健康类成就
            { id: 'earlyBird', title: '早起鸟儿', desc: '连续5天因早起获得积分', icon: '🌅', category: '健康', difficulty: 'medium' },
            { id: 'exerciseFan', title: '运动达人', desc: '连续7天因运动获得积分', icon: '🏃', category: '健康', difficulty: 'medium' },
            { id: 'healthyEater', title: '健康饮食', desc: '连续10天因健康饮食获得积分', icon: '🥗', category: '健康', difficulty: 'hard' },
            
            // 社交类成就
            { id: 'helper', title: '小帮手', desc: '累计帮助他人10次', icon: '🤝', category: '社交', difficulty: 'medium' },
            { id: 'friend', title: '好朋友', desc: '累计分享玩具10次', icon: '👫', category: '社交', difficulty: 'medium' },
            { id: 'volunteer', title: '小志愿者', desc: '累计做志愿服务5次', icon: '❤️', category: '社交', difficulty: 'hard' },
            
            // 特殊类成就
            { id: 'perfectDay', title: '完美一天', desc: '单日获得50+积分', icon: '🌟', category: '特殊', difficulty: 'medium' },
            { id: 'bigSpender', title: '大买家', desc: '单次消费100+积分', icon: '💳', category: '特殊', difficulty: 'medium' },
            { id: 'collector', title: '收藏家', desc: '兑换所有类型的奖励', icon: '🗂️', category: '特殊', difficulty: 'hard' }
        ];

        // DOM元素引用
        const elements = {};

        function initElements() {
            console.log('开始初始化DOM元素...');
            
            const elementIds = [
                'currentPoints', 'totalEarned', 'totalSpent', 'displayChildName',
                'childNameInput', 'currencyInput', 'passwordInput',
                'addAmount', 'addReason', 'subtractAmount', 'subtractReason',
                'historyList',
                'achievementsGrid', 'achievementCount', 'chartContainer',
                'themeDropdown', 'adminPanel', 'cloudSyncPanel', 'userManagementPanel',
                'adminTotalPoints', 'adminTotalEarned', 'adminTotalSpent', 'adminActivityDays',
                'currencyPreview', 'previewIcon', 'previewName', 'pointsChangeIndicator',
                'dailyQuote', 'quoteContent', 'quoteText', 'quoteAuthor', 'quoteLoading', 'quoteError',
                // 新增的筛选器和统计相关元素
                'dateFilter', 'typeFilter', 'reasonFilter', 'filterStatus',
                'filteredTotalCount', 'filteredEarnedTotal', 'filteredSpentTotal', 'filteredNetGain',
                'earnedCategoryChart', 'spentCategoryChart', 'trendChart', 'monthlyChart',
                // 新增的自定义输入元素
                'customAddReasonGroup', 'customAddReason', 'customSubtractReasonGroup', 'customSubtractReason',
                // 新增的用户相关元素
                'userDropdown', 'currentUserName', 'newUserNameInput', 'newUserCurrencyInput', 'userList'
            ];
            
            elementIds.forEach(id => {
                elements[id] = document.getElementById(id);
                if (!elements[id]) {
                    console.warn(`元素 ${id} 未找到`);
                }
            });
            
            console.log('DOM元素初始化完成');
        }
        
        // 多用户管理功能
        
        // 生成唯一用户ID
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // 获取头像emoji
        function getUserAvatar(name) {
            const avatars = ['😊', '😄', '😁', '🤗', '🥰', '😍', '😎', '🤓', '😇', '😌', '😋', '😉', '🙂', '😺', '🐱', '🦄', '🌟', '🎈', '🎨', '🎭'];
            const hash = name.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            return avatars[Math.abs(hash) % avatars.length];
        }
        
        // 创建用户数据
        function createUserData(name, currency) {
            return {
                id: generateUserId(),
                name: name,
                avatar: getUserAvatar(name),
                data: {
                    currentPoints: 0,
                    totalEarned: 0,
                    totalSpent: 0,
                    lastUpdated: null,
                    history: [],
                    settings: {
                        childName: name,
                        currency: currency || '⭐ 星星',
                        notifications: true,
                        theme: 'default',
                        password: '',
                        passwordEnabled: false
                    },
                    achievements: {
                        firstEarn: false,
                        points50: false,
                        points100: false,
                        points500: false,
                        firstSpend: false,
                        dailyActive: false,
                        consistency3: false
                    }
                },
                createdAt: new Date().toISOString()
            };
        }
        
        // 加载多用户数据
        function loadMultiUserData() {
            try {
                const savedData = localStorage.getItem('multiUserPointsSystem');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    multiUserData = { ...multiUserData, ...parsed };
                    console.log('多用户数据加载成功');
                    
                    // 如果没有当前用户，选择第一个用户
                    if (!multiUserData.currentUserId && Object.keys(multiUserData.users).length > 0) {
                        multiUserData.currentUserId = Object.keys(multiUserData.users)[0];
                    }
                } else {
                    // 初始化第一个用户（迁移现有数据）
                    initializeFirstUser();
                }
            } catch (error) {
                console.error('加载多用户数据失败:', error);
                initializeFirstUser();
            }
        }
        
        // 初始化第一个用户（迁移现有数据）
        function initializeFirstUser() {
            console.log('初始化第一个用户...');
            
            // 尝试加载旧数据
            try {
                const oldData = localStorage.getItem('ultimatePointsSystemFixed');
                if (oldData) {
                    const oldPointsData = JSON.parse(oldData);
                    const firstUser = createUserData(oldPointsData.settings?.childName || '小朋友', oldPointsData.settings?.currency || '⭐ 星星');
                    firstUser.data = oldPointsData;
                    firstUser.name = oldPointsData.settings?.childName || '小朋友';
                    firstUser.avatar = getUserAvatar(firstUser.name);
                    
                    multiUserData.users[firstUser.id] = firstUser;
                    multiUserData.currentUserId = firstUser.id;
                    multiUserData.userCount = 1;
                    
                    console.log('成功迁移现有数据到新用户');
                } else {
                    // 创建默认用户
                    const defaultUser = createUserData('小朋友', '⭐ 星星');
                    multiUserData.users[defaultUser.id] = defaultUser;
                    multiUserData.currentUserId = defaultUser.id;
                    multiUserData.userCount = 1;
                }
            } catch (error) {
                console.error('迁移数据失败:', error);
                // 创建默认用户
                const defaultUser = createUserData('小朋友', '⭐ 星星');
                multiUserData.users[defaultUser.id] = defaultUser;
                multiUserData.currentUserId = defaultUser.id;
                multiUserData.userCount = 1;
            }
            
            saveMultiUserData();
        }
        
        // 保存多用户数据
        function saveMultiUserData() {
            try {
                localStorage.setItem('multiUserPointsSystem', JSON.stringify(multiUserData));
                console.log('多用户数据保存成功');
            } catch (error) {
                console.error('保存多用户数据失败:', error);
                showToast('保存失败，请检查存储空间', 'error');
            }
        }
        
        // 切换用户
        function switchUser(userId) {
            console.log('切换用户到:', userId);
            
            if (!multiUserData.users[userId]) {
                console.error('用户不存在:', userId);
                return;
            }
            
            // 保存当前用户数据
            saveCurrentUserData();
            
            // 切换用户
            multiUserData.currentUserId = userId;
            loadCurrentUserData();
            
            // 更新显示
            updateDisplay();
            renderHistory();
            renderAchievements();
            renderChart();
            
            // 更新用户下拉菜单
            updateUserDropdown();
            
            // 关闭用户切换下拉菜单
            const userDropdown = elements.userDropdown;
            if (userDropdown && userDropdown.classList.contains('show')) {
                userDropdown.classList.remove('show');
            }
            
            saveMultiUserData();
            
            showToast(`已切换到 ${multiUserData.users[userId].name}`);
        }
        
        // 保存当前用户数据
        function saveCurrentUserData() {
            if (multiUserData.currentUserId && multiUserData.users[multiUserData.currentUserId]) {
                multiUserData.users[multiUserData.currentUserId].data = { ...pointsData };
                multiUserData.users[multiUserData.currentUserId].name = pointsData.settings.childName;
                console.log('当前用户数据已保存');
            }
        }
        
        // 加载当前用户数据
        function loadCurrentUserData() {
            if (multiUserData.currentUserId && multiUserData.users[multiUserData.currentUserId]) {
                const userData = multiUserData.users[multiUserData.currentUserId];
                pointsData = { ...userData.data };
                
                // 确保设置对象存在
                if (!pointsData.settings) {
                    pointsData.settings = {
                        childName: '小朋友',
                        currency: '积分',
                        notifications: true,
                        theme: 'default',
                        password: '',
                        passwordEnabled: false
                    };
                }
                
                // 确保必要的数据数组存在
                if (!pointsData.history) {
                    pointsData.history = [];
                }
                if (!pointsData.achievements) {
                    pointsData.achievements = {
                        firstEarn: false,
                        points50: false,
                        points100: false,
                        points500: false,
                        firstSpend: false,
                        dailyActive: false,
                        consistency3: false
                    };
                }
                
                // 确保数值字段存在
                if (typeof pointsData.currentPoints !== 'number') {
                    pointsData.currentPoints = 0;
                }
                if (typeof pointsData.totalEarned !== 'number') {
                    pointsData.totalEarned = 0;
                }
                if (typeof pointsData.totalSpent !== 'number') {
                    pointsData.totalSpent = 0;
                }
                
                console.log('已加载用户数据:', userData.name);
            }
        }
        
        // 添加新用户
        function addNewUser() {
            const name = elements.newUserNameInput.value.trim();
            const currency = elements.newUserCurrencyInput.value;
            
            if (!name) {
                showToast('请输入用户姓名', 'error');
                return;
            }
            
            // 检查姓名是否已存在
            const existingUser = Object.values(multiUserData.users).find(user => user.name === name);
            if (existingUser) {
                showToast('该姓名已存在，请使用其他姓名', 'error');
                return;
            }
            
            const newUser = createUserData(name, currency);
            multiUserData.users[newUser.id] = newUser;
            multiUserData.userCount = Object.keys(multiUserData.users).length;
            
            saveMultiUserData();
            updateUserDropdown();
            renderUserList();
            
            // 清空输入框
            elements.newUserNameInput.value = '';
            
            // 关闭用户管理面板
            closeUserManagementPanel();
            
            // 切换到新添加的用户
            switchUser(newUser.id);
            
            showToast(`用户 "${name}" 添加成功并已切换！`);
        }
        
        // 删除用户
        function deleteUser(userId) {
            const user = multiUserData.users[userId];
            if (!user) return;
            
            if (Object.keys(multiUserData.users).length <= 1) {
                showToast('不能删除最后一个用户', 'error');
                return;
            }
            
            if (confirm(`确定要删除用户 "${user.name}" 吗？\n\n这将永久删除该用户的所有积分、历史记录和成就数据！`)) {
                delete multiUserData.users[userId];
                multiUserData.userCount = Object.keys(multiUserData.users).length;
                
                // 如果删除的是当前用户，切换到第一个用户
                if (multiUserData.currentUserId === userId) {
                    multiUserData.currentUserId = Object.keys(multiUserData.users)[0];
                    loadCurrentUserData();
                    updateDisplay();
                    renderHistory();
                    renderAchievements();
                    renderChart();
                }
                
                saveMultiUserData();
                updateUserDropdown();
                renderUserList();
                
                showToast(`用户 "${user.name}" 已删除`);
            }
        }
        
        // 更新用户下拉菜单
        function updateUserDropdown() {
            const dropdown = elements.userDropdown;
            if (!dropdown) return;
            
            let dropdownHTML = '';
            
            // 生成用户列表
            Object.values(multiUserData.users).forEach(user => {
                const isActive = user.id === multiUserData.currentUserId;
                const userPoints = user.data.currentPoints || 0;
                
                dropdownHTML += `
                    <div class="user-option ${isActive ? 'active' : ''}" onclick="switchUser('${user.id}')">
                        <div class="user-info">
                            <div class="user-avatar">${user.avatar}</div>
                            <div>
                                <div class="user-name">${user.name}</div>
                                <div class="user-points">${userPoints} ${user.data.settings?.currency || '⭐ 星星'}</div>
                            </div>
                        </div>
                        ${isActive ? '<span style="color: white; font-weight: bold;">✓</span>' : ''}
                    </div>
                `;
            });
            
            // 添加操作按钮
            dropdownHTML += `
                <div class="user-actions">
                    <button class="user-action-btn btn-add-user" onclick="openAddUserModal()">➕ 添加用户</button>
                    <button class="user-action-btn btn-manage-users" onclick="openUserManagementPanel()">⚙️ 管理用户</button>
                </div>
            `;
            
            dropdown.innerHTML = dropdownHTML;
            
            // 更新当前用户显示
            if (elements.currentUserName && multiUserData.users[multiUserData.currentUserId]) {
                elements.currentUserName.textContent = multiUserData.users[multiUserData.currentUserId].name;
            }
        }
        
        // 渲染用户管理列表
        function renderUserList() {
            const userList = elements.userList;
            if (!userList) return;
            
            let listHTML = '';
            
            Object.values(multiUserData.users).forEach(user => {
                const isActive = user.id === multiUserData.currentUserId;
                const userPoints = user.data.currentPoints || 0;
                const userHistoryCount = user.data.history?.length || 0;
                
                listHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #dee2e6; border-radius: 12px; margin-bottom: 10px; background: rgba(255, 255, 255, 0.5);">
                        <div style="display: flex; align-items: center;">
                            <div class="user-avatar" style="margin-right: 15px;">${user.avatar}</div>
                            <div>
                                <div style="font-weight: 600; color: var(--theme-text); margin-bottom: 5px;">${user.name} ${isActive ? '<span style="color: #28a745; font-size: 12px;">(当前用户)</span>' : ''}</div>
                                <div style="font-size: 0.85em; color: #6c757d;">
                                    积分: ${userPoints} ${user.data.settings?.currency || '⭐ 星星'} | 
                                    记录: ${userHistoryCount}条 | 
                                    创建: ${new Date(user.createdAt).toLocaleDateString('zh-CN')}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${!isActive ? `
                                <button onclick="switchUser('${user.id}')" style="padding: 6px 12px; background: var(--info-gradient); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">切换</button>
                                <button onclick="deleteUser('${user.id}')" style="padding: 6px 12px; background: var(--danger-gradient); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">删除</button>
                            ` : '<span style="color: #28a745; font-size: 12px; font-weight: 600;">当前用户</span>'}
                        </div>
                    </div>
                `;
            });
            
            userList.innerHTML = listHTML;
        }
        
        // 切换用户下拉菜单
        function toggleUserDropdown() {
            console.log('切换用户下拉菜单');
            const dropdown = elements.userDropdown;
            if (!dropdown) return;
            
            dropdown.classList.toggle('show');
            
            // 如果打开，更新用户列表
            if (dropdown.classList.contains('show')) {
                updateUserDropdown();
            }
        }
        
        // 打开用户管理面板
        function openUserManagementPanel() {
            console.log('打开用户管理面板');
            elements.userManagementPanel.classList.add('show');
            renderUserList();
            
            // 关闭用户下拉菜单
            elements.userDropdown.classList.remove('show');
        }
        
        function closeUserManagementPanel() {
            console.log('关闭用户管理面板');
            elements.userManagementPanel.classList.remove('show');
        }
        
        // 打开添加用户模态框（在这个实现中，直接使用输入框）
        function openAddUserModal() {
            elements.userDropdown.classList.remove('show');
            openUserManagementPanel();
            elements.newUserNameInput.focus();
        }

        // 初始化
        function init() {
            console.log('=== 终极积分系统初始化开始 ===');
            
            try {
                initElements();
                
                // 确保基础数据结构存在
                if (!pointsData.settings) {
                    pointsData.settings = {
                        childName: '小朋友',
                        currency: '积分',
                        notifications: true,
                        theme: 'default',
                        password: '',
                        passwordEnabled: false
                    };
                }
                
                // 初始化多用户系统
                loadMultiUserData();
                loadCurrentUserData();
                
                // 确保当前用户的设置存在
                if (!pointsData.settings) {
                    pointsData.settings = {
                        childName: '小朋友',
                        currency: '积分',
                        notifications: true,
                        theme: 'default',
                        password: '',
                        passwordEnabled: false
                    };
                }
                
                applyTheme();
                updateThemeSelector(); // 初始化主题选择器状态
                updateUserDropdown(); // 初始化用户下拉菜单
                updateDisplay();
                renderHistory(); // 添加历史记录渲染
                initHistoryFilters(); // 初始化历史记录筛选器
                renderAchievements();

                renderChart(); // 添加图表渲染
                bindEvents();
                checkAchievements();
                
                // 初始化每日一言
                initDailyQuote();
                
                // 初始化云同步
                initCloudSync();
                
                console.log('=== 终极积分系统初始化完成 ===');
                const currentUser = multiUserData.users[multiUserData.currentUserId];
                showToast(`🌟 终极积分系统加载完成！当前用户：${currentUser.name}`);
            } catch (error) {
                console.error('初始化失败:', error);
                
                // 尝试错误恢复
                try {
                    // 确保基本数据结构存在
                    if (!pointsData || !pointsData.settings) {
                        pointsData = {
                            currentPoints: 0,
                            totalEarned: 0,
                            totalSpent: 0,
                            lastUpdated: null,
                            history: [],
                            settings: {
                                childName: '小朋友',
                                currency: '积分',
                                notifications: true,
                                theme: 'default',
                                password: '',
                                passwordEnabled: false
                            },
                            achievements: {
                                firstEarn: false,
                                points50: false,
                                points100: false,
                                points500: false,
                                firstSpend: false,
                                dailyActive: false,
                                consistency3: false
                            }
                        };
                    }
                    
                    // 尝试应用默认主题
                    document.body.setAttribute('data-theme', 'default');
                    
                    // 更新显示
                    updateDisplay();
                    
                    showToast('系统部分功能初始化失败，但核心功能正常', 'error');
                } catch (recoveryError) {
                    console.error('错误恢复失败:', recoveryError);
                    showToast('系统初始化失败，请刷新页面', 'error');
                }
            }
        }

        // 主题相关功能
        function toggleThemeDropdown() {
            console.log('切换主题下拉菜单');
            const dropdown = elements.themeDropdown;
            if (!dropdown) return;
            
            dropdown.classList.toggle('show');
        }

        function changeTheme(themeName) {
            console.log('切换主题为:', themeName);
            
            // 确保数据存在
            if (!pointsData || !pointsData.settings) {
                console.warn('pointsData 未初始化，跳过主题切换');
                return;
            }
            
            document.body.setAttribute('data-theme', themeName);
            pointsData.settings.theme = themeName;
            
            // 获取新主题的积分单位
            const themeCurrencies = getThemeCurrencies(themeName);
            const currentCurrency = pointsData.settings.currency;
            
            // 检查当前选择的积分单位是否存在于新主题中
            const currencyExistsInNewTheme = themeCurrencies.some(currency => 
                `${currency.icon} ${currency.name}` === currentCurrency
            );
            
            // 如果当前选择的积分单位不存在于新主题中，使用第一个
            if (!currencyExistsInNewTheme && themeCurrencies.length > 0) {
                pointsData.settings.currency = `${themeCurrencies[0].icon} ${themeCurrencies[0].name}`;
            }
            
            // 更新积分单位选择器
            populateCurrencyOptions();
            
            // 更新主题选择器状态
            updateThemeSelector();
            
            // 更新所有积分单位相关的文本
            updateCurrencyTexts();
            
            saveData();
            
            // 更新主题选项的激活状态
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // 找到并激活当前主题选项
            const themeOptions = document.querySelectorAll('.theme-option');
            let targetIndex = 0;
            switch (themeName) {
                case 'rainbow': targetIndex = 1; break;
                case 'forest': targetIndex = 2; break;
                case 'sunset': targetIndex = 3; break;
                case 'ocean': targetIndex = 4; break;
                case 'christmas': targetIndex = 5; break;
                case 'newyear': targetIndex = 6; break;
                default: targetIndex = 0; break;
            }
            
            if (themeOptions[targetIndex]) {
                themeOptions[targetIndex].classList.add('active');
            }
            
            // 关闭下拉菜单
            elements.themeDropdown.classList.remove('show');
            showToast(`主题已切换为${getThemeName(themeName)}！`);
        }
        
        // 更新主题选择器状态
        function updateThemeSelector() {
            const currentTheme = pointsData.settings.theme || 'default';
            
            // 清除所有激活状态
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // 根据主题名称激活对应选项
            let targetOption;
            switch (currentTheme) {
                case 'rainbow':
                    targetOption = document.querySelector('.theme-option:nth-child(2)');
                    break;
                case 'forest':
                    targetOption = document.querySelector('.theme-option:nth-child(3)');
                    break;
                case 'sunset':
                    targetOption = document.querySelector('.theme-option:nth-child(4)');
                    break;
                case 'ocean':
                    targetOption = document.querySelector('.theme-option:nth-child(5)');
                    break;
                case 'christmas':
                    targetOption = document.querySelector('.theme-option:nth-child(6)');
                    break;
                case 'newyear':
                    targetOption = document.querySelector('.theme-option:nth-child(7)');
                    break;
                default:
                    targetOption = document.querySelector('.theme-option');
                    break;
            }
            
            if (targetOption) {
                targetOption.classList.add('active');
            }
        }

        function getThemeName(theme) {
            const names = {
                'default': '默认',
                'rainbow': '彩虹',
                'forest': '森林',
                'sunset': '日落',
                'ocean': '海洋',
                'christmas': '圣诞',
                'newyear': '新年'
            };
            return names[theme] || '默认';
        }

        function applyTheme() {
            // 确保 pointsData 和 settings 存在
            if (!pointsData || !pointsData.settings) {
                console.warn('pointsData 或 settings 未初始化，使用默认值');
                return;
            }
            
            const theme = pointsData.settings.theme || 'default';
            document.body.setAttribute('data-theme', theme);
            
            // 确保积分单位与主题匹配
            const themeCurrencies = getThemeCurrencies(theme);
            const currentCurrency = pointsData.settings.currency;
            
            // 检查当前选择的积分单位是否存在于主题中
            const currencyExists = themeCurrencies.some(currency => 
                `${currency.icon} ${currency.name}` === currentCurrency
            );
            
            // 如果不存在，使用第一个
            if (!currencyExists && themeCurrencies.length > 0) {
                pointsData.settings.currency = `${themeCurrencies[0].icon} ${themeCurrencies[0].name}`;
            }
        }

        // 从localStorage加载数据（兼容单用户模式）
        function loadData() {
            try {
                const savedData = localStorage.getItem('ultimatePointsSystemFixed');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    pointsData = { ...pointsData, ...parsed };
                    console.log('数据加载成功（单用户模式）');
                }
            } catch (error) {
                console.error('加载数据失败:', error);
            }
        }

        // 保存数据到localStorage（兼容单用户模式）
        function saveData() {
            try {
                // 保存到多用户系统
                saveCurrentUserData();
                saveMultiUserData();
                
                // 保持向后兼容，同时保存到旧格式
                localStorage.setItem('ultimatePointsSystemFixed', JSON.stringify(pointsData));
            } catch (error) {
                console.error('保存数据失败:', error);
                showToast('保存失败，请检查存储空间', 'error');
            }
        }

        // 播放积分变化动画
        function playPointsAnimation(changeType, changeAmount) {
            const pointsElement = elements.currentPoints;
            const indicatorElement = elements.pointsChangeIndicator;
            const pointsArea = document.querySelector('.points-display');
            
            if (!pointsElement || !indicatorElement) return;
            
            if (changeType === 'gain') {
                // 获得积分的动画
                pointsElement.style.animation = 'points-gain 1.5s ease-out, pulse-scale 2s ease-in-out infinite';
                pointsArea.style.animation = 'points-area-glow 1.5s ease-out';
                
                // 显示获得提示
                indicatorElement.textContent = `+${changeAmount} ${pointsData.settings.currency}`;
                indicatorElement.className = 'points-change-indicator gain';
                
            } else if (changeType === 'loss') {
                // 消费积分的动画
                pointsElement.style.animation = 'points-loss 1.5s ease-out, pulse-scale 2s ease-in-out infinite';
                pointsArea.style.animation = 'points-area-shake 0.6s ease-out';
                
                // 显示消费提示
                indicatorElement.textContent = `-${changeAmount} ${pointsData.settings.currency}`;
                indicatorElement.className = 'points-change-indicator loss';
            }
            
            // 显示积分变化提示
            indicatorElement.style.display = 'block';
            
            // 清理临时动画样式，恢复到正常状态
            setTimeout(() => {
                pointsElement.style.animation = 'pulse-scale 2s ease-in-out infinite';
                pointsArea.style.animation = '';
                indicatorElement.style.display = 'none';
            }, 2000);
        }
        
        // 带重试的云同步函数
        async function uploadToCloudWithRetry(retryCount = 3, delay = 1000) {
            for (let attempt = 1; attempt <= retryCount; attempt++) {
                try {
                    cloudSyncLog.addLog(`尝试第${attempt}次上传数据到云端`, 'info');
                    
                    const response = await fetch(`${cloudConfig.serverUrl}/api/upload`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(cloudConfig.apiKey && { 'Authorization': `Bearer ${cloudConfig.apiKey}` })
                        },
                        body: JSON.stringify(pointsData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        cloudSyncLog.addLog(`数据上传成功 (第${attempt}次尝试)`, 'success');
                        return result;
                    } else {
                        throw new Error(result.message || '上传失败');
                    }
                } catch (error) {
                    cloudSyncLog.addLog(`第${attempt}次上传失败: ${error.message}`, 'error');
                    
                    if (attempt === retryCount) {
                        throw error;
                    }
                    
                    // 等待后重试
                    await new Promise(resolve => setTimeout(resolve, delay * attempt));
                }
            }
        }
        
        // 上传数据到云服务器
        async function uploadToCloud() {
            if (!cloudConfig.serverUrl) {
                showToast('请先配置云服务器地址', 'error');
                return;
            }
            
            try {
                const result = await uploadToCloudWithRetry();
                showToast('✅ 数据上传成功！云端已保存您的积分数据');
                return result;
            } catch (error) {
                console.error('云端上传失败:', error);
                cloudSyncLog.addLog(`上传失败: ${error.message}`, 'error');
                showToast('❌ 上传失败: ' + error.message, 'error');
                throw error;
            }
        }
        
        // 检查云服务器连接
        async function checkCloudConnection() {
            const statusElement = document.getElementById('cloudConnectionStatus');
            
            if (!cloudConfig.serverUrl) {
                statusElement.textContent = '未配置服务器地址';
                statusElement.style.background = '#f8f9fa';
                statusElement.style.color = '#6c757d';
                return;
            }
            
            statusElement.textContent = '连接中...';
            statusElement.style.background = '#fff3cd';
            statusElement.style.color = '#856404';
            
            try {
                const response = await fetch(`${cloudConfig.serverUrl}/api/download`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(cloudConfig.apiKey && { 'Authorization': `Bearer ${cloudConfig.apiKey}` })
                    }
                });
                
                if (response.ok) {
                    statusElement.textContent = '✅ 连接正常';
                    statusElement.style.background = '#d1edff';
                    statusElement.style.color = '#0c5460';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                statusElement.textContent = '❌ 连接失败';
                statusElement.style.background = '#f8d7da';
                statusElement.style.color = '#721c24';
            }
        }

        // 积分变化后的自动云同步
        async function autoSyncAfterPointsChange(type, amount, reason) {
            console.log(`触发自动云同步: ${type} ${amount} 积分`);
            
            // 检查是否配置了云服务器
            if (!cloudConfig.serverUrl) {
                console.log('未配置云服务器，跳过自动同步');
                return;
            }
            
            try {
                // 更新云同步状态
                updateCloudSyncStatus('同步中...', 'info');
                
                // 检查连接状态
                await checkCloudConnection();
                
                // 执行云同步
                await uploadToCloud();
                
                // 更新云同步状态为成功
                updateCloudSyncStatus('同步成功', 'success');
                
                console.log('自动云同步成功');
                
                // 3秒后重置状态
                setTimeout(() => {
                    updateCloudSyncStatus('已连接', 'success');
                }, 3000);
                
                // 显示云同步成功的提示（可选）
                if (cloudConfig.autoSync) {
                    showToast('☁️ 数据已自动同步到云端', 'success');
                }
            } catch (error) {
                console.error('自动云同步失败:', error);
                
                // 更新云同步状态为失败
                updateCloudSyncStatus('同步失败', 'error');
                
                // 5秒后重置状态
                setTimeout(() => {
                    checkCloudConnection();
                }, 5000);
                
                // 如果是自动同步失败，不阻塞主要功能
                // 只在手动同步时显示错误
                if (!cloudConfig.autoSync) {
                    throw error;
                }
            }
        }
        
        // 更新云同步状态显示
        function updateCloudSyncStatus(status, type = 'info') {
            const statusElement = document.getElementById('cloudConnectionStatus');
            if (!statusElement) return;
            
            statusElement.textContent = status;
            
            // 根据类型设置样式
            const styles = {
                'success': {
                    background: '#d1edff',
                    color: '#0c5460'
                },
                'error': {
                    background: '#f8d7da',
                    color: '#721c24'
                },
                'info': {
                    background: '#fff3cd',
                    color: '#856404'
                }
            };
            
            const style = styles[type] || styles.info;
            statusElement.style.background = style.background;
            statusElement.style.color = style.color;
        }
        
        // 显示处理中的提示
        function showProcessingToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast processing';
            toast.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <div style="animation: spin 1s linear infinite; margin-right: 10px;">⏳</div>
                    <span>${message}</span>
                </div>
            `;
            
            // 添加旋转动画样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                .toast.processing {
                    background: var(--info-gradient);
                    z-index: 10000;
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(toast);
            
            // 显示动画
            setTimeout(() => toast.classList.add('show'), 100);
            
            return toast;
        }
        
        // 隐藏处理中的提示
        function hideProcessingToast(toast) {
            if (toast && toast.parentNode) {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
        }
        
        // 云同步日志管理
        const cloudSyncLog = {
            logs: [],
            maxLogs: 50,
            
            addLog(message, type = 'info') {
                const log = {
                    timestamp: new Date().toISOString(),
                    message,
                    type
                };
                
                this.logs.unshift(log);
                
                // 限制日志数量
                if (this.logs.length > this.maxLogs) {
                    this.logs = this.logs.slice(0, this.maxLogs);
                }
                
                console.log(`[云同步] ${message}`);
            },
            
            getLogs() {
                return this.logs;
            },
            
            clearLogs() {
                this.logs = [];
            }
        };
        
        // 打开云同步面板
        function openCloudSyncPanel() {
            console.log('打开云同步面板');
            // 填充现有配置
            document.getElementById('serverUrlInput').value = cloudConfig.serverUrl;
            document.getElementById('apiKeyInput').value = cloudConfig.apiKey;
            document.getElementById('syncFrequency').value = cloudConfig.syncFrequency;
            
            // 更新自动同步按钮状态
            const autoSyncToggle = document.getElementById('autoSyncToggle');
            if (cloudConfig.autoSync) {
                autoSyncToggle.textContent = '✅ 已开启';
                autoSyncToggle.style.background = 'var(--success-gradient)';
            } else {
                autoSyncToggle.textContent = '🚫 关闭';
                autoSyncToggle.style.background = 'var(--info-gradient)';
            }
            
            // 检查连接状态
            checkCloudConnection();
            
            // 刷新云同步日志
            refreshCloudLogs();
            
            elements.cloudSyncPanel.classList.add('show');
        }
        
        // 刷新云同步日志
        function refreshCloudLogs() {
            const logsContainer = document.getElementById('cloudSyncLogs');
            if (!logsContainer) return;
            
            const logs = cloudSyncLog.getLogs();
            
            if (logs.length === 0) {
                logsContainer.innerHTML = '<div style="color: #6c757d; text-align: center; padding: 20px;">暂无云同步日志</div>';
                return;
            }
            
            const logsHTML = logs.map(log => {
                const time = new Date(log.timestamp).toLocaleTimeString('zh-CN');
                const typeColors = {
                    'info': '#17a2b8',
                    'success': '#28a745',
                    'error': '#dc3545'
                };
                const typeIcons = {
                    'info': 'ℹ️',
                    'success': '✅',
                    'error': '❌'
                };
                
                return `<div style="margin-bottom: 5px; color: ${typeColors[log.type] || '#6c757d'};">
                    <span style="font-size: 10px; opacity: 0.7;">${time}</span>
                    <span style="margin: 0 8px;">${typeIcons[log.type] || '📝'}</span>
                    <span>${log.message}</span>
                </div>`;
            }).join('');
            
            logsContainer.innerHTML = logsHTML;
            
            // 自动滚动到底部
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
        
        // 清空云同步日志
        function clearCloudLogs() {
            if (confirm('确定要清空所有云同步日志吗？')) {
                cloudSyncLog.clearLogs();
                refreshCloudLogs();
                showToast('云同步日志已清空');
            }
        }
        
        function closeCloudSyncPanel() {
            console.log('关闭云同步面板');
            elements.cloudSyncPanel.classList.remove('show');
        }
        
        // 检查云服务器连接
        async function checkCloudConnection() {
            const statusElement = document.getElementById('cloudConnectionStatus');
            
            if (!cloudConfig.serverUrl) {
                statusElement.textContent = '未配置服务器地址';
                statusElement.style.background = '#f8f9fa';
                statusElement.style.color = '#6c757d';
                return;
            }
            
            statusElement.textContent = '连接中...';
            statusElement.style.background = '#fff3cd';
            statusElement.style.color = '#856404';
            
            try {
                const response = await fetch(`${cloudConfig.serverUrl}/api/download`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(cloudConfig.apiKey && { 'Authorization': `Bearer ${cloudConfig.apiKey}` })
                    }
                });
                
                if (response.ok) {
                    statusElement.textContent = '✅ 连接正常';
                    statusElement.style.background = '#d1edff';
                    statusElement.style.color = '#0c5460';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                statusElement.textContent = '❌ 连接失败';
                statusElement.style.background = '#f8d7da';
                statusElement.style.color = '#721c24';
            }
        }
        

        
        // 从云服务器下载数据
        async function downloadFromCloud() {
            if (!cloudConfig.serverUrl) {
                showToast('请先配置云服务器地址', 'error');
                return;
            }
            
            if (!confirm('⚠️ 下载云端数据将覆盖当前本地数据，确定继续吗？\n\n建议：下载前请先上传本地数据以防数据丢失。')) {
                return;
            }
            
            try {
                showToast('正在从云端下载数据...', 'info');
                
                const response = await fetch(`${cloudConfig.serverUrl}/api/download`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(cloudConfig.apiKey && { 'Authorization': `Bearer ${cloudConfig.apiKey}` })
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const cloudData = result.data;
                    
                    // 验证数据格式
                    if (cloudData && typeof cloudData === 'object' && cloudData.currentPoints !== undefined) {
                        // 备份当前数据
                        const backupData = { ...pointsData };
                        
                        try {
                            // 更新数据
                            pointsData = cloudData;
                            
                                            // 更新界面
                            try {
                                applyTheme();
                            } catch (themeError) {
                                console.error('应用主题失败:', themeError);
                                // 确保至少有默认主题
                                if (pointsData && pointsData.settings) {
                                    pointsData.settings.theme = 'default';
                                    document.body.setAttribute('data-theme', 'default');
                                }
                            }
                            updateDisplay();
                            renderAchievements();
                            renderHistory();
                            saveData();
                            checkAchievements();
                            
                            showToast('✅ 云端数据下载成功！您的数据已同步');
                        } catch (updateError) {
                            // 恢复备份数据
                            pointsData = backupData;
                            throw new Error('数据更新失败: ' + updateError.message);
                        }
                    } else {
                        throw new Error('云端数据格式无效');
                    }
                } else {
                    throw new Error(result.message || '下载失败');
                }
            } catch (error) {
                console.error('云端下载失败:', error);
                showToast('❌ 下载失败: ' + error.message, 'error');
            }
        }
        
        // 查看云端备份历史
        async function viewCloudBackups() {
            if (!cloudConfig.serverUrl) {
                showToast('请先配置云服务器地址', 'error');
                return;
            }
            
            try {
                showToast('正在获取备份列表...', 'info');
                
                const response = await fetch(`${cloudConfig.serverUrl}/api/backup`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(cloudConfig.apiKey && { 'Authorization': `Bearer ${cloudConfig.apiKey}` })
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showBackupHistoryModal(result.backups);
                } else {
                    throw new Error(result.message || '获取备份失败');
                }
            } catch (error) {
                console.error('获取备份失败:', error);
                showToast('❌ 获取备份失败: ' + error.message, 'error');
            }
        }
        
        // 显示备份历史模态框
        function showBackupHistoryModal(backups) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
                z-index: 10000;
            `;
            
            let backupList = '';
            if (backups && backups.length > 0) {
                backupList = backups.map(backup => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; margin-bottom: 5px; border-radius: 8px; background: rgba(248, 249, 250, 0.5);">
                        <div>
                            <div style="font-weight: 600; color: var(--theme-text);">${backup.filename}</div>
                            <div style="font-size: 0.85em; color: #6c757d;">${backup.timestamp}</div>
                        </div>
                        <button onclick="restoreCloudBackup('${backup.filename}')" style="
                            padding: 8px 15px; background: var(--success-gradient); color: white; 
                            border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
                        ">恢复</button>
                    </div>
                `).join('');
            } else {
                backupList = '<div style="text-align: center; color: #6c757d; padding: 20px;">暂无备份记录</div>';
            }
            
            modal.innerHTML = `
                <div style="
                    background: var(--theme-bg); padding: 30px; border-radius: var(--border-radius); 
                    max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
                    box-shadow: var(--card-shadow);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--theme-text); margin: 0;">📋 云端备份历史</h3>
                        <button onclick="closeBackupModal()" style="
                            background: #6c757d; color: white; border: none; border-radius: 50%;
                            width: 30px; height: 30px; cursor: pointer; font-weight: bold;
                        ">✕</button>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 8px; font-size: 0.9em; color: #6c757d;">
                            💡 提示：点击"恢复"可以将备份数据恢复到当前设备，建议恢复前先备份当前数据。
                        </div>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${backupList}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 绑定全局函数
            window.closeBackupModal = () => {
                document.body.removeChild(modal);
                delete window.closeBackupModal;
                delete window.restoreCloudBackup;
            };
            
            window.restoreCloudBackup = async (filename) => {
                if (confirm(`确定要恢复备份 "${filename}" 吗？\n\n这将覆盖当前所有数据，建议先备份当前数据。`)) {
                    await restoreCloudBackupData(filename);
                    window.closeBackupModal();
                }
            };
        }
        
        // 恢复云端备份数据
        async function restoreCloudBackupData(filename) {
            try {
                showToast('正在恢复备份数据...', 'info');
                
                const response = await fetch(`${cloudConfig.serverUrl}/api/restore/${encodeURIComponent(filename)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(cloudConfig.apiKey && { 'Authorization': `Bearer ${cloudConfig.apiKey}` })
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const backupData = result.data;
                    
                    // 备份当前数据
                    const currentBackup = { ...pointsData };
                    
                    try {
                        // 更新数据
                        pointsData = backupData;
                        
                        // 更新界面
                        applyTheme();
                        updateDisplay();
                        renderAchievements();
                        renderHistory();
                        saveData();
                        checkAchievements();
                        
                        showToast('✅ 备份恢复成功！数据已更新到当前版本');
                    } catch (updateError) {
                        // 恢复备份数据
                        pointsData = currentBackup;
                        throw new Error('数据更新失败: ' + updateError.message);
                    }
                } else {
                    throw new Error(result.message || '恢复失败');
                }
            } catch (error) {
                console.error('恢复备份失败:', error);
                showToast('❌ 恢复失败: ' + error.message, 'error');
            }
        }
        
        // 保存云同步设置
        function saveCloudSettings() {
            const serverUrl = document.getElementById('serverUrlInput').value.trim();
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const syncFrequency = document.getElementById('syncFrequency').value;
            
            if (!serverUrl) {
                showToast('请输入云服务器地址', 'error');
                return;
            }
            
            // 验证URL格式
            try {
                new URL(serverUrl);
            } catch (error) {
                showToast('服务器地址格式不正确，请输入完整的URL（如：https://your-domain.com）', 'error');
                return;
            }
            
            // 保存配置
            cloudConfig.serverUrl = serverUrl;
            cloudConfig.apiKey = apiKey;
            cloudConfig.syncFrequency = syncFrequency;
            
            localStorage.setItem('cloudServerUrl', serverUrl);
            localStorage.setItem('cloudApiKey', apiKey);
            localStorage.setItem('cloudSyncFrequency', syncFrequency);
            
            // 检查连接
            checkCloudConnection();
            
            showToast('✅ 云同步设置已保存！');
        }
        
        // 切换自动同步
        function toggleAutoSync() {
            const toggle = document.getElementById('autoSyncToggle');
            cloudConfig.autoSync = !cloudConfig.autoSync;
            
            if (cloudConfig.autoSync) {
                toggle.textContent = '✅ 已开启';
                toggle.style.background = 'var(--success-gradient)';
                localStorage.setItem('cloudAutoSync', 'true');
                startAutoSync();
                showToast('✅ 自动同步已开启');
            } else {
                toggle.textContent = '🚫 关闭';
                toggle.style.background = 'var(--info-gradient)';
                localStorage.setItem('cloudAutoSync', 'false');
                stopAutoSync();
                showToast('🚫 自动同步已关闭');
            }
        }
        
        // 开始自动同步
        function startAutoSync() {
            stopAutoSync(); // 清除之前的定时器
            
            if (!cloudConfig.autoSync || cloudConfig.syncFrequency === 'manual') {
                return;
            }
            
            const intervals = {
                '5min': 5 * 60 * 1000,
                '15min': 15 * 60 * 1000,
                '30min': 30 * 60 * 1000,
                '1hour': 60 * 60 * 1000
            };
            
            const interval = intervals[cloudConfig.syncFrequency];
            if (interval) {
                autoSyncTimer = setInterval(async () => {
                    if (cloudConfig.serverUrl) {
                        try {
                            await uploadToCloud(); // 自动上传
                        } catch (error) {
                            console.error('自动同步失败:', error);
                        }
                    }
                }, interval);
            }
        }
        
        // 停止自动同步
        function stopAutoSync() {
            if (autoSyncTimer) {
                clearInterval(autoSyncTimer);
                autoSyncTimer = null;
            }
        }
        
        // 快捷云同步功能（管理员面板）
        async function quickUploadToCloud() {
            if (!cloudConfig.serverUrl) {
                showToast('请先在云同步面板中配置服务器地址', 'error');
                return;
            }
            
            // 直接调用上传函数
            await uploadToCloud();
        }
        
        async function quickDownloadFromCloud() {
            if (!cloudConfig.serverUrl) {
                showToast('请先在云同步面板中配置服务器地址', 'error');
                return;
            }
            
            // 直接调用下载函数
            await downloadFromCloud();
        }
        
        // 初始化云同步
        function initCloudSync() {
            console.log('初始化云同步功能...');
            
            // 如果启用了自动同步，启动它
            if (cloudConfig.autoSync && cloudConfig.serverUrl) {
                startAutoSync();
            }
            
            // 添加键盘事件优化
            addCloudSyncKeyboardOptimizations();
            
            console.log('云同步初始化完成');
        }
        
        // 云同步键盘事件优化
        function addCloudSyncKeyboardOptimizations() {
            // ESC键关闭云同步面板
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (elements.cloudSyncPanel && elements.cloudSyncPanel.classList.contains('show')) {
                        closeCloudSyncPanel();
                    }
                }
            });
        }
        
        // 更新显示
        function updateDisplay(changeType = null, changeAmount = null) {
            elements.currentPoints.textContent = pointsData.currentPoints;
            elements.totalEarned.textContent = pointsData.totalEarned;
            elements.totalSpent.textContent = pointsData.totalSpent;
            elements.displayChildName.textContent = pointsData.settings.childName;
            elements.childNameInput.value = pointsData.settings.childName;
            
            // 加载密码设置
            if (pointsData.settings.passwordEnabled && pointsData.settings.password) {
                elements.passwordInput.placeholder = '已设置密码，如需修改请重新输入';
                elements.passwordInput.value = '';
            } else {
                elements.passwordInput.placeholder = '请设置消费验证密码';
                elements.passwordInput.value = '';
            }

            // 如果有变化，播放动画
            if (changeType && changeAmount !== null) {
                playPointsAnimation(changeType, changeAmount);
            }

            // 填充积分单位选择器
            populateCurrencyOptions();
            
            // 更新积分单位相关的文本
            updateCurrencyTexts();
        }
        
        // 填充积分单位选择器
        function populateCurrencyOptions() {
            const themeCurrencies = getThemeCurrencies(pointsData.settings.theme);
            const currentCurrency = pointsData.settings.currency;
            
            // 确保当前选择的积分单位存在于主题中
            const validCurrency = themeCurrencies.find(currency => 
                `${currency.icon} ${currency.name}` === currentCurrency
            );
            
            // 如果当前选择的积分单位不存在于当前主题中，使用第一个
            const selectedCurrency = validCurrency || themeCurrencies[0];
            
            // 生成选择器选项
            const optionsHTML = themeCurrencies.map((currency, index) => {
                const selected = `${currency.icon} ${currency.name}` === selectedCurrency ? 'selected' : '';
                return `<option value="${currency.icon} ${currency.name}" ${selected}>
                    ${currency.icon} ${currency.name}
                </option>`;
            }).join('');
            
            elements.currencyInput.innerHTML = optionsHTML;
            
            // 更新预览
            updateCurrencyPreview();
        }
        
        // 更新积分单位预览
        function updateCurrencyPreview() {
            const selectedValue = elements.currencyInput.value;
            if (selectedValue) {
                const [icon, name] = selectedValue.split(' ');
                elements.previewIcon.textContent = icon;
                elements.previewName.textContent = name;
            }
        }
        

        
        // 简单密码加密
        function encryptPassword(password) {
            if (!password) return '';
            // 简单的Base64编码（在实际应用中应该使用更安全的方法）
            return btoa(password);
        }
        
        // 密码验证对话框
        function showPasswordVerificationDialog(amount, reason) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
                    z-index: 10000;
                `;
                
                const remainingAfterSpend = pointsData.currentPoints - amount;
                
                modal.innerHTML = `
                    <div style="
                        background: var(--theme-bg); padding: 30px; border-radius: var(--border-radius);
                        max-width: 400px; width: 90%; text-align: center; box-shadow: var(--card-shadow);
                    ">
                        <h3 style="margin-bottom: 20px; color: var(--theme-text);">🔐 密码验证</h3>
                        <div style="margin-bottom: 20px; color: #6c757d; font-size: 14px;">
                            <div style="margin-bottom: 10px;">
                                <strong>当前余额：</strong>${pointsData.currentPoints} ${pointsData.settings.currency}
                            </div>
                            <div style="margin-bottom: 5px;">
                                消费 ${amount} ${pointsData.settings.currency}<br>
                                原因：${reason}
                            </div>
                            <div style="color: var(--theme-accent); font-weight: 600;">
                                剩余：${remainingAfterSpend} ${pointsData.settings.currency}
                            </div>
                        </div>
                        <input type="password" id="verifyPasswordInput" placeholder="请输入消费密码" 
                               maxlength="8" style="
                            width: 100%; padding: 15px; border: 2px solid #dee2e6; border-radius: 12px;
                            font-size: 16px; margin-bottom: 15px; text-align: center;
                        ">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="cancelPasswordVerification()" style="
                                flex: 1; padding: 15px; border: none; border-radius: 12px;
                                background: #6c757d; color: white; font-weight: 600;
                            ">取消</button>
                            <button onclick="confirmPasswordVerification()" style="
                                flex: 1; padding: 15px; border: none; border-radius: 12px;
                                background: var(--primary-gradient); color: white; font-weight: 600;
                            ">确认</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 绑定全局函数
                window.cancelPasswordVerification = () => {
                    document.body.removeChild(modal);
                    delete window.cancelPasswordVerification;
                    delete window.confirmPasswordVerification;
                    resolve(false);
                };
                
                window.confirmPasswordVerification = () => {
                    const input = document.getElementById('verifyPasswordInput');
                    const inputPassword = input.value;
                    
                    if (!inputPassword) {
                        input.style.borderColor = '#dc3545';
                        input.placeholder = '请输入密码';
                        return;
                    }
                    
                    const savedPassword = pointsData.settings.password;
                    const inputEncrypted = encryptPassword(inputPassword);
                    
                    if (inputEncrypted === savedPassword) {
                        document.body.removeChild(modal);
                        delete window.cancelPasswordVerification;
                        delete window.confirmPasswordVerification;
                        resolve(true);
                    } else {
                        input.style.borderColor = '#dc3545';
                        input.value = '';
                        input.placeholder = '密码错误，请重试';
                        setTimeout(() => {
                            input.style.borderColor = '#dee2e6';
                            input.placeholder = '请输入消费密码';
                        }, 2000);
                    }
                };
                
                // 回车键确认
                setTimeout(() => {
                    const input = document.getElementById('verifyPasswordInput');
                    input.focus();
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            window.confirmPasswordVerification();
                        }
                    });
                }, 100);
            });
        }
        
        // 更新积分单位相关的文本
        function updateCurrencyTexts() {
            const currency = pointsData.settings.currency;
            
            // 更新标签页标题
            const pointsLabel = document.getElementById('pointsLabel');
            if (pointsLabel) {
                pointsLabel.textContent = `当前${currency}`;
            }
            
            // 更新统计标签
            const statLabels = document.querySelectorAll('.stat-label');
            if (statLabels.length >= 2) {
                statLabels[0].textContent = `总获得`;
                statLabels[1].textContent = `总消费`;
            }
            
            // 更新标签页标题
            const historyHeader = document.querySelector('#history h3');
            if (historyHeader) {
                historyHeader.textContent = `📋 ${currency}历史`;
            }
            
            // 更新空历史提示
            const emptyHistory = document.querySelector('.empty-history');
            if (emptyHistory) {
                emptyHistory.textContent = `还没有${currency}记录，快来获得你的第一个${currency}吧！`;
            }
            
            // 更新图表标题
            const chartTitle = document.querySelector('#stats h3');
            if (chartTitle) {
                chartTitle.textContent = `📈 最近7天${currency}趋势`;
            }
            
            // 更新奖励商店标题
            const rewardsTitle = document.querySelector('.rewards-section h3');
            if (rewardsTitle) {
                rewardsTitle.textContent = '🏪 奖励商店';
            }
            
            // 更新控制面板标题
            const addControlTitle = document.querySelector('.controls .control-group:first-child h3');
            if (addControlTitle) {
                addControlTitle.textContent = `🎉 获得${currency}`;
            }
            
            const subtractControlTitle = document.querySelector('.controls .control-group:last-child h3');
            if (subtractControlTitle) {
                subtractControlTitle.textContent = `💰 消费${currency}`;
            }
            
            // 更新输入框标签
            const addAmountLabel = document.querySelector('label[for="addAmount"]');
            if (addAmountLabel) {
                addAmountLabel.textContent = `${currency}数量`;
            }
            
            const subtractAmountLabel = document.querySelector('label[for="subtractAmount"]');
            if (subtractAmountLabel) {
                subtractAmountLabel.textContent = `${currency}数量`;
            }
            
            // 更新按钮文本
            const addButton = document.querySelector('.btn-add');
            if (addButton) {
                addButton.textContent = `🚀 获得${currency}`;
            }
            
            const subtractButton = document.querySelector('.btn-subtract');
            if (subtractButton) {
                subtractButton.textContent = `💸 消费${currency}`;
            }
            
            // 更新奖励兑换按钮文本
            const rewardButtons = document.querySelectorAll('.reward-card button');
            rewardButtons.forEach(button => {
                if (button.textContent.includes('积分不足')) {
                    button.textContent = `${currency}不足`;
                }
            });
        }



        // 添加积分
        async function addPoints() {
            console.log('=== 添加积分功能调用 ===');
            const amount = parseInt(elements.addAmount.value);
            const reason = getActualReason(elements.addReason, elements.customAddReasonGroup, 'earn');

            if (!amount || amount <= 0) {
                showToast('请输入有效的积分数量', 'error');
                return;
            }

            if (!reason) {
                showToast('请选择或输入获得原因', 'error');
                return;
            }

            // 二次确认
            const confirmMessage = `确定要获得 ${amount} ${pointsData.settings.currency} 吗？\n\n原因：${reason}`;
            if (!confirm(confirmMessage)) {
                showToast('已取消操作', 'info');
                return;
            }

            // 显示处理中的提示
            const processingToast = showProcessingToast(`正在获得 ${amount} ${pointsData.settings.currency}...`);

            try {
                pointsData.currentPoints += amount;
                pointsData.totalEarned += amount;
                pointsData.lastUpdated = new Date().toISOString();

                // 添加到历史记录
                addHistoryRecord('earned', amount, reason);

                updateDisplay('gain', amount);
                saveData(); // 这会自动保存到多用户系统
                updateUserDropdown(); // 更新用户下拉菜单显示
                checkAchievements();
                
                // 更新筛选器和统计数据
                populateReasonFilter();
                applyFilters();
                
                // 自动云同步
                await autoSyncAfterPointsChange('获得', amount, reason);
                
                hideProcessingToast(processingToast);
                showToast(`🎉 获得 ${amount} ${pointsData.settings.currency}！`);
            } catch (error) {
                hideProcessingToast(processingToast);
                console.error('添加积分失败:', error);
                showToast('添加积分成功，但云同步失败：' + error.message, 'error');
            }
        }

        // 减少积分
        async function subtractPoints() {
            console.log('=== 减少积分功能调用 ===');
            const amount = parseInt(elements.subtractAmount.value);
            const reason = getActualReason(elements.subtractReason, elements.customSubtractReasonGroup, 'spend');

            if (!amount || amount <= 0) {
                showToast('请输入有效的积分数量', 'error');
                return;
            }

            if (!reason) {
                showToast('请选择或输入消费原因', 'error');
                return;
            }

            if (pointsData.currentPoints < amount) {
                showToast(`${pointsData.settings.currency}不足，无法消费`, 'error');
                return;
            }

            // 检查是否需要密码验证
            if (pointsData.settings.passwordEnabled && pointsData.settings.password) {
                // 显示密码验证对话框
                const passwordValid = await showPasswordVerificationDialog(amount, reason);
                if (!passwordValid) {
                    showToast('密码验证失败，已取消操作', 'error');
                    return;
                }
            }

            // 显示处理中的提示
            const processingToast = showProcessingToast(`正在消费 ${amount} ${pointsData.settings.currency}...`);

            try {
                pointsData.currentPoints -= amount;
                pointsData.totalSpent += amount;
                pointsData.lastUpdated = new Date().toISOString();

                // 添加到历史记录
                addHistoryRecord('spent', amount, reason);

                updateDisplay('loss', amount);
                saveData(); // 这会自动保存到多用户系统
                updateUserDropdown(); // 更新用户下拉菜单显示
                checkAchievements();
                
                // 更新筛选器和统计数据
                populateReasonFilter();
                applyFilters();
                
                // 自动云同步
                await autoSyncAfterPointsChange('消费', amount, reason);
                
                hideProcessingToast(processingToast);
                showToast(`💸 消费 ${amount} ${pointsData.settings.currency}`);
            } catch (error) {
                hideProcessingToast(processingToast);
                console.error('消费积分失败:', error);
                showToast('消费积分成功，但云同步失败：' + error.message, 'error');
            }
        }

        // 添加历史记录
        function addHistoryRecord(type, amount, reason) {
            const record = {
                id: Date.now(),
                type: type,
                amount: amount,
                reason: reason,
                timestamp: new Date().toISOString()
            };

            pointsData.history.unshift(record);

            // 限制历史记录数量（最多保存500条）
            if (pointsData.history.length > 500) {
                pointsData.history = pointsData.history.slice(0, 500);
            }

            renderHistory();
        }

        // 初始化历史记录筛选器
        function initHistoryFilters() {
            populateReasonFilter();
            applyFilters();
        }

        // 填充原因筛选器选项
        function populateReasonFilter() {
            const reasonFilter = elements.reasonFilter;
            const reasons = new Set();
            
            // 收集所有原因
            pointsData.history.forEach(record => {
                reasons.add(record.reason);
            });
            
            // 生成选项HTML
            const optionsHTML = Array.from(reasons)
                .sort()
                .map(reason => `<option value="${reason}">${reason}</option>`)
                .join('');
            
            reasonFilter.innerHTML = '<option value="all">全部原因</option>' + optionsHTML;
        }

        // 应用筛选条件
        function applyFilters() {
            const dateFilter = elements.dateFilter.value;
            const typeFilter = elements.typeFilter.value;
            const reasonFilter = elements.reasonFilter.value;
            
            // 获取筛选后的历史记录
            let filteredHistory = pointsData.history.filter(record => {
                // 时间筛选
                if (dateFilter !== 'all') {
                    const recordDate = new Date(record.timestamp);
                    const now = new Date();
                    const daysDiff = Math.floor((now - recordDate) / (1000 * 60 * 60 * 24));
                    
                    switch (dateFilter) {
                        case 'today':
                            if (daysDiff > 0) return false;
                            break;
                        case 'week':
                            if (daysDiff > 7) return false;
                            break;
                        case 'month':
                            if (daysDiff > 30) return false;
                            break;
                        case '3months':
                            if (daysDiff > 90) return false;
                            break;
                        case '6months':
                            if (daysDiff > 180) return false;
                            break;
                        case 'year':
                            if (daysDiff > 365) return false;
                            break;
                    }
                }
                
                // 类型筛选
                if (typeFilter !== 'all' && record.type !== typeFilter) {
                    return false;
                }
                
                // 原因筛选
                if (reasonFilter !== 'all' && record.reason !== reasonFilter) {
                    return false;
                }
                
                return true;
            });
            
            // 渲染筛选后的历史记录
            renderFilteredHistory(filteredHistory);
            
            // 更新统计信息
            updateFilteredStats(filteredHistory);
            
            // 更新筛选状态
            updateFilterStatus(dateFilter, typeFilter, reasonFilter, filteredHistory.length);
            
            // 更新分析图表
            updateAnalysisCharts(filteredHistory);
        }

        // 渲染筛选后的历史记录
        function renderFilteredHistory(filteredHistory) {
            const historyList = elements.historyList;
            
            if (filteredHistory.length === 0) {
                historyList.innerHTML = '<div class="empty-history">没有符合筛选条件的记录</div>';
                return;
            }

            const historyHTML = filteredHistory.map(record => {
                const date = new Date(record.timestamp);
                const timeString = date.toLocaleString('zh-CN');
                const amountClass = record.type === 'earned' ? 'amount-positive' : 'amount-negative';
                const amountPrefix = record.type === 'earned' ? '+' : '-';
                const icon = record.type === 'earned' ? '🎉' : '💸';
                
                return `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-details">${icon} ${record.reason}</div>
                            <div class="history-time">${timeString}</div>
                        </div>
                        <div class="history-amount ${amountClass}">
                            ${amountPrefix}${record.amount} ${pointsData.settings.currency}
                        </div>
                    </div>
                `;
            }).join('');

            historyList.innerHTML = historyHTML;
        }

        // 更新筛选后的统计信息
        function updateFilteredStats(filteredHistory) {
            const totalCount = filteredHistory.length;
            const earnedTotal = filteredHistory
                .filter(record => record.type === 'earned')
                .reduce((sum, record) => sum + record.amount, 0);
            const spentTotal = filteredHistory
                .filter(record => record.type === 'spent')
                .reduce((sum, record) => sum + record.amount, 0);
            const netGain = earnedTotal - spentTotal;
            
            elements.filteredTotalCount.textContent = totalCount;
            elements.filteredEarnedTotal.textContent = earnedTotal;
            elements.filteredSpentTotal.textContent = spentTotal;
            elements.filteredNetGain.textContent = netGain > 0 ? `+${netGain}` : netGain;
        }

        // 更新筛选状态显示
        function updateFilterStatus(dateFilter, typeFilter, reasonFilter, resultCount) {
            const statusParts = [];
            
            // 构建筛选描述
            if (dateFilter !== 'all') {
                const dateLabels = {
                    'today': '今天',
                    'week': '本周',
                    'month': '本月',
                    '3months': '近3个月',
                    '6months': '近6个月',
                    'year': '今年'
                };
                statusParts.push(dateLabels[dateFilter]);
            }
            
            if (typeFilter !== 'all') {
                const typeLabels = {
                    'earned': '获得积分',
                    'spent': '消费积分'
                };
                statusParts.push(typeLabels[typeFilter]);
            }
            
            if (reasonFilter !== 'all') {
                statusParts.push(reasonFilter);
            }
            
            const statusText = statusParts.length > 0 
                ? `显示 ${statusParts.join(' · ')} 记录 (${resultCount}条)`
                : `显示全部记录 (${resultCount}条)`;
                
            elements.filterStatus.textContent = statusText;
        }

        // 重置筛选条件
        function resetFilters() {
            elements.dateFilter.value = 'all';
            elements.typeFilter.value = 'all';
            elements.reasonFilter.value = 'all';
            applyFilters();
            showToast('筛选条件已重置');
        }

        // 切换分析标签页
        function showAnalysisTab(tabName) {
            // 隐藏所有分析内容
            document.querySelectorAll('.analysis-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有标签的激活状态
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 激活选中的标签页
            document.getElementById(tabName + 'Analysis').classList.add('active');
            event.target.classList.add('active');
            
            // 根据标签页类型更新图表
            const filteredHistory = getCurrentFilteredHistory();
            updateAnalysisCharts(filteredHistory);
        }

        // 获取当前筛选后的历史记录
        function getCurrentFilteredHistory() {
            // 这里需要重新应用当前的筛选条件
            const dateFilter = elements.dateFilter.value;
            const typeFilter = elements.typeFilter.value;
            const reasonFilter = elements.reasonFilter.value;
            
            return pointsData.history.filter(record => {
                // 时间筛选
                if (dateFilter !== 'all') {
                    const recordDate = new Date(record.timestamp);
                    const now = new Date();
                    const daysDiff = Math.floor((now - recordDate) / (1000 * 60 * 60 * 24));
                    
                    switch (dateFilter) {
                        case 'today':
                            if (daysDiff > 0) return false;
                            break;
                        case 'week':
                            if (daysDiff > 7) return false;
                            break;
                        case 'month':
                            if (daysDiff > 30) return false;
                            break;
                        case '3months':
                            if (daysDiff > 90) return false;
                            break;
                        case '6months':
                            if (daysDiff > 180) return false;
                            break;
                        case 'year':
                            if (daysDiff > 365) return false;
                            break;
                    }
                }
                
                // 类型筛选
                if (typeFilter !== 'all' && record.type !== typeFilter) {
                    return false;
                }
                
                // 原因筛选
                if (reasonFilter !== 'all' && record.reason !== reasonFilter) {
                    return false;
                }
                
                return true;
            });
        }

        // 更新分析图表
        function updateAnalysisCharts(filteredHistory) {
            renderCategoryAnalysis(filteredHistory);
            renderTrendAnalysis(filteredHistory);
            renderMonthlyAnalysis(filteredHistory);
        }

        // 渲染类别分析
        function renderCategoryAnalysis(filteredHistory) {
            // 获得原因统计
            const earnedReasons = {};
            filteredHistory
                .filter(record => record.type === 'earned')
                .forEach(record => {
                    earnedReasons[record.reason] = (earnedReasons[record.reason] || 0) + record.amount;
                });
            
            // 消费原因统计
            const spentReasons = {};
            filteredHistory
                .filter(record => record.type === 'spent')
                .forEach(record => {
                    spentReasons[record.reason] = (spentReasons[record.reason] || 0) + record.amount;
                });
            
            // 渲染获得原因饼图
            renderPieChart(elements.earnedCategoryChart, earnedReasons, '获得原因');
            
            // 渲染消费原因饼图
            renderPieChart(elements.spentCategoryChart, spentReasons, '消费原因');
        }

        // 渲染趋势分析
        function renderTrendAnalysis(filteredHistory) {
            // 按日期统计每日净增长
            const dailyStats = {};
            filteredHistory.forEach(record => {
                const date = new Date(record.timestamp).toISOString().split('T')[0];
                if (!dailyStats[date]) {
                    dailyStats[date] = { earned: 0, spent: 0, net: 0 };
                }
                
                if (record.type === 'earned') {
                    dailyStats[date].earned += record.amount;
                } else {
                    dailyStats[date].spent += record.amount;
                }
                
                dailyStats[date].net = dailyStats[date].earned - dailyStats[date].spent;
            });
            
            // 渲染趋势图
            renderLineChart(elements.trendChart, dailyStats);
        }

        // 渲染月度分析
        function renderMonthlyAnalysis(filteredHistory) {
            // 按月统计
            const monthlyStats = {};
            filteredHistory.forEach(record => {
                const date = new Date(record.timestamp);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyStats[monthKey]) {
                    monthlyStats[monthKey] = { earned: 0, spent: 0, net: 0 };
                }
                
                if (record.type === 'earned') {
                    monthlyStats[monthKey].earned += record.amount;
                } else {
                    monthlyStats[monthKey].spent += record.amount;
                }
                
                monthlyStats[monthKey].net = monthlyStats[monthKey].earned - monthlyStats[monthKey].spent;
            });
            
            // 渲染月度柱状图
            renderBarChart(elements.monthlyChart, monthlyStats);
        }

        // 渲染饼图
        function renderPieChart(container, data, title) {
            if (Object.keys(data).length === 0) {
                container.innerHTML = '<div class="chart-empty">暂无数据</div>';
                return;
            }
            
            const total = Object.values(data).reduce((sum, val) => sum + val, 0);
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            
            let html = '<div class="pie-chart">';
            let colorIndex = 0;
            
            Object.entries(data).forEach(([key, value]) => {
                const percentage = Math.round((value / total) * 100);
                const color = colors[colorIndex % colors.length];
                
                html += `
                    <div class="pie-item">
                        <div class="pie-color" style="background: ${color}"></div>
                        <div class="pie-info">
                            <div class="pie-label">${key}</div>
                            <div class="pie-value">${value} (${percentage}%)</div>
                        </div>
                    </div>
                `;
                colorIndex++;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // 渲染折线图
        function renderLineChart(container, data) {
            const entries = Object.entries(data).sort(([a], [b]) => a.localeCompare(b));
            
            if (entries.length === 0) {
                container.innerHTML = '<div class="chart-empty">暂无数据</div>';
                return;
            }
            
            const maxValue = Math.max(...entries.map(([, stats]) => Math.abs(stats.net)));
            const chartHeight = 150;
            
            let html = '<div class="line-chart">';
            entries.forEach(([date, stats]) => {
                const day = new Date(date).getDate();
                const height = maxValue > 0 ? (Math.abs(stats.net) / maxValue) * chartHeight : 0;
                const isPositive = stats.net >= 0;
                const color = isPositive ? '#28a745' : '#dc3545';
                
                html += `
                    <div class="line-item">
                        <div class="line-bar" style="height: ${height}px; background: ${color}"></div>
                        <div class="line-label">${day}</div>
                        <div class="line-value">${stats.net > 0 ? '+' : ''}${stats.net}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // 渲染柱状图
        function renderBarChart(container, data) {
            const entries = Object.entries(data).sort(([a], [b]) => a.localeCompare(b));
            
            if (entries.length === 0) {
                container.innerHTML = '<div class="chart-empty">暂无数据</div>';
                return;
            }
            
            const maxValue = Math.max(...entries.map(([, stats]) => Math.max(stats.earned, stats.spent)));
            const chartHeight = 150;
            
            let html = '<div class="bar-chart">';
            entries.forEach(([month, stats]) => {
                const earnedHeight = maxValue > 0 ? (stats.earned / maxValue) * chartHeight : 0;
                const spentHeight = maxValue > 0 ? (stats.spent / maxValue) * chartHeight : 0;
                const monthName = month.split('-')[1] + '月';
                
                html += `
                    <div class="bar-item">
                        <div class="bar-group">
                            <div class="bar bar-earned" style="height: ${earnedHeight}px" title="获得: ${stats.earned}"></div>
                            <div class="bar bar-spent" style="height: ${spentHeight}px" title="消费: ${stats.spent}"></div>
                        </div>
                        <div class="bar-label">${monthName}</div>
                        <div class="bar-value">${stats.net > 0 ? '+' : ''}${stats.net}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // 渲染历史记录
        function renderHistory() {
            // 直接调用筛选功能，显示全部记录
            elements.dateFilter.value = 'all';
            elements.typeFilter.value = 'all';
            elements.reasonFilter.value = 'all';
            applyFilters();
        }





        // 清空历史记录
        function clearHistory() {
            if (confirm('确定要清空所有历史记录吗？此操作无法撤销。')) {
                pointsData.history = [];
                renderHistory();
                saveData();
                populateReasonFilter();
                applyFilters();
                showToast('历史记录已清空');
            }
        }

        // 检查成就 - 全面优化
        function checkAchievements() {
            let newAchievements = [];
            const now = new Date();
            const today = now.toDateString();
            
            // 初始化成就对象（如果不存在）
            if (!pointsData.achievements) {
                pointsData.achievements = {};
            }
            
            // 入门类成就
            if (!pointsData.achievements.firstEarn && pointsData.totalEarned > 0) {
                pointsData.achievements.firstEarn = true;
                newAchievements.push('firstEarn');
            }
            
            if (!pointsData.achievements.firstSpend && pointsData.totalSpent > 0) {
                pointsData.achievements.firstSpend = true;
                newAchievements.push('firstSpend');
            }
            
            // 积分类成就
            const pointsAchievements = [
                { id: 'points25', threshold: 25 },
                { id: 'points50', threshold: 50 },
                { id: 'points100', threshold: 100 },
                { id: 'points250', threshold: 250 },
                { id: 'points500', threshold: 500 },
                { id: 'points1000', threshold: 1000 }
            ];
            
            pointsAchievements.forEach(achievement => {
                if (!pointsData.achievements[achievement.id] && pointsData.totalEarned >= achievement.threshold) {
                    pointsData.achievements[achievement.id] = true;
                    newAchievements.push(achievement.id);
                }
            });
            
            // 坚持类成就
            const dailyRecords = getDailyRecords();
            const maxStreak = Math.max(...dailyRecords.map(d => d.streak));
            
            const streakAchievements = [
                { id: 'consistency3', streak: 3 },
                { id: 'consistency7', streak: 7 },
                { id: 'consistency14', streak: 14 },
                { id: 'consistency30', streak: 30 }
            ];
            
            streakAchievements.forEach(achievement => {
                if (!pointsData.achievements[achievement.id] && maxStreak >= achievement.streak) {
                    pointsData.achievements[achievement.id] = true;
                    newAchievements.push(achievement.id);
                }
            });
            

            
            // 学习类成就
            const studyRecords = pointsData.history.filter(r => 
                r.type === 'earned' && 
                ['完成作业', '主动学习', '主动阅读', '按时完成作业', '课堂表现好', '考试优秀'].includes(r.reason)
            );
            const studyStreak = calculateStreak(studyRecords.map(r => new Date(r.timestamp).toDateString()));
            
            if (!pointsData.achievements.studyStreak && studyStreak >= 7) {
                pointsData.achievements.studyStreak = true;
                newAchievements.push('studyStreak');
            }
            
            const homeworkCount = studyRecords.filter(r => r.reason === '完成作业' || r.reason === '按时完成作业').length;
            if (!pointsData.achievements.homeworkHero && homeworkCount >= 10) {
                pointsData.achievements.homeworkHero = true;
                newAchievements.push('homeworkHero');
            }
            
            const readingCount = studyRecords.filter(r => r.reason === '主动阅读').length;
            if (!pointsData.achievements.readingChamp && readingCount >= 15) {
                pointsData.achievements.readingChamp = true;
                newAchievements.push('readingChamp');
            }
            
            // 健康类成就
            const healthRecords = pointsData.history.filter(r => 
                r.type === 'earned' && 
                ['早起', '锻炼身体', '健康饮食'].includes(r.reason)
            );
            const healthStreak = calculateStreak(healthRecords.map(r => new Date(r.timestamp).toDateString()));
            
            if (!pointsData.achievements.earlyBird) {
                const earlyBirdDays = pointsData.history.filter(r => 
                    r.type === 'earned' && r.reason === '早起'
                ).map(r => new Date(r.timestamp).toDateString());
                const earlyBirdStreak = calculateStreak([...new Set(earlyBirdDays)]);
                if (earlyBirdStreak >= 5) {
                    pointsData.achievements.earlyBird = true;
                    newAchievements.push('earlyBird');
                }
            }
            
            if (!pointsData.achievements.exerciseFan && healthStreak >= 7) {
                pointsData.achievements.exerciseFan = true;
                newAchievements.push('exerciseFan');
            }
            
            // 社交类成就
            const helpCount = pointsData.history.filter(r => 
                r.type === 'earned' && 
                ['帮助他人', '帮助家务', '帮助同学'].includes(r.reason)
            ).length;
            if (!pointsData.achievements.helper && helpCount >= 10) {
                pointsData.achievements.helper = true;
                newAchievements.push('helper');
            }
            
            const shareCount = pointsData.history.filter(r => 
                r.type === 'earned' && r.reason === '分享玩具'
            ).length;
            if (!pointsData.achievements.friend && shareCount >= 10) {
                pointsData.achievements.friend = true;
                newAchievements.push('friend');
            }
            
            const volunteerCount = pointsData.history.filter(r => 
                r.type === 'earned' && r.reason === '做志愿服务'
            ).length;
            if (!pointsData.achievements.volunteer && volunteerCount >= 5) {
                pointsData.achievements.volunteer = true;
                newAchievements.push('volunteer');
            }
            
            // 特殊类成就
            const todayEarned = pointsData.history
                .filter(r => r.type === 'earned' && new Date(r.timestamp).toDateString() === today)
                .reduce((sum, r) => sum + r.amount, 0);
            if (!pointsData.achievements.perfectDay && todayEarned >= 50) {
                pointsData.achievements.perfectDay = true;
                newAchievements.push('perfectDay');
            }
            
            const maxSpend = Math.max(...pointsData.history.filter(r => r.type === 'spent').map(r => r.amount));
            if (!pointsData.achievements.bigSpender && maxSpend >= 100) {
                pointsData.achievements.bigSpender = true;
                newAchievements.push('bigSpender');
            }
            
            // 显示新获得的成就
            newAchievements.forEach(achievementId => {
                const achievement = achievements.find(a => a.id === achievementId);
                if (achievement) {
                    showAchievementPopup(achievement);
                }
            });

            renderAchievements();
            saveData();
        }
        
        // 获取每日记录
        function getDailyRecords() {
            const dailyMap = new Map();
            
            pointsData.history.forEach(record => {
                const date = new Date(record.timestamp).toDateString();
                if (!dailyMap.has(date)) {
                    dailyMap.set(date, { streak: 0, earned: 0, spent: 0 });
                }
                const day = dailyMap.get(date);
                if (record.type === 'earned') {
                    day.earned += record.amount;
                } else {
                    day.spent += record.amount;
                }
            });
            
            return Array.from(dailyMap.entries()).map(([date, data]) => ({
                date,
                ...data
            }));
        }
        
        // 计算连续天数
        function calculateStreak(dates) {
            if (dates.length === 0) return 0;
            
            dates.sort();
            let streak = 1;
            let maxStreak = 1;
            
            for (let i = 1; i < dates.length; i++) {
                const prevDate = new Date(dates[i-1]);
                const currDate = new Date(dates[i]);
                const diffTime = currDate.getTime() - prevDate.getTime();
                const diffDays = diffTime / (1000 * 3600 * 24);
                
                if (diffDays === 1) {
                    streak++;
                    maxStreak = Math.max(maxStreak, streak);
                } else if (diffDays > 1) {
                    streak = 1;
                }
            }
            
            return maxStreak;
        }

        // 显示成就弹窗
        function showAchievementPopup(achievement) {
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <h4>🏆 成就解锁！</h4>
                <div style="font-size: 2em; margin: 10px 0;">${achievement.icon}</div>
                <div style="font-weight: bold; margin-bottom: 5px;">${achievement.title}</div>
                <div style="opacity: 0.9;">${achievement.desc}</div>
            `;
            document.body.appendChild(popup);
            
            setTimeout(() => popup.remove(), 4000);
        }

        // 渲染成就 - 优化显示
        function renderAchievements() {
            const earnedCount = Object.values(pointsData.achievements).filter(Boolean).length;
            const totalCount = achievements.length;
            
            elements.achievementCount.textContent = `${earnedCount}/${totalCount} 已解锁`;
            
            const achievementsHTML = achievements.map(achievement => {
                const isEarned = pointsData.achievements[achievement.id];
                const difficultyColors = {
                    'easy': '#10b981',
                    'medium': '#f59e0b', 
                    'hard': '#ef4444',
                    'expert': '#8b5cf6'
                };
                const difficultyLabels = {
                    'easy': '简单',
                    'medium': '中等',
                    'hard': '困难',
                    'expert': '专家'
                };
                
                return `
                    <div class="achievement-card ${isEarned ? 'earned' : ''}">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-title">${achievement.title}</div>
                        <div class="achievement-desc">${achievement.desc}</div>
                        <div class="achievement-meta">
                            <span class="achievement-category">${achievement.category}</span>
                            <span class="achievement-difficulty" style="color: ${difficultyColors[achievement.difficulty]}">
                                ${difficultyLabels[achievement.difficulty]}
                            </span>
                        </div>
                        ${isEarned ? '<div class="achievement-earned">✅ 已解锁</div>' : ''}
                    </div>
                `;
            }).join('');
            
            elements.achievementsGrid.innerHTML = achievementsHTML;
        }

        // 切换标签页
        function switchTab(tabName) {
            console.log('切换到标签页:', tabName);
            
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有标签的激活状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 激活选中的标签页
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // 如果切换到统计分析标签页，渲染图表
            if (tabName === 'stats') {
                renderChart();
            }
        }

        // 渲染统计分析图表
        function renderChart() {
            console.log('渲染统计分析图表');
            const chartContainer = elements.chartContainer;
            
            if (!chartContainer) {
                console.warn('图表容器未找到');
                return;
            }
            
            // 获取最近7天的数据
            const weeklyData = getWeeklyData();
            
            if (weeklyData.length === 0) {
                chartContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 3em; margin-bottom: 20px;">📊</div>
                        <div style="font-size: 1.2em; margin-bottom: 10px;">暂无数据</div>
                        <div>开始使用积分系统后，这里将显示您的积分趋势图表</div>
                    </div>
                `;
                return;
            }
            
            // 创建图表HTML
            const chartHTML = createChartHTML(weeklyData);
            chartContainer.innerHTML = chartHTML;
        }
        
        // 获取最近7天的数据
        function getWeeklyData() {
            const now = new Date();
            const weeklyData = [];
            
            // 生成最近7天的日期
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                
                // 计算当天获得的积分
                const dayEarned = pointsData.history
                    .filter(record => {
                        const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                        return record.type === 'earned' && recordDate === dateString;
                    })
                    .reduce((sum, record) => sum + record.amount, 0);
                
                // 计算当天消费的积分
                const daySpent = pointsData.history
                    .filter(record => {
                        const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                        return record.type === 'spent' && recordDate === dateString;
                    })
                    .reduce((sum, record) => sum + record.amount, 0);
                
                weeklyData.push({
                    date: date,
                    dateString: dateString,
                    dayOfWeek: date.toLocaleDateString('zh-CN', { weekday: 'short' }),
                    earned: dayEarned,
                    spent: daySpent,
                    net: dayEarned - daySpent
                });
            }
            
            return weeklyData;
        }
        
        // 创建图表HTML
        function createChartHTML(data) {
            const maxValue = Math.max(...data.map(d => Math.max(d.earned, d.spent)), 10);
            const chartHeight = 300;
            
            let barsHTML = '';
            let labelsHTML = '';
            let statsHTML = '';
            
            data.forEach((day, index) => {
                const earnedHeight = (day.earned / maxValue) * chartHeight;
                const spentHeight = (day.spent / maxValue) * chartHeight;
                const barWidth = 100 / data.length - 2; // 留出间距
                
                barsHTML += `
                    <div style="display: inline-block; width: ${barWidth}%; margin: 0 1%; text-align: center; position: relative;">
                        <div style="height: ${chartHeight}px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center;">
                            <div style="width: 100%; margin-bottom: 2px;">
                                <div style="height: ${earnedHeight}px; background: var(--success-gradient); border-radius: 4px; opacity: 0.8; position: relative;">
                                    ${day.earned > 0 ? `<div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: bold; color: #28a745;">+${day.earned}</div>` : ''}
                                </div>
                            </div>
                            <div style="width: 100%;">
                                <div style="height: ${spentHeight}px; background: var(--danger-gradient); border-radius: 4px; opacity: 0.8; position: relative;">
                                    ${day.spent > 0 ? `<div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: bold; color: #dc3545;">-${day.spent}</div>` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">${day.dayOfWeek}</div>
                    </div>
                `;
            });
            
            // 计算统计数据
            const totalEarned = data.reduce((sum, day) => sum + day.earned, 0);
            const totalSpent = data.reduce((sum, day) => sum + day.spent, 0);
            const activeDays = data.filter(day => day.earned > 0 || day.spent > 0).length;
            const averageEarned = Math.round(totalEarned / 7);
            const averageSpent = Math.round(totalSpent / 7);
            
            statsHTML = `
                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 1.5em; font-weight: bold; color: #28a745;">${totalEarned}</div>
                        <div style="font-size: 0.9em; color: #6c757d;">7天总获得</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;">${totalSpent}</div>
                        <div style="font-size: 0.9em; color: #6c757d;">7天总消费</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">${activeDays}</div>
                        <div style="font-size: 0.9em; color: #6c757d;">活跃天数</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 1.5em; font-weight: bold; color: #17a2b8;">${totalEarned - totalSpent > 0 ? '+' : ''}${totalEarned - totalSpent}</div>
                        <div style="font-size: 0.9em; color: #6c757d;">净增长</div>
                    </div>
                </div>
            `;
            
            return `
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; margin-right: 20px;">
                                <div style="width: 12px; height: 12px; background: var(--success-gradient); border-radius: 2px; margin-right: 8px;"></div>
                                <span style="font-size: 14px; color: #6c757d;">获得积分</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div style="width: 12px; height: 12px; background: var(--danger-gradient); border-radius: 2px; margin-right: 8px;"></div>
                                <span style="font-size: 14px; color: #6c757d;">消费积分</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: end; height: ${chartHeight + 40}px; background: #f8f9fa; border-radius: 8px; padding: 20px; overflow-x: auto;">
                            ${barsHTML}
                        </div>
                    </div>
                    ${statsHTML}
                </div>
            `;
        }

        // 家长控制面板
        function openAdminPanel() {
            console.log('打开家长控制面板');
            updateAdminStats();
            elements.adminPanel.classList.add('show');
        }

        function closeAdminPanel() {
            console.log('关闭家长控制面板');
            elements.adminPanel.classList.remove('show');
        }

        function updateAdminStats() {
            elements.adminTotalPoints.textContent = pointsData.currentPoints;
            elements.adminTotalEarned.textContent = pointsData.totalEarned;
            elements.adminTotalSpent.textContent = pointsData.totalSpent;
            
            // 计算活跃天数
            const uniqueDays = new Set();
            pointsData.history.forEach(record => {
                const date = new Date(record.timestamp).toDateString();
                uniqueDays.add(date);
            });
            elements.adminActivityDays.textContent = uniqueDays.size;
        }

        function resetAllData() {
            if (confirm('确定要重置所有数据吗？这将清空所有积分、历史记录和成就！此操作无法撤销！')) {
                if (confirm('请再次确认：这将永久删除所有数据！')) {
                    pointsData = {
                        currentPoints: 0,
                        totalEarned: 0,
                        totalSpent: 0,
                        lastUpdated: null,
                        history: [],
                        settings: {
                            childName: '小朋友',
                            currency: '积分',
                            notifications: true,
                            theme: pointsData.settings.theme || 'default'
                        },
                        achievements: {
                            firstEarn: false,
                            points50: false,
                            points100: false,
                            points500: false,
                            firstSpend: false,
                            dailyActive: false,
                            consistency3: false,
                            goalAchiever: false
                        }
                    };
                    
                    updateDisplay();
                    renderHistory();
                    renderAchievements();
                    saveData();
                    
                    closeAdminPanel();
                    showToast('所有数据已重置');
                }
            }
        }

        function generateReport() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    currentPoints: pointsData.currentPoints,
                    totalEarned: pointsData.totalEarned,
                    totalSpent: pointsData.totalSpent,
                    activityDays: new Set(pointsData.history.map(r => new Date(r.timestamp).toDateString())).size
                },
                achievements: pointsData.achievements,
                settings: pointsData.settings,
                recentHistory: pointsData.history.slice(0, 50) // 最近50条记录
            };
            
            const dataStr = JSON.stringify(report, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `积分系统详细报告_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showToast('详细报告已生成并下载！');
        }

        // 保存设置
        function saveSettings() {
            const newName = elements.childNameInput.value.trim();
            const newCurrency = elements.currencyInput.value;
            const password = elements.passwordInput.value.trim();

            if (!newName) {
                showToast('请输入姓名', 'error');
                return;
            }

            if (!newCurrency) {
                showToast('请选择积分单位', 'error');
                return;
            }

            // 处理密码设置
            if (password) {
                if (password.length < 4 || password.length > 8) {
                    showToast('密码长度必须为4-8位', 'error');
                    return;
                }
                
                // 验证密码格式（数字或字母）
                const passwordRegex = /^[a-zA-Z0-9]+$/;
                if (!passwordRegex.test(password)) {
                    showToast('密码只能包含数字和字母', 'error');
                    return;
                }
                
                pointsData.settings.password = encryptPassword(password);
                pointsData.settings.passwordEnabled = true;
                
                // 清空密码输入框
                elements.passwordInput.value = '';
                
                showToast('密码设置成功！🎉');
            } else if (pointsData.settings.passwordEnabled) {
                // 如果已经设置了密码，但用户没有输入新密码，保持原密码
                showToast('设置已保存！🔐');
            } else {
                // 如果没有设置密码，保持无密码状态
                pointsData.settings.password = '';
                pointsData.settings.passwordEnabled = false;
                showToast('设置已保存！🎉');
            }

            pointsData.settings.childName = newName;
            pointsData.settings.currency = newCurrency;
            
            // 更新当前用户信息
            if (multiUserData.currentUserId && multiUserData.users[multiUserData.currentUserId]) {
                multiUserData.users[multiUserData.currentUserId].name = newName;
                multiUserData.users[multiUserData.currentUserId].avatar = getUserAvatar(newName);
            }
            
            updateDisplay(); // 这个函数现在会调用updateCurrencyTexts()
            updateUserDropdown(); // 更新用户下拉菜单
            saveData(); // 这会自动保存到多用户系统
        }

        // 显示提示消息
        function showToast(message, type = 'success') {
            // 移除现有的toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // 创建新的toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // 显示动画
            setTimeout(() => toast.classList.add('show'), 100);

            // 自动隐藏
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }



        // 本地一言数据库
        const localQuotes = [
            { text: '今天也要加油哦！每天都是新的开始！', author: '小助手' },
            { text: '成功源于坚持，梦想源于努力。', author: '励志名言' },
            { text: '每一份努力都值得被看见，每一份坚持都值得被尊重。', author: '成长寄语' },
            { text: '不怕路远，就怕志短；不怕缓慢，就怕常站。', author: '成语格言' },
            { text: '学习是一种态度，坚持是一种品格。', author: '教育理念' },
            { text: '你的努力，终将美好。', author: '正能量语录' },
            { text: '今天的你，比昨天更优秀了吗？', author: '自我激励' },
            { text: '每一次进步，都是成长的足迹。', author: '成长感悟' },
            { text: '梦想不会自动成真，但努力可以改变现状。', author: '奋斗精神' },
            { text: '书山有路勤为径，学海无涯苦作舟。', author: '古代名言' },
            { text: '宝剑锋从磨砺出，梅花香自苦寒来。', author: '励志古诗' },
            { text: '千里之行，始于足下。', author: '老子' },
            { text: '天行健，君子以自强不息。', author: '周易' },
            { text: '学而时习之，不亦说乎？', author: '孔子' },
            { text: '三人行，必有我师焉。', author: '孔子' },
            { text: '知之者不如好之者，好之者不如乐之者。', author: '孔子' },
            { text: '学而不思则罔，思而不学则殆。', author: '孔子' },
            { text: '温故而知新，可以为师矣。', author: '孔子' },
            { text: '读书破万卷，下笔如有神。', author: '杜甫' },
            { text: '少壮不努力，老大徒伤悲。', author: '长歌行' },
            { text: '一寸光阴一寸金，寸金难买寸光阴。', author: '增广贤文' },
            { text: '黑发不知勤学早，白首方悔读书迟。', author: '颜真卿' },
            { text: '业精于勤，荒于嬉。', author: '韩愈' },
            { text: '玉不琢，不成器；人不学，不知道。', author: '礼记' },
            { text: '博学之，审问之，慎思之，明辨之，笃行之。', author: '礼记' },
            { text: '知人者智，自知者明。', author: '老子' },
            { text: '己所不欲，勿施于人。', author: '论语' },
            { text: '见贤思齐焉，见不贤而内自省也。', author: '论语' },
            { text: '君子坦荡荡，小人长戚戚。', author: '论语' },
            { text: '学而不厌，诲人不倦。', author: '论语' },
            { text: '兴趣是最好的老师。', author: '爱因斯坦' },
            { text: '想象力比知识更重要。', author: '爱因斯坦' },
            { text: '成功是1%的灵感加上99%的汗水。', author: '爱迪生' },
            { text: '失败是成功之母。', author: '谚语' },
            { text: '坚持就是胜利。', author: '谚语' },
            { text: '只要功夫深，铁杵磨成针。', author: '谚语' },
            { text: '水滴石穿，绳锯木断。', author: '谚语' },
            { text: '只要功夫深，铁杵磨成针。', author: '李白' },
            { text: '山重水复疑无路，柳暗花明又一村。', author: '陆游' },
            { text: '会当凌绝顶，一览众山小。', author: '杜甫' },
            { text: '不畏浮云遮望眼，自缘身在最高层。', author: '王安石' },
            { text: '天生我材必有用，千金散尽还复来。', author: '李白' },
            { text: '长风破浪会有时，直挂云帆济沧海。', author: '李白' },
            { text: '千淘万漉虽辛苦，吹尽狂沙始到金。', author: '刘禹锡' },
            { text: '欲穷千里目，更上一层楼。', author: '王之涣' },
            { text: '会挽雕弓如满月，西北望，射天狼。', author: '苏轼' },
            { text: '老骥伏枥，志在千里。', author: '曹操' },
            { text: '路漫漫其修远兮，吾将上下而求索。', author: '屈原' },
            { text: '天生我材必有用，千金散尽还复来。', author: '李白' },
            { text: '长风破浪会有时，直挂云帆济沧海。', author: '李白' },
            { text: '人生得意须尽欢，莫使金樽空对月。', author: '李白' },
            { text: '仰天大笑出门去，我辈岂是蓬蒿人。', author: '李白' },
            { text: '不飞则已，一飞冲天；不鸣则已，一鸣惊人。', author: '史记' },
            { text: '志不立，天下无可成之事。', author: '王阳明' },
            { text: '学如逆水行舟，不进则退。', author: '增广贤文' },
            { text: '非学无以广才，非志无以成学。', author: '诸葛亮' },
            { text: '三更灯火五更鸡，正是男儿读书时。', author: '颜真卿' },
            { text: '莫愁前路无知己，天下谁人不识君。', author: '高适' },
            { text: '海内存知己，天涯若比邻。', author: '王勃' },
            { text: '桃花潭水深千尺，不及汪伦送我情。', author: '李白' },
            { text: '洛阳亲友如相问，一片冰心在玉壶。', author: '王昌龄' },
            { text: '劝君更尽一杯酒，西出阳关无故人。', author: '王维' },
            { text: '独在异乡为异客，每逢佳节倍思亲。', author: '王维' },
            { text: '但愿人长久，千里共婵娟。', author: '苏轼' },
            { text: '明月几时有，把酒问青天。', author: '苏轼' },
            { text: '人有悲欢离合，月有阴晴圆缺。', author: '苏轼' },
            { text: '春眠不觉晓，处处闻啼鸟。', author: '孟浩然' },
            { text: '春江潮水连海平，海上明月共潮生。', author: '张若虚' },
            { text: '日出江花红胜火，春来江水绿如蓝。', author: '白居易' },
            { text: '竹外桃花三两枝，春江水暖鸭先知。', author: '苏轼' },
            { text: '接天莲叶无穷碧，映日荷花别样红。', author: '杨万里' },
            { text: '秋风萧瑟，洪波涌起。', author: '曹操' },
            { text: '忽如一夜春风来，千树万树梨花开。', author: '岑参' },
            { text: '千里冰封，万里雪飘。', author: '毛泽东' },
            { text: '墙角数枝梅，凌寒独自开。', author: '王安石' },
            { text: '待到秋来九月八，我花开后百花杀。', author: '黄巢' },
            { text: '野火烧不尽，春风吹又生。', author: '白居易' },
            { text: '春色满园关不住，一枝红杏出墙来。', author: '叶绍翁' },
            { text: '等闲识得东风面，万紫千红总是春。', author: '朱熹' },
            { text: '两个黄鹂鸣翠柳，一行白鹭上青天。', author: '杜甫' },
            { text: '落霞与孤鹜齐飞，秋水共长天一色。', author: '王勃' },
            { text: '山重水复疑无路，柳暗花明又一村。', author: '陆游' },
            { text: '夕阳无限好，只是近黄昏。', author: '李商隐' },
            { text: '大漠孤烟直，长河落日圆。', author: '王维' },
            { text: '黄河远上白云间，一片孤城万仞山。', author: '王之涣' },
            { text: '长江后浪推前浪，浮事新人换旧人。', author: '谚语' },
            { text: '海阔凭鱼跃，天高任鸟飞。', author: '谚语' },
            { text: '山高月小，水落石出。', author: '苏轼' },
            { text: '会当凌绝顶，一览众山小。', author: '杜甫' },
            { text: '不畏浮云遮望眼，自缘身在最高层。', author: '王安石' },
            { text: '千淘万漉虽辛苦，吹尽狂沙始到金。', author: '刘禹锡' },
            { text: '山重水复疑无路，柳暗花明又一村。', author: '陆游' },
            { text: '宝剑锋从磨砺出，梅花香自苦寒来。', author: '谚语' },
            { text: '只要功夫深，铁杵磨成针。', author: '谚语' },
            { text: '水滴石穿，绳锯木断。', author: '谚语' },
            { text: '锲而舍之，朽木不折；锲而不舍，金石可镂。', author: '荀子' },
            { text: '绳锯木断，水滴石穿。', author: '谚语' },
            { text: '冰冻三尺，非一日之寒。', author: '谚语' },
            { text: '台上一分钟，台下十年功。', author: '谚语' },
            { text: '冰冻三尺，非一日之寒。', author: '谚语' },
            { text: '一日不读口生，一日不写手生。', author: '谚语' },
            { text: '读书百遍，其义自见。', author: '三国志' },
            { text: '学而时习之，不亦说乎？', author: '论语' },
            { text: '温故而知新，可以为师矣。', author: '论语' },
            { text: '学而不思则罔，思而不学则殆。', author: '论语' },
            { text: '知之者不如好之者，好之者不如乐之者。', author: '论语' },
            { text: '三人行，必有我师焉。', author: '论语' },
            { text: '己所不欲，勿施于人。', author: '论语' },
            { text: '见贤思齐焉，见不贤而内自省也。', author: '论语' },
            { text: '君子坦荡荡，小人长戚戚。', author: '论语' },
            { text: '学而不厌，诲人不倦。', author: '论语' },
            { text: '志于道，据于德，依于仁，游于艺。', author: '论语' },
            { text: '敏而好学，不耻下问。', author: '论语' },
            { text: '博学而笃行，切问而近思。', author: '论语' },
            { text: '三军可夺帅也，匹夫不可夺志也。', author: '论语' },
            { text: '岁寒，然后知松柏之后凋也。', author: '论语' },
            { text: '君子喻于义，小人喻于利。', author: '论语' },
            { text: '君子和而不同，小人同而不和。', author: '论语' },
            { text: '君子成人之美，不成人之恶。', author: '论语' },
            { text: '君子以文会友，以友辅仁。', author: '论语' },
            { text: '巧言令色，鲜矣仁。', author: '论语' },
            { text: '人而无信，不知其可也。', author: '论语' },
            { text: '德不孤，必有邻。', author: '论语' },
            { text: '工欲善其事，必先利其器。', author: '论语' },
            { text: '见义不为，无勇也。', author: '论语' },
            { text: '士为知己者死，女为悦己者容。', author: '史记' },
            { text: '燕雀安知鸿鹄之志哉！', author: '史记' },
            { text: '人固有一死，或重于泰山，或轻于鸿毛。', author: '史记' },
            { text: '究天人之际，通古今之变，成一家之言。', author: '史记' },
            { text: '运筹帷幄，决胜千里之外。', author: '史记' },
            { text: '大行不顾细谨，大礼不辞小让。', author: '史记' },
            { text: '人为刀俎，我为鱼肉。', author: '史记' },
            { text: '项庄舞剑，意在沛公。', author: '史记' },
            { text: '智者千虑，必有一失；愚者千虑，必有一得。', author: '史记' },
            { text: '桃李满天下，何用堂前更种花。', author: '白居易' },
            { text: '春蚕到死丝方尽，蜡炬成灰泪始干。', author: '李商隐' },
            { text: '落红不是无情物，化作春泥更护花。', author: '龚自珍' },
            { text: '采得百花成蜜后，为谁辛苦为谁甜。', author: '罗隐' },
            { text: '随风潜入夜，润物细无声。', author: '杜甫' },
            { text: '十年树木，百年树人。', author: '管子' },
            { text: '师者，所以传道受业解惑也。', author: '韩愈' },
            { text: '一日为师，终身为父。', author: '谚语' },
            { text: '经师易得，人师难求。', author: '司马光' },
            { text: '青，取之于蓝，而青于蓝。', author: '荀子' },
            { text: '弟子不必不如师，师不必贤于弟子。', author: '韩愈' },
            { text: '学贵得师，亦贵得友。', author: '唐甄' },
            { text: '师道既尊，学风自善。', author: '康有为' },
            { text: '善之本在教，教之本在师。', author: '李觏' },
            { text: '师者，人之模范也。', author: '杨雄' },
            { text: '学高为师，身正为范。', author: '陶行知' },
            { text: '身教重于言教。', author: '谚语' },
            { text: '其身正，不令而行；其身不正，虽令不从。', author: '论语' },
            { text: '己不正，焉能正人。', author: '论语' },
            { text: '欲正人，先正己。', author: '谚语' },
            { text: '其身正，不令而行。', author: '论语' },
            { text: '桃李不言，下自成蹊。', author: '史记' },
            { text: '学而时习之，不亦说乎？', author: '论语' },
            { text: '温故而知新，可以为师矣。', author: '论语' },
            { text: '学而不思则罔，思而不学则殆。', author: '论语' },
            { text: '知之者不如好之者，好之者不如乐之者。', author: '论语' },
            { text: '三人行，必有我师焉。', author: '论语' },
            { text: '己所不欲，勿施于人。', author: '论语' },
            { text: '见贤思齐焉，见不贤而内自省也。', author: '论语' },
            { text: '君子坦荡荡，小人长戚戚。', author: '论语' },
            { text: '学而不厌，诲人不倦。', author: '论语' }
        ];

        // 每日一言功能
        function initDailyQuote() {
            console.log('初始化随机一言功能...');
            
            // 显示加载状态
            showQuoteLoading();
            
            // 直接获取新的一言
            fetchDailyQuote();
        }
        
        function showQuoteLoading() {
            elements.quoteLoading.style.display = 'block';
            elements.quoteContent.style.display = 'none';
            elements.quoteError.style.display = 'none';
        }
        
        function showQuoteError() {
            elements.quoteLoading.style.display = 'none';
            elements.quoteContent.style.display = 'none';
            elements.quoteError.style.display = 'block';
        }
        
        function showQuoteContent() {
            elements.quoteLoading.style.display = 'none';
            elements.quoteContent.style.display = 'block';
            elements.quoteError.style.display = 'none';
        }
        
        function loadCachedQuote() {
            try {
                const cached = localStorage.getItem('dailyQuote');
                if (!cached) return null;
                
                const quoteData = JSON.parse(cached);
                const cacheDate = new Date(quoteData.timestamp);
                const today = new Date();
                
                // 检查是否为同一天
                if (cacheDate.toDateString() === today.toDateString()) {
                    console.log('使用缓存的每日一言');
                    return quoteData;
                }
                
                // 缓存过期，删除
                localStorage.removeItem('dailyQuote');
                return null;
            } catch (error) {
                console.error('读取缓存一言失败:', error);
                localStorage.removeItem('dailyQuote');
                return null;
            }
        }
        
        function saveQuoteToCache(quoteData) {
            try {
                const cacheData = {
                    ...quoteData,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('dailyQuote', JSON.stringify(cacheData));
                console.log('一言已缓存');
            } catch (error) {
                console.error('缓存一言失败:', error);
            }
        }
        
        function fetchDailyQuote() {
            console.log('获取随机一言...');
            
            try {
                // 使用真正的随机选择，每次都获取不同的一言
                const quoteIndex = Math.floor(Math.random() * localQuotes.length);
                
                // 获取一言
                const selectedQuote = localQuotes[quoteIndex];
                
                const quoteData = {
                    text: selectedQuote.text,
                    author: selectedQuote.author,
                    type: 'random'
                };
                
                console.log('获取随机一言成功:', quoteData);
                
                updateDailyQuoteDisplay(quoteData);
                // 移除缓存逻辑，让每次访问都获取新的一言
                // saveQuoteToCache(quoteData);
                
            } catch (error) {
                console.error('获取本地一言失败:', error);
                showQuoteError();
                
                // 使用默认一言作为降级
                const fallbackQuote = {
                    text: '今天也要加油哦！每天都是新的开始！',
                    author: '小助手',
                    type: 'fallback'
                };
                updateDailyQuoteDisplay(fallbackQuote);
            }
        }
        
        function updateDailyQuoteDisplay(quoteData) {
            if (!elements.quoteText || !elements.quoteAuthor) {
                console.error('一言元素未找到');
                return;
            }
            
            elements.quoteText.textContent = quoteData.text;
            elements.quoteAuthor.textContent = quoteData.author;
            showQuoteContent();
            
            console.log('每日一言已更新:', quoteData);
        }

        // 自动设置积分数量
        function autoSetPointsAmount(reason, type) {
            if (type === 'earn') {
                const config = pointsConfig.earn;
                const suggestedPoints = config[reason] || 10;
                elements.addAmount.value = suggestedPoints;
                
                // 添加视觉提示
                showPointsSuggestion('addAmount', suggestedPoints, '获得');
            } else if (type === 'spend') {
                const config = pointsConfig.spend;
                const suggestedPoints = config[reason] || 5;
                elements.subtractAmount.value = suggestedPoints;
                
                // 添加视觉提示
                showPointsSuggestion('subtractAmount', suggestedPoints, '消费');
            }
        }
        
        // 显示/隐藏自定义输入框
        function toggleCustomInput(reasonSelect, customInputGroup, type) {
            const selectedValue = reasonSelect.value;
            
            if (selectedValue === '__CUSTOM_INPUT__') {
                // 显示自定义输入框
                customInputGroup.style.display = 'block';
                // 聚焦到输入框
                setTimeout(() => {
                    const input = customInputGroup.querySelector('input');
                    if (input) input.focus();
                }, 100);
                
                // 为自定义输入设置默认积分数量
                if (type === 'earn') {
                    elements.addAmount.value = 10;
                    showPointsSuggestion('addAmount', 10, '获得');
                } else if (type === 'spend') {
                    elements.subtractAmount.value = 5;
                    showPointsSuggestion('subtractAmount', 5, '消费');
                }
            } else {
                // 隐藏自定义输入框
                customInputGroup.style.display = 'none';
                
                // 如果不是自定义输入，恢复自动设置积分数量
                if (selectedValue && selectedValue !== '其他') {
                    autoSetPointsAmount(selectedValue, type);
                }
            }
        }
        
        // 获取实际的原因文本（处理自定义输入）
        function getActualReason(reasonSelect, customInputGroup, type) {
            const selectedValue = reasonSelect.value;
            
            if (selectedValue === '__CUSTOM_INPUT__') {
                const customInput = customInputGroup.querySelector('input');
                const customReason = customInput.value.trim();
                
                if (!customReason) {
                    return null; // 返回null表示需要验证
                }
                
                return customReason;
            }
            
            return selectedValue;
        }
        
        // 显示积分建议提示
        function showPointsSuggestion(inputId, points, type) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            // 创建提示元素
            const existingTip = document.getElementById(`${inputId}_tip`);
            if (existingTip) {
                existingTip.remove();
            }
            
            const tip = document.createElement('div');
            tip.id = `${inputId}_tip`;
            tip.style.cssText = `
                position: absolute;
                top: -25px;
                right: 0;
                background: var(--info-gradient);
                color: white;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
                z-index: 1000;
                animation: fadeIn 0.3s ease;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            `;
            tip.textContent = `系统建议: ${points}分`;
            
            // 包装输入框
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.style.display = 'inline-block';
            
            input.parentNode.insertBefore(wrapper, input);
            wrapper.appendChild(input);
            wrapper.appendChild(tip);
            
            // 3秒后自动移除提示
            setTimeout(() => {
                if (tip.parentNode) {
                    tip.remove();
                }
            }, 3000);
        }
        
        // 绑定事件
        function bindEvents() {
            console.log('开始绑定事件');
            
            try {
                // 获得原因变化时自动设置积分数量
                if (elements.addReason) {
                    elements.addReason.addEventListener('change', (e) => {
                        const reason = e.target.value;
                        if (reason === '__CUSTOM_INPUT__') {
                            // 显示自定义输入框
                            toggleCustomInput(elements.addReason, elements.customAddReasonGroup, 'earn');
                        } else if (reason && reason !== '其他') {
                            // 隐藏自定义输入框并自动设置积分数量
                            toggleCustomInput(elements.addReason, elements.customAddReasonGroup, 'earn');
                            autoSetPointsAmount(reason, 'earn');
                        } else {
                            // 选择"其他"时隐藏自定义输入框
                            toggleCustomInput(elements.addReason, elements.customAddReasonGroup, 'earn');
                        }
                    });
                }
                
                // 消费原因变化时自动设置积分数量
                if (elements.subtractReason) {
                    elements.subtractReason.addEventListener('change', (e) => {
                        const reason = e.target.value;
                        if (reason === '__CUSTOM_INPUT__') {
                            // 显示自定义输入框
                            toggleCustomInput(elements.subtractReason, elements.customSubtractReasonGroup, 'spend');
                        } else if (reason && reason !== '其他') {
                            // 隐藏自定义输入框并自动设置积分数量
                            toggleCustomInput(elements.subtractReason, elements.customSubtractReasonGroup, 'spend');
                            autoSetPointsAmount(reason, 'spend');
                        } else {
                            // 选择"其他"时隐藏自定义输入框
                            toggleCustomInput(elements.subtractReason, elements.customSubtractReasonGroup, 'spend');
                        }
                    });
                }
                
                // Enter键快捷操作
                if (elements.addAmount) {
                    elements.addAmount.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') addPoints();
                    });
                }
                
                if (elements.subtractAmount) {
                    elements.subtractAmount.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') subtractPoints();
                    });
                }
                
                // 自定义输入框的Enter键快捷操作
                if (elements.customAddReason) {
                    elements.customAddReason.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            // 自动聚焦到积分数量输入框
                            elements.addAmount.focus();
                        }
                    });
                }
                
                if (elements.customSubtractReason) {
                    elements.customSubtractReason.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            // 自动聚焦到积分数量输入框
                            elements.subtractAmount.focus();
                        }
                    });
                }

                // 点击外部关闭下拉菜单
                document.addEventListener('click', (e) => {
                    const themeSelector = document.querySelector('.theme-selector');
                    const userSelector = document.querySelector('.user-selector');
                    const themeDropdown = elements.themeDropdown;
                    const userDropdown = elements.userDropdown;
                    
                    if (themeSelector && themeDropdown && !themeSelector.contains(e.target)) {
                        themeDropdown.classList.remove('show');
                    }
                    
                    if (userSelector && userDropdown && !userSelector.contains(e.target)) {
                        userDropdown.classList.remove('show');
                    }
                });

                // 点击选择器时阻止事件冒泡
                if (document.querySelector('.theme-selector')) {
                    document.querySelector('.theme-selector').addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                }
                
                if (document.querySelector('.user-selector')) {
                    document.querySelector('.user-selector').addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                }

                // 点击外部关闭家长控制面板
                if (elements.adminPanel) {
                    elements.adminPanel.addEventListener('click', (e) => {
                        if (e.target === elements.adminPanel) {
                            closeAdminPanel();
                        }
                    });
                }
                
                // 添加键盘事件优化
                addKeyboardOptimizations();
                
                console.log('事件绑定完成');
            } catch (error) {
                console.error('事件绑定失败:', error);
            }
        }
        
        // 键盘事件优化
        function addKeyboardOptimizations() {
            // ESC键关闭下拉菜单
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (elements.themeDropdown && elements.themeDropdown.classList.contains('show')) {
                        elements.themeDropdown.classList.remove('show');
                    }
                    if (elements.userDropdown && elements.userDropdown.classList.contains('show')) {
                        elements.userDropdown.classList.remove('show');
                    }
                    if (elements.adminPanel && elements.adminPanel.classList.contains('show')) {
                        closeAdminPanel();
                    }
                    if (elements.userManagementPanel && elements.userManagementPanel.classList.contains('show')) {
                        closeUserManagementPanel();
                    }
                }
            });
            
            // 方向键在主题选项中导航
            const themeOptions = document.querySelectorAll('.theme-option');
            themeOptions.forEach((option, index) => {
                option.addEventListener('keydown', function(e) {
                    let targetIndex = index;
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        targetIndex = (index + 1) % themeOptions.length;
                        themeOptions[targetIndex].focus();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        targetIndex = (index - 1 + themeOptions.length) % themeOptions.length;
                        themeOptions[targetIndex].focus();
                    } else if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });
        }

        // 生成文本格式备份数据
        function generateTextBackup() {
            const now = new Date();
            const exportTime = now.toLocaleString('zh-CN');
            
            let textData = '';
            
            // 文件头部信息
            textData += `=== 积分系统数据备份 ===\n`;
            textData += `导出时间: ${exportTime}\n`;
            textData += `用户姓名: ${pointsData.settings.childName}\n`;
            textData += `积分单位: ${pointsData.settings.currency}\n\n`;
            
            // 当前积分状况
            textData += `=== 当前积分状况 ===\n`;
            textData += `当前积分: ${pointsData.currentPoints}\n`;
            textData += `累计获得: ${pointsData.totalEarned}\n`;
            textData += `累计消费: ${pointsData.totalSpent}\n`;
            if (pointsData.lastUpdated) {
                const lastUpdate = new Date(pointsData.lastUpdated).toLocaleString('zh-CN');
                textData += `最后更新: ${lastUpdate}\n`;
            }
            textData += `\n`;
            
            // 积分历史记录
            textData += `=== 积分历史记录 ===\n`;
            if (pointsData.history.length === 0) {
                textData += `暂无历史记录\n`;
            } else {
                // 显示最近20条记录
                const recentHistory = pointsData.history.slice(0, 20);
                recentHistory.forEach(record => {
                    const date = new Date(record.timestamp).toLocaleString('zh-CN');
                    const type = record.type === 'earned' ? '获得' : '消费';
                    const prefix = record.type === 'earned' ? '+' : '-';
                    const icon = record.type === 'earned' ? '🎉' : '💸';
                    textData += `[${type}] ${prefix}${record.amount} ${record.reason} ${date} ${icon}\n`;
                });
                if (pointsData.history.length > 20) {
                    textData += `... 还有 ${pointsData.history.length - 20} 条记录\n`;
                }
            }
            textData += `\n`;
            
            // 成就系统
            textData += `=== 成就系统 ===\n`;
            const earnedAchievements = achievements.filter(achievement => pointsData.achievements[achievement.id]);
            const unearnedAchievements = achievements.filter(achievement => !pointsData.achievements[achievement.id]);
            
            if (earnedAchievements.length > 0) {
                textData += `✅ 已解锁成就 (${earnedAchievements.length}/${achievements.length}):\n`;
                earnedAchievements.forEach(achievement => {
                    textData += `  ✅ ${achievement.title} - ${achievement.desc}\n`;
                });
            }
            
            if (unearnedAchievements.length > 0) {
                textData += `\n❌ 未解锁成就:\n`;
                unearnedAchievements.slice(0, 10).forEach(achievement => {
                    textData += `  ❌ ${achievement.title} - ${achievement.desc}\n`;
                });
                if (unearnedAchievements.length > 10) {
                    textData += `  ... 还有 ${unearnedAchievements.length - 10} 个成就\n`;
                }
            }
            textData += `\n`;
            
            // 系统设置
            textData += `=== 系统设置 ===\n`;
            textData += `主题: ${getThemeName(pointsData.settings.theme)}\n`;
            textData += `积分单位: ${pointsData.settings.currency}\n`;
            textData += `密码保护: ${pointsData.settings.passwordEnabled ? '已启用' : '未启用'}\n`;
            textData += `通知: ${pointsData.settings.notifications ? '开启' : '关闭'}\n`;
            textData += `\n`;
            
            // 统计数据
            const activeDays = new Set(pointsData.history.map(r => new Date(r.timestamp).toDateString())).size;
            const avgEarned = pointsData.totalEarned > 0 ? Math.round(pointsData.totalEarned / Math.max(activeDays, 1)) : 0;
            const avgSpent = pointsData.totalSpent > 0 ? Math.round(pointsData.totalSpent / Math.max(activeDays, 1)) : 0;
            
            textData += `=== 使用统计 ===\n`;
            textData += `活跃天数: ${activeDays} 天\n`;
            textData += `平均每日获得: ${avgEarned} ${pointsData.settings.currency}\n`;
            textData += `平均每日消费: ${avgSpent} ${pointsData.settings.currency}\n`;
            textData += `记录总数: ${pointsData.history.length} 条\n`;
            textData += `\n`;
            
            // 数据校验信息
            textData += `=== 数据校验 ===\n`;
            const dataHash = generateSimpleHash(JSON.stringify(pointsData));
            textData += `校验码: ${dataHash}\n`;
            textData += `版本: 2.0 (文本格式)\n`;
            textData += `系统: 终极积分系统\n`;
            
            return textData;
        }
        
        // 生成简单的数据校验码
        function generateSimpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // 转换为32位整数
            }
            return Math.abs(hash).toString(16).toUpperCase().substring(0, 8);
        }
        
        // 下载文本文件
        function downloadTextFile(textBlob, fileName) {
            const url = URL.createObjectURL(textBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // 显示文本内容供复制
        function showTextForCopy(textData) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--theme-bg); padding: 30px; border-radius: var(--border-radius);
                    max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;
                    text-align: center; box-shadow: var(--card-shadow);
                ">
                    <h3 style="margin-bottom: 20px; color: var(--theme-text);">📋 文本备份内容</h3>
                    <div style="
                        background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px;
                        padding: 20px; margin-bottom: 20px; text-align: left;
                        font-family: 'Courier New', monospace; font-size: 14px;
                        white-space: pre-wrap; word-wrap: break-word;
                        max-height: 400px; overflow-y: auto;
                    ">${textData}</div>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="copyTextToClipboard()" style="
                            padding: 15px 25px; border: none; border-radius: 12px;
                            background: var(--success-gradient); color: white; font-weight: 600;
                            cursor: pointer;
                        ">📋 复制文本</button>
                        <button onclick="closeTextModal()" style="
                            padding: 15px 25px; border: none; border-radius: 12px;
                            background: #6c757d; color: white; font-weight: 600;
                            cursor: pointer;
                        ">关闭</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 绑定全局函数
            window.copyTextToClipboard = async () => {
                try {
                    await navigator.clipboard.writeText(textData);
                    showToast('文本已复制到剪贴板！📋');
                } catch (err) {
                    // 如果现代API失败，使用传统方法
                    const textArea = document.createElement('textarea');
                    textArea.value = textData;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('文本已复制到剪贴板！📋');
                }
            };
            
            window.closeTextModal = () => {
                document.body.removeChild(modal);
                delete window.copyTextToClipboard;
                delete window.closeTextModal;
            };
        }
        
        // 生成Base64编码版本
        function generateBase64Version(textData) {
            try {
                return btoa(encodeURIComponent(textData));
            } catch (error) {
                console.error('Base64编码失败:', error);
                return null;
            }
        }
        
        // 显示Base64选项
        function showBase64Option(encodedData) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--theme-bg); padding: 30px; border-radius: var(--border-radius);
                    max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;
                    text-align: center; box-shadow: var(--card-shadow);
                ">
                    <h3 style="margin-bottom: 20px; color: var(--theme-text);">🔒 Base64编码版本</h3>
                    <p style="margin-bottom: 15px; color: #6c757d;">这是压缩后的编码版本，可以复制到任何地方保存</p>
                    <div style="
                        background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px;
                        padding: 20px; margin-bottom: 20px; text-align: left;
                        font-family: 'Courier New', monospace; font-size: 12px;
                        word-wrap: break-word; max-height: 300px; overflow-y: auto;
                    ">${encodedData}</div>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="copyBase64ToClipboard()" style="
                            padding: 15px 25px; border: none; border-radius: 12px;
                            background: var(--info-gradient); color: white; font-weight: 600;
                            cursor: pointer;
                        ">📋 复制编码</button>
                        <button onclick="closeBase64Modal()" style="
                            padding: 15px 25px; border: none; border-radius: 12px;
                            background: #6c757d; color: white; font-weight: 600;
                            cursor: pointer;
                        ">关闭</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.copyBase64ToClipboard = async () => {
                try {
                    await navigator.clipboard.writeText(encodedData);
                    showToast('Base64编码已复制！🔒');
                } catch (err) {
                    const textArea = document.createElement('textarea');
                    textArea.value = encodedData;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('Base64编码已复制！🔒');
                }
            };
            
            window.closeBase64Modal = () => {
                document.body.removeChild(modal);
                delete window.copyBase64ToClipboard;
                delete window.closeBase64Modal;
            };
        }
        
        // 增强的导出数据功能
        function exportData() {
            // 显示导出选项菜单
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--theme-bg); padding: 30px; border-radius: var(--border-radius);
                    max-width: 500px; width: 90%; text-align: center; box-shadow: var(--card-shadow);
                ">
                    <h3 style="margin-bottom: 25px; color: var(--theme-text);">📥 数据导出选项</h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <button onclick="exportAsTextFile()" style="
                            padding: 18px; border: none; border-radius: 12px;
                            background: var(--success-gradient); color: white; font-weight: 600;
                            cursor: pointer; font-size: 16px;
                        ">📄 导出为文本文件 (.txt)</button>
                        <button onclick="exportAsTextAndShow()" style="
                            padding: 18px; border: none; border-radius: 12px;
                            background: var(--primary-gradient); color: white; font-weight: 600;
                            cursor: pointer; font-size: 16px;
                        ">📋 显示文本供复制</button>
                        <button onclick="exportAsJSON()" style="
                            padding: 18px; border: none; border-radius: 12px;
                            background: var(--warning-gradient); color: white; font-weight: 600;
                            cursor: pointer; font-size: 16px;
                        ">💾 导出为JSON文件</button>
                        <button onclick="exportWithBase64()" style="
                            padding: 18px; border: none; border-radius: 12px;
                            background: var(--info-gradient); color: white; font-weight: 600;
                            cursor: pointer; font-size: 16px;
                        ">🔒 生成Base64编码</button>
                        <button onclick="closeExportModal()" style="
                            padding: 15px; border: 2px solid #dee2e6; border-radius: 12px;
                            background: white; color: #6c757d; font-weight: 600;
                            cursor: pointer; font-size: 14px;
                        ">取消</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 绑定导出函数
            window.exportAsTextFile = () => {
                const textData = generateTextBackup();
                const textBlob = new Blob([textData], { type: 'text/plain;charset=utf-8' });
                const fileName = `积分数据_${new Date().toISOString().split('T')[0]}.txt`;
                downloadTextFile(textBlob, fileName);
                closeExportModal();
                showToast('文本文件导出成功！📄');
            };
            
            window.exportAsTextAndShow = () => {
                const textData = generateTextBackup();
                closeExportModal();
                showTextForCopy(textData);
            };
            
            window.exportAsJSON = () => {
                const dataStr = JSON.stringify(pointsData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `积分系统数据_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                closeExportModal();
                showToast('JSON文件导出成功！📥');
            };
            
            window.exportWithBase64 = () => {
                const textData = generateTextBackup();
                const encodedData = generateBase64Version(textData);
                if (encodedData) {
                    closeExportModal();
                    showBase64Option(encodedData);
                } else {
                    showToast('Base64编码生成失败', 'error');
                }
            };
            
            window.closeExportModal = () => {
                document.body.removeChild(modal);
                // 清理全局函数
                ['exportAsTextFile', 'exportAsTextAndShow', 'exportAsJSON', 'exportWithBase64', 'closeExportModal']
                    .forEach(func => delete window[func]);
            };
        }

        // 导入数据
        function importData() {
            const fileInput = document.getElementById('importFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                return;
            }
            
            // 检查文件类型
            const isJsonFile = file.type.includes('json') || file.name.endsWith('.json');
            const isTextFile = file.type.includes('text') || file.name.endsWith('.txt');
            
            if (!isJsonFile && !isTextFile) {
                showToast('请选择JSON或TXT格式的数据文件', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let importedData;
                    
                    if (isTextFile) {
                        // 解析文本格式
                        importedData = parseTextBackupData(e.target.result);
                    } else {
                        // 解析JSON格式
                        importedData = JSON.parse(e.target.result);
                    }
                    
                    // 验证数据格式
                    if (!isValidPointsData(importedData)) {
                        showToast('数据格式不正确，请检查文件内容', 'error');
                        return;
                    }
                    
                    // 确认导入操作
                    if (confirm('导入数据将会覆盖当前所有数据，确定要继续吗？')) {
                        // 备份当前数据
                        const backupData = { ...pointsData };
                        
                        try {
                            // 导入数据
                            pointsData = importedData;
                            
                            // 更新界面
                            applyTheme();
                            updateDisplay();
                            renderAchievements();
                            saveData();
                            checkAchievements();
                            
                            showToast('数据导入成功！🎉');
                        } catch (importError) {
                            // 恢复备份数据
                            pointsData = backupData;
                            showToast('导入失败：' + importError.message, 'error');
                        }
                    }
                } catch (parseError) {
                    if (isTextFile) {
                        showToast('文本格式错误：无法解析数据，请检查格式是否正确', 'error');
                    } else {
                        showToast('文件格式错误：无法解析JSON数据', 'error');
                    }
                }
            };
            
            reader.onerror = function() {
                showToast('文件读取失败', 'error');
            };
            
            reader.readAsText(file, 'UTF-8');
            
            // 清空文件输入，允许重复导入同一文件
            fileInput.value = '';
        }
        
        // 验证导入数据的格式
        function isValidPointsData(data) {
            if (!data || typeof data !== 'object') {
                return false;
            }
            
            // 检查必要字段
            const requiredFields = ['currentPoints', 'totalEarned', 'totalSpent', 'history', 'settings', 'achievements'];
            
            for (let field of requiredFields) {
                if (!(field in data)) {
                    console.warn(`缺少必要字段: ${field}`);
                    return false;
                }
            }
            
            // 检查数据类型
            if (typeof data.currentPoints !== 'number' || 
                typeof data.totalEarned !== 'number' || 
                typeof data.totalSpent !== 'number' ||
                !Array.isArray(data.history) ||
                typeof data.settings !== 'object' ||
                typeof data.achievements !== 'object') {
                return false;
            }
            
            return true;
        }
        
        // 解析文本格式备份数据
        function parseTextBackupData(textData) {
            const lines = textData.split('\n');
            const data = {
                currentPoints: 0,
                totalEarned: 0,
                totalSpent: 0,
                lastUpdated: null,
                history: [],
                settings: {
                    childName: '小朋友',
                    currency: '积分',
                    notifications: true,
                    theme: 'default',
                    password: '',
                    passwordEnabled: false
                },
                achievements: {
                    firstEarn: false,
                    points50: false,
                    points100: false,
                    points500: false,
                    firstSpend: false,
                    dailyActive: false,
                    consistency3: false
                }
            };
            
            let parsingHistory = false;
            let parsingAchievements = false;
            
            for (let line of lines) {
                line = line.trim();
                
                if (line === '') continue;
                
                // 解析当前积分状况
                if (line.startsWith('当前积分:')) {
                    const match = line.match(/当前积分:\s*(\d+)/);
                    if (match) data.currentPoints = parseInt(match[1]);
                }
                else if (line.startsWith('累计获得:')) {
                    const match = line.match(/累计获得:\s*(\d+)/);
                    if (match) data.totalEarned = parseInt(match[1]);
                }
                else if (line.startsWith('累计消费:')) {
                    const match = line.match(/累计消费:\s*(\d+)/);
                    if (match) data.totalSpent = parseInt(match[1]);
                }
                else if (line.startsWith('最后更新:')) {
                    const timestamp = line.replace('最后更新:', '').trim();
                    if (timestamp) {
                        data.lastUpdated = new Date(timestamp).toISOString();
                    }
                }
                
                // 解析用户信息
                else if (line.startsWith('用户姓名:')) {
                    const name = line.replace('用户姓名:', '').trim();
                    if (name) data.settings.childName = name;
                }
                else if (line.startsWith('积分单位:')) {
                    const currency = line.replace('积分单位:', '').trim();
                    if (currency) data.settings.currency = currency;
                }
                
                // 解析主题
                else if (line.startsWith('主题:')) {
                    const themeLine = line.replace('主题:', '').trim();
                    const themeMap = {
                        '默认': 'default',
                        '彩虹': 'rainbow', 
                        '森林': 'forest',
                        '日落': 'sunset',
                        '海洋': 'ocean',
                        '圣诞': 'christmas',
                        '新年': 'newyear'
                    };
                    data.settings.theme = themeMap[themeLine] || 'default';
                }
                
                // 开始解析历史记录
                else if (line === '=== 积分历史记录 ===') {
                    parsingHistory = true;
                    parsingAchievements = false;
                    continue;
                }
                
                // 开始解析成就
                else if (line === '=== 成就系统 ===') {
                    parsingHistory = false;
                    parsingAchievements = true;
                    continue;
                }
                
                // 解析历史记录
                else if (parsingHistory && line.includes('[') && line.includes(']')) {
                    try {
                        // 匹配格式: [获得] +10 完成作业 2023/12/1 10:30:00 🎉
                        const match = line.match(/\[(获得|消费)\]\s*([+-]?)(\d+)\s+(.+?)\s+(.+?)\s+[🎉💸]/);
                        if (match) {
                            const type = match[1] === '获得' ? 'earned' : 'spent';
                            const amount = parseInt(match[3]);
                            const reason = match[4];
                            const timestamp = match[5];
                            
                            data.history.push({
                                id: Date.now() + Math.random(),
                                type: type,
                                amount: amount,
                                reason: reason,
                                timestamp: new Date(timestamp).toISOString()
                            });
                        }
                    } catch (e) {
                        console.warn('解析历史记录失败:', line);
                    }
                }
                
                // 解析成就
                else if (parsingAchievements && line.includes('✅')) {
                    try {
                        // 匹配格式: ✅ 初次获得 - 获得第一个积分
                        const match = line.match(/✅\s+(.+?)\s*-\s*(.+)/);
                        if (match) {
                            const title = match[1].trim();
                            
                            // 根据标题匹配成就ID
                            const achievementMap = {
                                '初次获得': 'firstEarn',
                                '首次消费': 'firstSpend',
                                '百积分达成': 'points100',
                                '小有成就': 'points50',
                                '积分达人': 'points250',
                                '积分大户': 'points500',
                                '积分王者': 'points1000',
                                '坚持不懈': 'consistency3',
                                '一周坚持': 'consistency7',
                                '两周坚持': 'consistency14',
                                '月度坚持王': 'consistency30'
                            };
                            
                            const achievementId = achievementMap[title];
                            if (achievementId) {
                                data.achievements[achievementId] = true;
                            }
                        }
                    } catch (e) {
                        console.warn('解析成就失败:', line);
                    }
                }
            }
            
            return data;
        }
        
        // 显示文本导入对话框
        function showTextImportDialog() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--theme-bg); padding: 30px; border-radius: var(--border-radius);
                    max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;
                    text-align: center; box-shadow: var(--card-shadow);
                ">
                    <h3 style="margin-bottom: 20px; color: var(--theme-text);">📋 文本数据导入</h3>
                    <p style="margin-bottom: 20px; color: #6c757d;">请粘贴您备份的文本数据到下方文本框中：</p>
                    <textarea id="textImportInput" placeholder="请粘贴备份的文本数据..." style="
                        width: 100%; height: 300px; padding: 15px; border: 2px solid #dee2e6;
                        border-radius: 12px; font-size: 14px; font-family: 'Courier New', monospace;
                        resize: vertical; box-sizing: border-box;
                    "></textarea>
                    <div style="margin-top: 20px; color: #6c757d; font-size: 13px; text-align: left;">
                        <strong>支持格式：</strong><br>
                        • 文本格式备份文件 (.txt)<br>
                        • Base64编码的文本数据<br>
                        • 手动复制的文本内容
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
                        <button onclick="processTextImport()" style="
                            padding: 15px 25px; border: none; border-radius: 12px;
                            background: var(--success-gradient); color: white; font-weight: 600;
                            cursor: pointer;
                        ">📥 导入数据</button>
                        <button onclick="closeTextImportDialog()" style="
                            padding: 15px 25px; border: 2px solid #dee2e6; border-radius: 12px;
                            background: white; color: #6c757d; font-weight: 600;
                            cursor: pointer;
                        ">取消</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 绑定全局函数
            window.processTextImport = () => {
                const textInput = document.getElementById('textImportInput');
                const textData = textInput.value.trim();
                
                if (!textData) {
                    showToast('请输入要导入的文本数据', 'error');
                    return;
                }
                
                try {
                    let parsedData;
                    
                    // 尝试解码Base64
                    try {
                        const decoded = decodeURIComponent(atob(textData));
                        if (decoded.includes('=== 积分系统数据备份 ===')) {
                            parsedData = parseTextBackupData(decoded);
                        } else {
                            parsedData = JSON.parse(decoded);
                        }
                    } catch (base64Error) {
                        // 如果不是Base64，尝试直接解析
                        if (textData.includes('=== 积分系统数据备份 ===')) {
                            parsedData = parseTextBackupData(textData);
                        } else {
                            parsedData = JSON.parse(textData);
                        }
                    }
                    
                    // 验证数据格式
                    if (!isValidPointsData(parsedData)) {
                        showToast('数据格式不正确，请检查文本内容', 'error');
                        return;
                    }
                    
                    // 确认导入操作
                    if (confirm('导入数据将会覆盖当前所有数据，确定要继续吗？')) {
                        // 备份当前数据
                        const backupData = { ...pointsData };
                        
                        try {
                            // 导入数据
                            pointsData = parsedData;
                            
                            // 更新界面
                            applyTheme();
                            updateDisplay();
                            renderAchievements();
                            saveData();
                            checkAchievements();
                            
                            closeTextImportDialog();
                            showToast('文本数据导入成功！🎉');
                        } catch (importError) {
                            // 恢复备份数据
                            pointsData = backupData;
                            showToast('导入失败：' + importError.message, 'error');
                        }
                    }
                } catch (parseError) {
                    showToast('文本解析失败：请检查数据格式是否正确', 'error');
                }
            };
            
            window.closeTextImportDialog = () => {
                document.body.removeChild(modal);
                delete window.processTextImport;
                delete window.closeTextImportDialog;
            };
            
            // 聚焦到文本框
            setTimeout(() => {
                document.getElementById('textImportInput').focus();
            }, 100);
        }

        // 初始化系统
        console.log('终极积分系统脚本加载完成，准备初始化...');
        
        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // 备用初始化
        window.addEventListener('load', () => {
            if (!window.ultimatePointsSystemInitialized) {
                console.log('执行备用初始化');
                init();
            }
        });
        
        // 标记初始化完成
        window.ultimatePointsSystemInitialized = true;
        
        console.log('终极积分系统脚本执行完成');
    </script>
</body>
</html>