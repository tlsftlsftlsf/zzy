# 503 Service Unavailable 错误解决方案

## 🚨 问题诊断

您遇到的 `503 Service Unavailable` 错误表明服务器服务没有正常运行。

## ⚡ 立即修复步骤

### 步骤1: 检查服务状态
```bash
points-sync status
```

**预期结果**: 应该显示 `active (running)`
**异常情况**: 如果显示 `inactive (dead)` 或 `failed`，继续下一步

### 步骤2: 检查服务日志
```bash
points-sync logs
```

**查看最后20行日志**:
```bash
points-sync logs | tail -20
```

**查找错误信息** - 常见的错误包括：
- `Address already in use` (端口被占用)
- `Permission denied` (权限错误)
- `No module named 'flask'` (依赖缺失)
- `SyntaxError` (代码语法错误)

### 步骤3: 重新启动服务
```bash
# 完全停止服务
points-sync stop

# 等待5秒
sleep 5

# 重新启动
points-sync start

# 再次检查状态
points-sync status
```

### 步骤4: 手动测试Python服务
```bash
# 进入应用目录
cd /var/www/points-sync

# 激活虚拟环境
source venv/bin/activate

# 手动运行服务测试
python cloud_server.py
```

**如果出现错误**：
- 记录完整的错误信息
- 检查Python语法
- 确认依赖安装正确

### 步骤5: 检查端口监听
```bash
# 检查5000端口是否被监听
netstat -tlnp | grep 5000

# 或者使用ss命令
ss -tlnp | grep 5000
```

**预期结果**: 应该看到类似
```
LISTEN 0 128 0.0.0.0:5000 0.0.0.0:* users:(("python",pid=1234,fd=3))
```

### 步骤6: 重新安装依赖
```bash
# 重新安装Python依赖
cd /var/www/points-sync
source venv/bin/activate
pip install --upgrade flask flask-cors
```

### 步骤7: 检查系统资源
```bash
# 检查磁盘空间
df -h

# 检查内存使用
free -h

# 检查CPU负载
top -n 1
```

## 🔧 常见503错误原因及解决方案

### 原因1: 端口被占用
```bash
# 查找占用5000端口的进程
sudo lsof -i :5000

# 终止占用进程
sudo kill -9 [PID]

# 重启服务
points-sync restart
```

### 原因2: 依赖缺失
```bash
# 安装缺失的依赖
cd /var/www/points-sync
source venv/bin/activate
pip install flask flask-cors

# 重启服务
points-sync restart
```

### 原因3: 权限问题
```bash
# 修复权限
sudo chown -R root:root /var/www/points-sync
sudo chmod -R 755 /var/www/points-sync
sudo chmod +x /var/www/points-sync/cloud_server.py

# 重启服务
points-sync restart
```

### 原因4: 服务配置错误
```bash
# 检查systemd服务配置
sudo systemctl cat points-sync

# 重新加载systemd配置
sudo systemctl daemon-reload

# 重启服务
points-sync restart
```

## 🛠️ 完整重置流程

如果以上步骤都无效，执行完整重置：

```bash
# 1. 停止并禁用服务
points-sync stop
sudo systemctl disable points-sync

# 2. 删除旧服务文件
sudo rm -f /etc/systemd/system/points-sync.service

# 3. 重新运行部署脚本
cd /tmp
sudo ./deploy_cloud_server.sh

# 4. 启动服务
points-sync start

# 5. 验证
points-sync status
curl -I http://localhost:5000
```

## 📊 验证成功

成功修复的标志：
- `points-sync status` 显示 `active (running)`
- `curl -I http://localhost:5000` 返回 `HTTP/1.0 200 OK`
- 浏览器访问 `http://47.122.118.180:5000` 显示积分系统界面

## 🆘 紧急恢复

如果服务完全无法启动，使用备用方案：

```bash
# 直接运行Python服务（不使用systemd）
cd /var/www/points-sync
source venv/bin/activate
nohup python cloud_server.py > /var/log/points-sync/manual.log 2>&1 &

# 检查是否运行
ps aux | grep cloud_server.py
```

完成这些步骤后，503错误应该会解决！